---
title: "publication"
author: "WX"
date: "2024-03-02"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#1. Loaded packages & customized functions
```{r package loading, message=FALSE, warning=FALSE}
#Data manipulation
library(pmsampsize) #Sample size estimation for predictive model development
library(tidyverse) #for data manipulation
library(dplyr) #for data manipulation
library(purrr)
library(mice) #for multiple imputation
library(miceadds) #detailed MI analysis & display
library(VIM) #identify patterns of missing values
library(reshape2) #converson between long and wide data formats
library(fastDummies)#transform factor into dummy variables
#Data visualization
library(ggplot2) #for data visualization
library(ggforce)#adds geom_circle
#Modeling
library(stats) #perform ANOVA, chi-squared tests
library(gridExtra)#combine multiple figures into a single figure
library(ROCR) #a bit more sophiticated than pROC for ROC & AUC
library(pROC) #for ROC & AUC
library(glmnet) #regularization
library(sjPlot) #calculate standardized coefficients
library(moments) #calculates skewness
library(datawizard) #standardize coefficients
library(caret) #build the elasticnet regression model
library(rmda) #DCA computation & DCA plot
library(dcurves)#offers dca() to make customised DCA
library(rms) #compute calibration slope
library(CalibrationCurves) #computing calibration slope and calibration in the large
library(metafor)#meta-analysis for internal-external analysis
library(mgcv)#compute GAM model
library(BB)#compute cut points for categorization of continuous variables
library(survey) #handle the weighted data to compute performance metrics of the CROSS score
library(xgboost)#XGBoost modeling
library(e1071)# SVM prediction
library(Boruta)#Feature selection
library(neuralnet)#Neural networks
library(randomForest)#Random forest
library(rpart)#Decision tree
library(kernlab)#Needed for svmradial in train() from the caret package
library(VennDiagram)#create Venn diagram
```

```{r customized function: theme_wx for all figures}
#Customized theme for all figures
theme_wx <-  theme_minimal() +
    theme(axis.line = element_line(colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank(),
  axis.text = element_text(size = 12),
  axis.title = element_text(size = 14),
  legend.text = element_text(size = 10),
  legend.title = element_text(size = 12)) +
  theme(axis.line = element_line(color = "grey")
        )
```

```{r customized function: set outliers to NA}
#Lower and upper bounds set as needed
replace_outlier <- function(x, lower, upper) {
  x[x < lower | x > upper] <- NA
  return(x)
}
```

```{r customized function: winsorization}
# Function to perform winsorization on a vector
winso <- function(x, xmin = quantile(x, probs = 0.01), xmax = quantile(x, probs = 0.99)) {
  # Error checking: ensure that the input is in the correct format
  if (!is.numeric(x)) {
    stop("Input must be numeric") 
  }
  # Winsorize the data
  x[x > xmax] <- xmax
  x[x < xmin] <- xmin
  return(x)
}

# Function to perform winsorization on specified columns of a data frame
winso_df <- function(data, cols) {
  # Error checking: ensure that the input data is a data frame
  if (!is.data.frame(data)) {
    stop("Input data must be a data frame")
  }
  # Loop through each specified column for winsorization
  for (col in cols) {
    # Error checking: ensure that the specified column is numeric
    if (!is.numeric(data[[col]])) {
      stop(paste(col, "must be numeric"))
    }
    # Winsorize the column
    data[[col]] <- winso(data[[col]])
  }
  return(data)
}
```

```{r customized function: convert characters to vectors}
# Function to convert character variables to factors
convert_to_factor <- function(data, variables) {
  for (var in variables) {
    data[[var]] <- as.factor(data[[var]])
  }
  return(data)
}
```

```{r customized function: calibration analysis}
perform_calibration_analysis <- function(pred_risk, true_outcome) {
  # Create a data frame for calibration plot
  df_calib_plot <- data.frame(pred_risk = pred_risk, true_outcome = true_outcome)
  df_calib_plot$lp <- log(pred_risk / (1 - pred_risk))

  # Fit logistic regression model for calibration slope
  model_fit <- glm(true_outcome ~ lp, family = binomial, data = df_calib_plot)
  cali_slope <- coef(model_fit)[2] # Extract the calibration slope
  cali_slope_ci <- confint(model_fit)[2,] # Confidence interval for the calibration slope

  # Compute and extract the calibration intercept
  mod_calib <- glm(true_outcome ~ 1, family = binomial, data = df_calib_plot,
                   offset = log(pred_risk / (1 - pred_risk)))
  cali_intercept <- coef(mod_calib)[1]

  # Compute the standard error of the calibration intercept manually
  pred_risk_values <- df_calib_plot$pred_risk
  n <- length(pred_risk_values)
  lp_values <- log(pred_risk_values / (1 - pred_risk_values))
  log_likelihood <- sum(df_calib_plot$true_outcome * lp_values + (1 - df_calib_plot$true_outcome) * log(1 - exp(lp_values)))
  vcov_matrix <- vcov(mod_calib)
  cali_intercept_se <- sqrt(vcov_matrix[1, 1] / n)

  # Calculate the confidence interval for the calibration intercept
  alpha <- 0.05
  cali_intercept_ci <- c(cali_intercept - qnorm(1 - alpha / 2) * cali_intercept_se,
                         cali_intercept + qnorm(1 - alpha / 2) * cali_intercept_se)

  # Compile the results into a list
  cali_result <- list(slope = cali_slope, ci_slope = cali_slope_ci,
                      intercept = cali_intercept, ci_intercept = cali_intercept_ci)
  return(cali_result)
}

```

#2. Create the derivation (der_dat) & validation (val_dat) cohorts
```{r import hap files, warning=FALSE}
# Define the file names in a vector
file_names <- c(
  '_demo.csv',
  '_blut.csv',
  '_blut_his.csv',
  '_cc2_his.csv',
  '_cc02.csv',
  '_cc1_his.csv',
  '_cc01.csv',
  '_vitalhis.csv',
  '_vitalparam.csv',
  '_visit_02.csv',
  '_risiko1.csv',
  '_risiko2.csv',
  'PatientCentres.csv'
)

# Create an empty list to store the data frames
hap_data <- list()

# Loop over the file names and read the CSV files
for (file_name in file_names) {
  file_path <- paste0("T:/Projects/NAPKON/projects/prognostic_score/prognositic_score/version2/haP/", file_name)
  df <- read.csv2(file_path)
  hap_data[[file_name]] <- df
}

# Access the individual data frames using names 
demo_hap <- hap_data[['_demo.csv']]
risiko1_hap <- hap_data[['_risiko1.csv']]
risiko2_hap <- hap_data[['_risiko2.csv']]
blut_hap <- hap_data[['_blut.csv']]
blut_his_hap <- hap_data[['_blut_his.csv']]
cc2_his_hap <- hap_data[['_cc2_his.csv']]
cc02_hap <- hap_data[["_cc02.csv"]]
cc1_his_hap <- hap_data[["_cc1_his.csv"]]
cc01_hap <- hap_data[["_cc01.csv"]]
vitalhis_hap <- hap_data[["_vitalhis.csv"]]
vitalparam_hap <- hap_data[["_vitalparam.csv"]]
vis02_hap <- hap_data[["_visit_02.csv"]]
ptcenter_hap <- hap_data[["PatientCentres.csv"]]
```

```{r create dat_demo_hap}
# Variable extraction and transformation
dat_demo_hap <- demo_hap %>% 
  select(
    psn = export_psn,
    age = demo_0010,  # Age upon enrollment by year
    sex = demo_0020,  # Sex from birth: 4 = Männlich, 5 = Weiblich, 6 = Divers
    bmi = demo_0050,
    d_t_adm_enrolled_hsptl = demo_0091  # Hospitals where patients enrolled: 0
  ) %>% 
  mutate(
    # Recode sex
    sex = ifelse(sex == 4, 'male', 'female'),
    # Convert to date
    d_adm_enrolled_hsptl = as.Date(substr(d_t_adm_enrolled_hsptl, 1, 8), format = "%Y%m%d"),
    # Create obesity variable
    obesity = ifelse(bmi >= 30, 'yes', 'no')
  ) %>% 
  select(-c(bmi, d_t_adm_enrolled_hsptl))  # Remove bmi and original date variable
```

```{r create dat_risiko1_hap}
dat_risiko1_hap <- risiko1_hap %>% 
  select(psn = export_psn,
         comor_cvd = risk_0050,#at least one cardiovascular disease, 0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_chronic_lung = risk_0080, #at least one chronic lung disease(including asthma), 0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_asthma = risk_0091, #diagnosed by clinicians, 0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_dm = risk_0140, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_ckd = risk_0250, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_chronic_liver = risk_0280, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_chronic_neuro = risk_0310, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_dementia = risk_0322, #0 = Nein, 1 = Ja, -1 = Unbekannt
         ) %>% 
  mutate(
    # Create variable of 'comor_chronic_lung_no_asthma'
    comor_chronic_lung_no_asthma = ifelse( 
  comor_chronic_lung == 1 & comor_asthma == 1, 0, comor_chronic_lung  
  )) %>% 
  select(-comor_asthma) %>% 
  mutate(
    across(where(is.numeric), ~na_if(., -1)) # Apply the lambda function to the selected columns
  )
```

```{r create dat_risiko2_hap}
dat_risiko2_hap <- risiko2_hap %>% 
  select(psn = export_psn,
         comor_tumor_or_cancer = risk_0360, #at leaset one tumor or cancer, 0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_hiv = risk_0430, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_aids = risk_0470, #0 = Nein, 1 = Ja, -1 = Unbekannt
         comor_rheuma_immuno = risk_0480 #0 = Nein, 1 = Ja, -1 = Unbekannt
         ) %>% 
  mutate(comor_hiv_aids = comor_hiv) %>% 
  select(-c(comor_hiv,
            comor_aids
  )) %>% 
  mutate(across(where(is.numeric), ~na_if(., -1)))
```

```{r create dat_vis02_hap, warning=FALSE}
#variable extract
dat_vis02_hap <- vis02_hap %>% 
  select(psn = export_psn,
    vis = mnpvislabel,
    icu = vs_0051,#0 = Nein, 1 = Ja; icu here include Intensiv- and Überwachungsstation. by WX 20230511
    d_vis = vs_0030,
    ward = vs_0054, #1 = Intensivstation, 2 = Intermediate Care / Überwachungsstation, 3 = Normalstation, -1 = Unbekannt
    d_icu = vs_0052 #dates do not include those admitted into IMC
  ) %>% 
  select(psn, vis, ward, everything()) 

#icu & ward cannot be used to estimate date of icu admission because both of them are dependent on d_vis, which is not on a daily basis. For instance, even if all "icu" gives 0 for all recorded dates, there is still a chance that this patient might be admitted into icu inbetween. There is no way this uncertainty could be tested with given data. Therefore, the only way to determine the date of icu is to explore the variable of 'd_icu'. Therefore, three steps for computing 'icu_7d': 1. those with 'd_icu' (201 pts): direct computation; 2. those without 'd_icu' but with 'icu'(15 pts): manually check; 3. those with missing 'icu': manually check(21 pts)

#create a data frame to put together d_hsptl, d_v1, and d_icu
dat_vis02_hap_icu <- dat_vis02_hap %>%    
  group_by(psn) %>% 
  summarise(d_icu = min(d_icu, na.rm = T))
 
dat_vis02_hap_icu$d_icu <- replace(dat_vis02_hap_icu$d_icu, is.infinite(dat_vis02_hap_icu$d_icu), NA)

dat_vis02_hap_v1 <- dat_vis02_hap %>% 
  filter(vis == 'Screening / V1')

dat_vis02_hap_final <- dat_vis02_hap_icu %>% 
  mutate(d_hsptl = dat_demo_hap$d_adm_enrolled_hsptl,
         d_v1 = dat_vis02_hap_v1$d_vis
         )

#compare dates between hospital admission and v1
dat_vis02_hap_final$d_v1 <- as.Date(as.character(dat_vis02_hap_final$d_v1), format = '%Y%m%d')
dat_vis02_hap_final$d_icu <- as.Date(as.character(dat_vis02_hap_final$d_icu), format = '%Y%m%d')

#table(dat_vis02_hap_final$d_v1 == dat_vis02_hap_final$d_hsptl)
#table(dat_vis02_hap_final$d_icu == dat_vis02_hap_final$d_hsptl)

#dat_vis02_hap_final$count <- dat_vis02_hap_final$d_icu - dat_vis02_hap_final$d_hsptl

#duration in days between v1 and hospital admission
dat_vis02_hap_final$duration_hsptl_v1 <- dat_vis02_hap_final$d_v1 - dat_vis02_hap_final$d_hsptl
#table(dat_vis02_hap_final$duration_hsptl_v1)

#duration in days between first icu admission and hospital admission
dat_vis02_hap_final$duration_hsptl_icu <- dat_vis02_hap_final$d_icu - dat_vis02_hap_final$d_hsptl
#table(dat_vis02_hap_final$duration_hsptl_icu)

#check those with negative values of duration_hsptl_icu:
dat_vis02_hap_neg_duration <- dat_vis02_hap_final %>% 
  filter(duration_hsptl_icu < 0) #14 patients yielded negative values for 'duration_hsptl_icu': export_0032, export_0104, export_0135, export_0136: <= 7d (based on common sense), export_0194: <= 7d, export_0244, export_0292, export_0312, export_0322: na, export_0368, export_0460: <= 7d, export_0488; <= 7d, export_0508, export_0519. 
 
dates_vis02_hap <- c('2021-01-11', '2021-02-21', '2021-04-30', '2021-01-12', '2021-02-19', '2020-12-18', '2020-12-19', '2021-03-28', '2021-01-21')
psn_values_vis02_hap <- c('export_0135', 'export_0032', 'export_0104', 'export_0244', 'export_0292', 'export_0312', 'export_0368', 'export_0508', 'export_0519')

dat_vis02_hap_final$d_icu[dat_vis02_hap_final$psn %in% psn_values_vis02_hap] <- as.Date(dates_vis02_hap)

#duration in days between first icu admission and hospital admission
dat_vis02_hap_final$duration_hsptl_icu <- dat_vis02_hap_final$d_icu - dat_vis02_hap_final$d_hsptl

#explore missingness in d_icu in dat_vis02_hap
dat_vis02_hap_d_icu <- dat_vis02_hap %>% 
  drop_na(d_icu) %>% 
  group_by(psn) %>% 
  summarise(n = n_distinct(d_icu))

table(dat_vis02_hap_d_icu$n)#up to 3 different dates were recorded for all 201 d_icu
n_distinct(dat_vis02_hap_d_icu$psn)#201 distinct pts have recordings for d_ICU

a1 <- dat_vis02_hap_d_icu$psn

dat_vis02_hap_1 <- dat_vis02_hap %>%
  filter(!psn %in% a1) %>% 
  group_by(psn) %>% 
  filter(!all(is.na(icu))) %>% 
  filter(!vis == 'Discharge') %>% 
  filter(icu == 1)

n_distinct(dat_vis02_hap_1$psn)#15 lacking d_icu although labelled as "1" for "icu". Together with 2 missing d_t_adm_enrolled_hsptl will be removed. 17/567 = 3% (export_0016: >7d;  export_0053: <7d; export_0068: <7d; export_0137: <7d; export_0245: <7d; export_0258: <7d; export_0294: na; export_0330: >7d; export_0377: <7d; export_0382: na; export_0383: <7d;export_0385: <7d; export_0400: <7d; export_0408: <7d; export_0489: <7d;). In conclusion, only "icu" and "d_icu" were used to estimate counts of icu admission ('icu' has a very limited missingness for v1-v7 which could be neglected). "d_vis" might not be the optimal variable for this purpose as it is not designed on a daily basis. In addition, "ward" has a large amount of missingness. Therefore, 2 out of 15 patients need to be removed: export_0294;export_0382. 

#add 6.5/7.5 as d_icu to those 13 pts missing d_icu but admitted into icu within/beyond 7d
dat_vis02_hap_final$duration_hsptl_icu <- as.numeric(dat_vis02_hap_final$duration_hsptl_icu)
dat_vis02_hap_final$duration_hsptl_icu <- replace(dat_vis02_hap_final$duration_hsptl_icu, c(53, 68, 137, 245, 258, 377, 383, 385, 400, 408, 489), c(6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5, 6.5))

dat_vis02_hap_final$duration_hsptl_v1 <- as.numeric(dat_vis02_hap_final$duration_hsptl_v1)

#add 6.5 as durtaion_hsptl_icu for those with negative values of duration_hsptl_icu
dat_vis02_hap_final$duration_hsptl_icu <- replace(dat_vis02_hap_final$duration_hsptl_icu, c(136, 194, 460, 488), c(6.5, 6.5, 6.5, 6.5))

#21 distinct pts missed 'icu': export_0002: na, export_0055: na, export_0169: na, export_0220: na, export_0391: na, export_0405: <= 7d, export_0547: na, export_0560: na, export_0079: na, export_0117: <= 7d, export_0228: <= 7d, export_0265: na, export_0390: na, export_0467: na, export_0129: na, export_0483: na, export_0552: na, export_0537: na, export_0249: <= 7d, export_0343: <= 7d, export_0355: na

#add 6.5 as durtaion_hsptl_icu for those with missing 'icu':
dat_vis02_hap_final$duration_hsptl_icu <- replace(dat_vis02_hap_final$duration_hsptl_icu, c(405, 117, 228, 249, 343), c(6.5, 6.5, 6.5, 6.5, 6.5))

dat_vis02_hap <- dat_vis02_hap_final#NA here include both never_icu and >7d_icu and missingness

#remove export_0028 & export_0271 due to their missingness on d_adm_enrolled_hsptl
dat_vis02_hap <- dat_vis02_hap %>%
  filter(!psn %in% c('export_0028', 'export_0271'))

#remove export_0322 due to its negative value on 'duration_hsptl_icu'
dat_vis02_hap <- dat_vis02_hap %>%
  filter(!psn == 'export_0322')

#remove due to missingness on 'icu'
dat_vis02_hap <- dat_vis02_hap %>%
  filter(!psn %in% c('export_0002', 'export_0055', 'export_0169', 'export_0220', 'export_0391', 'export_0547', 'export_0560', 'export_0079', 'export_0265', 'export_0390', 'export_0467', 'export_0129', 'export_0483', 'export_0552', 'export_0537', 'export_0355'))

#remove due to their missingness on d_icu
dat_vis02_hap <- dat_vis02_hap %>% 
  filter(!psn %in% c('export_0294', 'export_0382')) 

#create the variable of icu_7d
dat_vis02_hap <- dat_vis02_hap %>% 
  mutate(icu_7d = ifelse(
    duration_hsptl_icu <= 7, 'yes', 'no'
  ))

dat_vis02_hap$icu_7d <- replace(dat_vis02_hap$icu_7d, is.na(dat_vis02_hap$icu_7d), "no")

#table(dat_vis02_hap$icu_7d)
```

```{r create dat_blut_his_hap}
dat_blut_his_hap <- blut_his_hap %>% 
  select(
    psn = export_psn,
    vis = mnpvislabel,
    d_blood_his = lab_0012,
    wbc_abs_his = lab_0051, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    lympho_abs_his = lab_0061, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    neutro_abs_his = lab_0071, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    dimer_his = lab_0131, #unit: 1 = [mg/l] o. [µg/ml], 2 = [µg/l] o. [ng/ml]
    unit_dimer_his = lab_0132,
    platelet_abs_his = lab_0081 #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
  ) %>% 
  mutate(d_blood_his = as.Date(as.character(d_blood_his), format = "%Y%m%d")) %>%
  mutate(
    dimer_his = if_else(unit_dimer_his == 2, dimer_his / 1000, dimer_his),
    ) %>% 
  select(-unit_dimer_his)
```

```{r create dat_blut_hap}
#variable extract
dat_blut_hap <- blut_hap %>% 
  select(psn = export_psn,
         vis = mnpvislabel,
         wbc_abs_v1 = lab_0051, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
         lympho_abs_v1 = lab_0061, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
         neutro_abs_v1 = lab_0071, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
         dimer_v1 = lab_0131, #unit: 1 = [mg/l] o. [µg/ml], 2 = [µg/l] o. [ng/ml]. All d-dimer will be represented in this file as dimer to avoid confusion as "d_" has been reserved for indication of dates. 
         unit_dimer_v1 = lab_0132,
         d_blood_v1 = lab_0012, 
         platelet_abs_v1 = lab_0081, #unit: 1 = [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
         unit_platelet_abs_v1 = lab_0082
         ) %>% 
  filter(vis == 'Screening / V1') %>% 
  select(-vis) %>% 
   mutate(
    d_blood_v1 = as.Date(as.character(d_blood_v1), format = "%Y%m%d"),
    dimer_v1 = if_else(unit_dimer_v1 == 2, dimer_v1 / 1000, dimer_v1)
  ) %>% 
  select(-c(unit_dimer_v1, unit_platelet_abs_v1))
```

```{r create dat_cc1_his_hap}
#variable extract
dat_cc1_his_hap <- cc1_his_hap %>% 
  select(psn = export_psn,
         d_cc1_cc2_his = labcc_0012,
         urea_his = labcc_0141,#unit: 1 = [mg/dl], 2 = [mmol/l]
         unit_urea_his = labcc_0142,
         creatinine_his = labcc_0131,#unit: 1 = [mg/dl], 2 = [mmol/l], 3 = [µmol/l]
         unit_creatinine_his = labcc_0132
         ) %>% 
  mutate(
    d_cc1_cc2_his = as.Date(as.character(d_cc1_cc2_his), format = "%Y%m%d"),
    urea_his = case_when(
      unit_urea_his == 2 ~ urea_his / 0.1665, #unit convert to mg/dl for urea_his
      TRUE ~ urea_his
      ),
    creatinine_his = case_when(
      unit_creatinine_his == 2 ~ creatinine_his / 0.0884, #unit convert to mg/dl for creatinine_his
      unit_creatinine_his == 3 ~ creatinine_his / 88.4017, #unit convert to mg/dl for creatinine_his
      TRUE ~ creatinine_his
      ),
    creatinine_his = round(creatinine_his, 2),
    urea_his = round(urea_his, 2)
  ) %>% 
  select(-c(unit_urea_his, unit_creatinine_his))
```

```{r create dat_cc01_hap}
#variable extract
dat_cc01_hap <- cc01_hap %>% 
  select(psn = export_psn,
         vis = mnpvislabel,
         urea_v1 = labcc_0141,#unit: 1 = [mg/dl], 2 = [mmol/l], 3 = [µmol/l]
         unit_urea_v1 = labcc_0142,
         creatinine_v1 = labcc_0131,#unit: 1 = [mg/dl], 2 = [mmol/l], 3 = [µmol/l]
         unit_creatinine_v1 = labcc_0132,
         d_blood_cc1_cc2 = labcc_0012#cco1 recorded date of blood sampling while cco2 did not.--WX
         )%>% 
  filter(vis == 'Screening / V1') %>% 
  select(-vis) %>% 
  mutate(
    urea_v1 = case_when(
      unit_urea_v1 == 2 ~ urea_v1 / 0.1665, #unit convert to mg/dl for urea_v1
      unit_urea_v1 == 3 ~ urea_v1 / 166.5002, #unit convert to mg/dl for urea_v1
      TRUE ~ urea_v1
      ),
    creatinine_v1 = case_when(
      unit_creatinine_v1 == 2 ~ creatinine_v1 / 0.0884 , #unit convert to mg/dl for creatinine_v1
      unit_creatinine_v1 == 3 ~ creatinine_v1 / 88.4017 , #unit convert to mg/dl for creatinine_v1
      TRUE ~ creatinine_v1
      ),
    creatinine_v1 = round(creatinine_v1, 2),
    urea_v1 = round(urea_v1, 2)
    ) %>% 
  select(-c(unit_urea_v1, unit_creatinine_v1)) %>% 
  mutate(d_blood_cc1_cc2 = as.Date(as.character(d_blood_cc1_cc2), format = '%Y%m%d'))
```

```{r create dat_cc2_his_hap}
#variable extract
dat_cc2_his_hap <- cc2_his_hap %>% 
  select(psn = export_psn,
         pct_his = labcc_0211, 
         unit_pct_his = labcc_0212,#unit: 1 = [µg/l] o. [ng/ml], 2 = [ng/l], 3 = [ng/dl]
         crp_his = labcc_0221, 
         unit_crp_his = labcc_0222, #unit: 1 = [mg/l] o. [µg/ml], 2 = [nmol/l], 3 = [mg/dl]
         ferritin_his = labcc_0281, 
         albumin_his = labcc_0381, 
         unit_albumin_his = labcc_0382, #unit: 1 = [g/l] o. [mg/ml], 4 = [g/dl]
         ldh_his = labcc_0371, 
         unit_ldh_his = labcc_0372 #1 = [U/l], 3 = [µkat/l]
         ) %>% 
  mutate(
    pct_his = case_when( #unit convert to µg/l for all pct_his
      unit_pct_his == 2 ~ pct_his / 1000,
      unit_pct_his == 3 ~ pct_his / 100,
      TRUE ~ pct_his
    ),
    crp_his = case_when( #unit convert to mg/l for all crp_his
      unit_crp_his == 2 ~ crp_his / 9.5238,
      unit_crp_his == 3 ~ crp_his / 0.1,
      TRUE ~ crp_his
    ),
    albumin_his = case_when(#unit convert to g/l for all albumin_his
      unit_albumin_his == 4 ~ albumin_his / 0.1,
      TRUE ~ albumin_his
    ),
    ldh_his = case_when(#unit convert to g/l for all albumin_his
      unit_ldh_his == 3 ~ ldh_his / 0.01667,
      TRUE ~ ldh_his
    ),
    pct_his = round(pct_his, 2),
    crp_his = round(crp_his, 2),
    albumin_his = round(albumin_his, 2),
    ldh_his = round(ldh_his, 2)
  ) %>% 
  select(-c(unit_pct_his, unit_crp_his, unit_albumin_his, unit_ldh_his))
```

```{r create dat_cc02_hap}
#variable extract
dat_cc02_hap <- cc02_hap %>% 
  select(psn = export_psn,
         vis = mnpvislabel,
         pct_v1 = labcc_0211, #unit: 1 = [µg/l] o. [ng/ml], 2 = [ng/l], 3 = [ng/dl]
         unit_pct_v1 = labcc_0212,
         crp_v1 = labcc_0221, #unit: 1 = [mg/l] o. [µg/ml], 3 = [mg/dl], 4 = [g/l]
         unit_crp_v1 = labcc_0222,
         ferritin_v1 = labcc_0281, 
         albumin_v1 = labcc_0381, #unit: 1 = [g/l] o. [mg/ml], 4 = [g/dl]
         unit_albumin_v1 = labcc_0382,
         ldh_v1 = labcc_0371, 
         unit_ldh_v1 = labcc_0372 #1 = [U/l], 3 = [µkat/l]
) %>% 
  filter(vis == 'Screening / V1') %>% 
  select(-vis) %>% 
  mutate(
    pct_v1 = case_when( #unit convert to µg/l for all pct_his
      unit_pct_v1 == 2 ~ pct_v1 / 1000,
      unit_pct_v1 == 3 ~ pct_v1 / 100,
      TRUE ~ pct_v1
    ),
    crp_v1 = case_when( #unit convert to mg/l for all crp_his
      
      unit_crp_v1 == 3 ~ crp_v1 / 0.1,
      unit_crp_v1 == 4 ~ crp_v1 / 0.001,
      TRUE ~ crp_v1
    ),
    albumin_v1 = case_when(#unit convert to g/l for all albumin_his
      unit_albumin_v1 == 4 ~ albumin_v1 / 0.1,
      TRUE ~ albumin_v1
    ),
    ldh_v1 = case_when(#unit convert to g/l for all albumin_his
      unit_ldh_v1 == 3 ~ ldh_v1 / 0.01667,
      TRUE ~ ldh_v1
    ),
    pct_v1 = round(pct_v1, 2),
    crp_v1 = round(crp_v1, 2),
    albumin_v1 = round(albumin_v1, 2),
    ldh_v1 = round(ldh_v1, 2)
  ) %>% 
  select(-c(unit_pct_v1, unit_crp_v1, unit_albumin_v1, unit_ldh_v1))
```

```{r create dat_vital_his_hap}
#variable extract
dat_vital_his_hap <- vitalhis_hap %>% 
  select(psn = export_psn,
        hr_his = vp_0031,
        bp_sys_his = vp_0041, #unit: mm Hg
        bp_dia_his = vp_0042, #unit: mm Hg
        rr_his = vp_0051,
        temp_his = vp_0061,
        spo2_his = vp_0021,
        o2_supplement_his = vp_0180, #1 = Raumluft, 2 = Maskenbeatmung, 3 = High flow, 4 = Invasive Beatmung, 5 = Sauerstoff über Nasenbrille, 6 = Sauerstoff über Reservoirmaske, -1 = N.A.
                            #crb65 = vitalhis_hap$vp_0195,
        consciousness_his = vp_0070_ni, #1 = Unbeeinträchtigt, 2 = Beeinträchtigt ohne Analgosedierung
        gcs_his = vp_0081_ni#gcs: Glasgow Coma Scale
) %>% 
  mutate(o2_supplement_his = recode(o2_supplement_his,
                            '1' = 'ambient air',
                            '2' = 'mask ventilation',
                            '3' = 'high flow',
                            '4' = 'invasive ventilation',
                            '5' = 'oxygen via nasal cannula',
                            '6' = 'oxygen via reservoir mask',
                            '-1' = 'na'),
         consciousness_his = recode(consciousness_his,
                                '1' = 'unimpaired',
                                '2' = 'impaired without analgesia'))
```

```{r create dat_vitalparam_hap}
#variable extract
dat_vitalparam_hap <- vitalparam_hap %>% 
  select(psn = export_psn,
         vis = mnpvislabel,    
         hr_v1 = vp_0031,
         bp_sys_v1 = vp_0041, #unit: mm Hg
         bp_dia_v1 = vp_0042, #unit: mm Hg
         rr_v1 = vp_0051,
         temp_v1 = vp_0061,
         spo2_v1 = vp_0021,
         o2_supplement_v1 = vp_0180, #1 = Raumluft, 2 = Sauerstofftherapie, -1 = N.A.
         consciousness_v1 = vp_0070_ni, #1 = Unbeeinträchtigt, 2 = Beeinträchtigt ohne Analgosedierung
         gcs_v1 = vp_0081_ni,#gcs: Glasgow Coma Scale
         d_vital_param = vp_0012
         ) %>% 
  mutate(
    consciousness_v1 = recode(consciousness_v1,
                                '1' = 'unimpaired',
                                '2' = 'impaired without analgesia')) %>% 
  filter(vis == 'Screening / V1') %>% 
  select(-vis) %>% 
  mutate(
    d_vital_param = as.Date(as.character(d_vital_param), format = '%Y%m%d')
  )
```

```{r create dat_ptcenter_hap}
dat_ptcenter_hap <- ptcenter_hap %>% 
  select(psn = export_psn,
         ptcenter = Zentrum
)
```

```{r create raw_data_hap}
#data merge
data_frames <- list(
  dat_demo_hap,
  dat_blut_hap,
  dat_cc2_his_hap,
  dat_cc1_his_hap,
  dat_vital_his_hap,
  dat_blut_his_hap,
  dat_cc02_hap,
  dat_cc01_hap,
  dat_vitalparam_hap,
  dat_risiko1_hap,
  dat_risiko2_hap,
  dat_ptcenter_hap
  )

dat_raw_hap <- Reduce(function(x, y) {merge(x, y, by = "psn", all = TRUE)}, data_frames)
dat_raw_hap <- merge(dat_raw_hap, dat_vis02_hap, all.x = TRUE, by = "psn")

#select all variables, then include IMC, then check dates for labs and vitals.
dat_raw_hap <- dat_raw_hap %>% 
  select(psn, ptcenter, vis, age, sex, icu_7d, d_adm_enrolled_hsptl, d_hsptl, d_icu, d_v1, duration_hsptl_v1, duration_hsptl_icu, d_blood_his, wbc_abs_his, lympho_abs_his, neutro_abs_his, dimer_his, platelet_abs_his, d_cc1_cc2_his, urea_his, creatinine_his, pct_his, crp_his, ferritin_his, albumin_his, ldh_his, d_blood_v1, wbc_abs_v1, lympho_abs_v1, neutro_abs_v1, dimer_v1, platelet_abs_v1, d_blood_cc1_cc2, pct_v1, crp_v1, ferritin_v1, albumin_v1, urea_v1, creatinine_v1, ldh_v1, hr_his, bp_sys_his, bp_dia_his, rr_his, temp_his, spo2_his, o2_supplement_his, consciousness_his, gcs_his, d_vital_param, hr_v1, bp_sys_v1, bp_dia_v1, rr_v1, temp_v1, spo2_v1, o2_supplement_v1, consciousness_v1, gcs_v1, everything()) %>% 
  select(-c(d_hsptl, vis)) %>% 
  select(-c(hr_v1, bp_sys_v1, bp_dia_v1, rr_v1, temp_v1, spo2_v1, o2_supplement_v1, consciousness_v1))
```

```{r combine blut_his_hap with blut_hap}
#all lab_his values were retained. For v1 values, only those taken and recorded within 24h of admission into enrolled hospitals were retained. 
dat_raw_hap_blood_v1 <- dat_raw_hap %>%
  select(psn, d_adm_enrolled_hsptl, d_blood_v1, wbc_abs_his, wbc_abs_v1, lympho_abs_his, lympho_abs_v1, neutro_abs_his, neutro_abs_v1, dimer_his, dimer_v1, platelet_abs_his, platelet_abs_v1) %>%
  mutate(
    duration_hsptl_blood_v1 = d_blood_v1 - d_adm_enrolled_hsptl,
    wbc_abs = coalesce(wbc_abs_his, wbc_abs_v1),
    lympho_abs = coalesce(lympho_abs_his, lympho_abs_v1),
    neutro_abs = coalesce(neutro_abs_his, neutro_abs_v1),
    platelet_abs = coalesce(platelet_abs_his, platelet_abs_v1),
    dimer = coalesce(dimer_his, dimer_v1)
    ) %>%
  filter(duration_hsptl_blood_v1 <= 1) %>%
  select(psn, d_adm_enrolled_hsptl, d_blood_v1, duration_hsptl_blood_v1, everything()) %>%
  select(-wbc_abs_his, -wbc_abs_v1, -neutro_abs_his, -neutro_abs_v1, -lympho_abs_his, -lympho_abs_v1, -platelet_abs_his, -platelet_abs_v1, -dimer_his, -dimer_v1)

#join those lab values(_his & v1 <= 24h) with other dat_raw_hap data
dat_raw_hap <- merge(dat_raw_hap, dat_raw_hap_blood_v1, all.x = TRUE)

dat_raw_hap <- dat_raw_hap %>%
  mutate(
    wbc_abs = coalesce(wbc_abs_his, wbc_abs),
    lympho_abs = coalesce(lympho_abs_his, lympho_abs),
    neutro_abs = coalesce(neutro_abs_his, neutro_abs),
    platelet_abs = coalesce(platelet_abs_his, platelet_abs),
    dimer = coalesce(dimer_his, dimer)
  ) %>%
  select(-wbc_abs_his, -wbc_abs_v1, -neutro_abs_his, -neutro_abs_v1, -lympho_abs_his, -lympho_abs_v1, -platelet_abs_his, -platelet_abs_v1, -dimer_his, -dimer_v1, -d_blood_his)
```

```{r combine cc_his_hap with cc_hap}
#all lab_his values were retained. For v1 values, only those taken and recorded within 24h of admission into enrolled hospitals were retained. 
dat_raw_hap_cc_v1 <- dat_raw_hap %>%
  select(psn, d_adm_enrolled_hsptl, d_blood_cc1_cc2, urea_his, urea_v1, creatinine_his, creatinine_v1, crp_his, crp_v1, pct_his, pct_v1, ferritin_his, ferritin_v1, albumin_his, albumin_v1, ldh_his, ldh_v1) %>%
  mutate(
    duration_hsptl_cc_v1 = d_blood_cc1_cc2 - d_adm_enrolled_hsptl,
    urea = coalesce(urea_his, urea_v1),
    creatinine = coalesce(creatinine_his, creatinine_v1),
    crp = coalesce(crp_his, crp_v1),
    pct = coalesce(pct_his, pct_v1),
    ferritin = coalesce(ferritin_his, ferritin_v1),
    albumin = coalesce(albumin_his, albumin_v1),
    ldh = coalesce(ldh_his, ldh_v1)
    ) %>%
  filter(duration_hsptl_cc_v1 <= 1) %>%
  select(psn, d_adm_enrolled_hsptl, d_blood_cc1_cc2, duration_hsptl_cc_v1, everything()) %>%
  select(-urea_his, -urea_v1, -creatinine_his, -creatinine_v1, -crp_his, -crp_v1, -pct_his, -pct_v1, -ferritin_his, -ferritin_v1, -albumin_his, -albumin_v1, -ldh_his, -ldh_v1)

#join those lab values(_his & v1 <= 24h) with other dat_raw_hap data
dat_raw_hap <- merge(dat_raw_hap, dat_raw_hap_cc_v1, all.x = TRUE)

dat_raw_hap <- dat_raw_hap %>%
  mutate(
    urea = coalesce(urea_his, urea),
    creatinine = coalesce(creatinine_his, creatinine),
    crp = coalesce(crp_his, crp),
    pct = coalesce(pct_his, pct),
    ferritin = coalesce(ferritin_his, ferritin),
    albumin = coalesce(albumin_his, albumin),
    ldh = coalesce(ldh_his, ldh)
  ) %>%
  select(-urea_his, -urea_v1, -creatinine_his, -creatinine_v1, -crp_his, -crp_v1, -pct_his, -pct_v1, -ferritin_his, -ferritin_v1, -albumin_his, -albumin_v1, -ldh_his, -ldh_v1, -d_blood_v1, -d_cc1_cc2_his, -d_blood_cc1_cc2)
```

```{r combine gcs_his and gcs_v1}
#all lab_his values were retained. For v1 values, only those taken and recorded within 24h of admission into enrolled hospitals were retained. 
dat_raw_hap_gcs_v1 <- dat_raw_hap %>%
  select(psn, d_adm_enrolled_hsptl, d_vital_param, gcs_his, gcs_v1) %>%
  mutate(
    duration_hsptl_gcs_v1 = d_vital_param - d_adm_enrolled_hsptl,
    gcs = coalesce(gcs_his, gcs_v1)
    ) %>%
  filter(duration_hsptl_gcs_v1 <= 1) %>%
  select(psn, d_adm_enrolled_hsptl, d_vital_param, duration_hsptl_gcs_v1, everything()) %>%
  select(-gcs_his, -gcs_v1)

#join those lab values(_his & v1 <= 24h) with other dat_raw_hap data
dat_raw_hap <- merge(dat_raw_hap, dat_raw_hap_gcs_v1, all.x = TRUE)

dat_raw_hap <- dat_raw_hap %>%
  mutate(
    gcs = coalesce(gcs_his, gcs)
  ) %>%
  select(-gcs_his, -gcs_v1)
```

```{r final adjustment of dat_raw_hap}
dat_raw_hap <- dat_raw_hap %>% 
  select(-d_adm_enrolled_hsptl,
         -d_icu,
         -d_v1,
         -duration_hsptl_v1,
         -duration_hsptl_icu,
         -d_vital_param,
         -duration_hsptl_blood_v1,
         -duration_hsptl_cc_v1,
         -duration_hsptl_gcs_v1)

#rename some variables to promote joining with suep data
dat_raw_hap <- dat_raw_hap %>% 
  rename(
    hr = hr_his,
    bp_sys = bp_sys_his,
    bp_dia = bp_dia_his,
    rr = rr_his,
    temp = temp_his,
    spo2 = spo2_his,
    o2_supplement = o2_supplement_his,
    consciousness = consciousness_his
  ) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, everything()
  ) %>% 
  mutate(
    impaired_consciousness = ifelse(dat_raw_hap$consciousness == 'unimpaired', 'no', 'yes')
  ) %>%
  select(-c(consciousness, gcs)) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())
```

```{r import suep files, warning=FALSE}
# Define the file names in a vector
file_names <- c(
  "scv.csv",
  "bv1.csv",
  "stv1.csv",
  "stv2.csv",
  "eward.csv",
  "fv1.csv",
  'fuv1.csv',
  'fv2_1.csv',
  'fv2_2.csv',
  'fuv3.csv',
  "PatientCentres.csv"
)

# Create an empty list to store the data frames
suep_data <- list()

# Loop over the file names and read the CSV files
for (file_name in file_names) {
  file_path <- paste0("T:/Projects/NAPKON/projects/prognostic_score/prognositic_score/version2/SUEP/", file_name)
  df <- read.csv2(file_path)
  suep_data[[file_name]] <- df
}

# Access the individual data frames using names or indices
scv_suep <- suep_data[["scv.csv"]]
bv1_suep <- suep_data[["bv1.csv"]]
stv1_suep <- suep_data[["stv1.csv"]]
stv2_suep <- suep_data[["stv2.csv"]]
eward_suep <- suep_data[["eward.csv"]]
fv1_suep <- suep_data[["fv1.csv"]]
fuv1_suep <- suep_data[["fuv1.csv"]]
fv2_1_suep <- suep_data[["fv2_1.csv"]]
fv2_2_suep <- suep_data[["fv2_2.csv"]]
ptcenter_suep <- suep_data[["PatientCentres.csv"]]
```

```{r create dat_scv_suep}
dat_scv_suep <- scv_suep %>% 
  select(psn = export_psn,
         d_baseline = gec_pr_incl_date,
         p_inclusion = pr_inclusionsitecity
         ) %>% 
  mutate(
    d_baseline = as.Date(as.character(d_baseline), format = '%Y%m%d')
  )
```

```{r create dat_fv1_suep}
dat_fv1_suep <- fv1_suep %>% 
  select(psn = export_psn,
         hsptl = ward #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar. WX: 1: Inpatient stay (> 24 h) during the observation period
         ) %>% 
  filter(hsptl == 1) %>% 
   mutate(
    hsptl = recode(hsptl, "1" = "yes")
  )

#create index for hSUEP for the tables below
hsptl_psn <- dat_fv1_suep$psn
```

```{r create dat_bv1_suep}
#variable extract
dat_bv1_suep <- bv1_suep %>% 
  select(psn = export_psn,
         age = birthdate_score, #age upon admission
         height = gec_height,
         sex = gec_gender #1 = Weiblich, 2 = Männlich, 3 = Divers, 4 = Unbestimmt, -1 = Keine Informationen verfügbar
         ) %>% 
  filter(psn %in% hsptl_psn) %>% 
  mutate(
    age = as.numeric(substr(age, 1, 2)),
    sex = recode (sex,
                  '1' = 'female',
                  '2' = 'male',
                  '3' = 'bi',
                  '4' = 'unsure',
                  '-1' = 'na')
  )
```

```{r create dat_eward_suep}
#variable extract
dat_eward_suep <- eward_suep %>% 
  select(psn = export_psn,
         ward_adm_no = position,#0:1st admission; 1: 2nd admission etc.
         ward_type = gec_ward, #1 = Normalstation, 2 = Intermediate Care Station, 3 = Notaufnahmestation, 4 = Intensivstation, 5 = Palliativstation, 6 = Andere Stationsform, 7 = Frührehastation, -1 = Keine Informationen verfügbar
         d_ward_begin = ward_start,
         d_ward_end = ward_end
         ) %>% 
  filter(psn %in% hsptl_psn) # Selection of hospitalized patients only

#table(is.na(dat_eward_suep$ward_type)) #no missingness
#table(is.na(dat_eward_suep$ward_adm_no)) #no missingness
#table(is.na(dat_eward_suep$d_ward_begin)) #8 pts with missingness
#table(as.character(dat_eward_suep$ward_adm_no)) #0-18
#table(as.character(dat_eward_suep$ward_type)) #39 'unknown' for ward_type

#explore the 8 patients with missingness for d_ward_begin
#dat_eward_suep_temp <- dat_eward_suep %>% filter(is.na(d_ward_begin))
#missing: export_0056 (included in the 35 pts missing ward_type as well), export_0062,  export_0902
#7d_icu: export_0052, export_0644, export_0866      
#non-7d_icu: export_0683(included in the 35 pts missing ward_type as well), export_1434

#explore the 39 'unknown' for ward_type
dat_eward_suep_ward_na <- dat_eward_suep %>%
  filter(ward_type == -1) %>%
  #summarise(n_distinct(psn))
  distinct(psn) #35 pts for the 39 'unknown' for ward_type

#explore the 35 pts with unknown for ward_type
dat_eward_suep_ward_na_temp <- dat_eward_suep %>% 
  filter(psn %in% pull(dat_eward_suep_ward_na)) %>% 
  arrange(psn, ward_adm_no) 
#(
##12 missing: export_0025, export_0040, export_0056, export_0117, export_0341, export_0387, export_0444, export_0526, export_1054, export_1967, export_0973, export_1836, 
##7-day icu: export_0098, export_0220, export_0312, export_0331, export_0439, export_0764, export_0846, export_1217, export_1517, export_1614, export_1752, export_1898, export_1947, export_1992, export_2037, export_2074, export_2096, export_2168
##non_7day_icu: export_0272, export_0683, export_1047,export_1344, export_1907)

ward_type_unknown <- c('export_0025', 'export_0040', 'export_0056', 'export_0117', 'export_0341', 'export_0387', 'export_0444', 'export_0526', 'export_1054', 'export_1967', 'export_0973', 'export_1836', 'export_0098', 'export_0220', 'export_0312', 'export_0331', 'export_0439', 'export_0764', 'export_0846', 'export_1217', 'export_1517', 'export_1614', 'export_1752', 'export_1898', 'export_1947', 'export_1992', 'export_2037', 'export_2074', 'export_2096', 'export_2168', 'export_0272', 'export_0683', 'export_1047','export_1344', 'export_1907')

d_ward_begin_na <- c('export_0062',  'export_0902', 'export_0052', 'export_0644', 'export_0866', 'export_1434')

dat_eward_suep_remain <- dat_eward_suep %>% 
  filter(!psn %in% ward_type_unknown, !psn %in% d_ward_begin_na) #1845 pts remained

d_hsptl <- dat_eward_suep_remain %>% 
  filter(ward_adm_no == 0) %>% 
  select(psn, d_hsptl = d_ward_begin)
  
#table(is.na(dat_eward_suep_remain$ward_type)) #no missingness
#table(is.na(dat_eward_suep_remain$ward_adm_no)) #no missingness
#table(is.na(dat_eward_suep_remain$d_ward_begin)) #8 pts with missingness
#table(as.character(dat_eward_suep_remain$ward_adm_no)) #0-18
#table(as.character(dat_eward_suep_remain$ward_type)) #39 'unknown' for ward_type

#count pts admitted into ICU ever from the complete cases
icu <- dat_eward_suep_remain %>% filter(ward_type %in% c(2, 4)) %>% distinct(psn) #578 patients admitted into ICU at least once

#count pts never admitted into ICU from the complete cases
non_icu <- dat_eward_suep_remain %>% filter(!psn %in% pull(icu)) %>% distinct(psn) #1267 patients never admitted into ICU

#explore 7-day ICU admission within ICU
##during 1 admission
dat_eward_suep_7d_icu_0 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 0 & ward_type %in% c(2, 4)) #252 pts admitted into icu upon hospital admission

#during 2 admission
# Function to process ICU data
dat_eward_suep_7d_icu_1 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 1 & ward_type %in% c(2, 4)) 

count1 <- dat_eward_suep_7d_icu_1%>% 
  distinct(psn)

date1 <- d_hsptl %>% 
  filter(psn %in% pull(count1))
  
dat_eward_suep_7d_icu_1 <- dat_eward_suep_7d_icu_1 %>% 
  mutate(d_hsptl = pull(date1)) %>% 
  mutate(duration_hsptl_icu = d_ward_begin - d_hsptl) %>% 
  filter(duration_hsptl_icu <= 7) #236 pts admitted into icu within 7 days of hospital admission

#during 3 admission
dat_eward_suep_7d_icu_2 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 2 & ward_type %in% c(2, 4)) 

count2 <- dat_eward_suep_7d_icu_2%>% 
  distinct(psn)

date2 <- d_hsptl %>% 
  filter(psn %in% pull(count2))
  
dat_eward_suep_7d_icu_2 <- dat_eward_suep_7d_icu_2 %>% 
  mutate(d_hsptl = pull(date2)) %>% 
  mutate(duration_hsptl_icu = d_ward_begin - d_hsptl) %>% 
  filter(duration_hsptl_icu  <= 7) #39 pts admitted into icu within 7 days of hospital admission

#during 4 admission
dat_eward_suep_7d_icu_3 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 3 & ward_type %in% c(2, 4)) 

count3 <- dat_eward_suep_7d_icu_3%>% 
  distinct(psn)

date3 <- d_hsptl %>% 
  filter(psn %in% pull(count3))
  
dat_eward_suep_7d_icu_3 <- dat_eward_suep_7d_icu_3 %>% 
  mutate(d_hsptl = pull(date3)) %>% 
  mutate(duration_hsptl_icu = d_ward_begin - d_hsptl) %>% 
  filter(duration_hsptl_icu  <= 7) #8 pts admitted into icu within 7 days of hospital admission

#during 5 admission
dat_eward_suep_7d_icu_4 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 4 & ward_type %in% c(2, 4)) 

count4 <- dat_eward_suep_7d_icu_4%>% 
  distinct(psn)

date4 <- d_hsptl %>% 
  filter(psn %in% pull(count4))
  
dat_eward_suep_7d_icu_4 <- dat_eward_suep_7d_icu_4 %>% 
  mutate(d_hsptl = pull(date4)) %>% 
  mutate(duration_hsptl_icu = d_ward_begin - d_hsptl) %>% 
  filter(duration_hsptl_icu  <= 7) #0 pts admitted into icu within 7 days of hospital admission 

#during 6 admission
dat_eward_suep_7d_icu_5 <- dat_eward_suep_remain %>% 
  filter(psn %in% pull(icu)) %>% 
  filter(ward_adm_no == 5 & ward_type %in% c(2, 4)) 

count5 <- dat_eward_suep_7d_icu_5%>% 
  distinct(psn)

date5 <- d_hsptl %>% 
  filter(psn %in% pull(count5))
  
dat_eward_suep_7d_icu_5 <- dat_eward_suep_7d_icu_5 %>% 
  mutate(d_hsptl = pull(date5)) %>% 
  mutate(duration_hsptl_icu = d_ward_begin - d_hsptl) %>% 
  filter(duration_hsptl_icu  <= 7) #0 pts admitted into icu within 7 days of hospital admission 

#add 'd_hsptl' and 'duration_hsptl_icu' to dat_eward_suep_7d_icu_0
dat_eward_suep_7d_icu_0 <- dat_eward_suep_7d_icu_0 %>% 
  mutate(d_hsptl = d_ward_begin, 
         duration_hsptl_icu = d_ward_begin - d_hsptl)

#all psn admitted into icu within 7d from dat_eward_suep_remain
dat_eward_suep_7d_icu_remain <- rbind(dat_eward_suep_7d_icu_0, dat_eward_suep_7d_icu_1, dat_eward_suep_7d_icu_2, dat_eward_suep_7d_icu_3) %>% 
  select(psn, d_hsptl, duration_hsptl_icu)

#add 18 from the unknown of ward_type, 3 from NA of d_ward_begin
icu_7d <- c('export_0098', 'export_0220', 'export_0312', 'export_0331', 'export_0439', 'export_0764', 'export_0846', 'export_1217', 'export_1517', 'export_1614', 'export_1752', 'export_1898', 'export_1947', 'export_1992', 'export_2037', 'export_2074', 'export_2096', 'export_2168', 'export_0052', 'export_0644', 'export_0866')


icu_7d_addition <- dat_eward_suep %>% 
  filter(psn %in% icu_7d, ward_adm_no == 0) %>% 
  select(psn, 
         d_hsptl = d_ward_begin) %>% 
  mutate(duration_hsptl_icu = 6.5)

#total pts admitted into icu within 7d
dat_eward_suep_7d_icu_total <- rbind(dat_eward_suep_7d_icu_remain, icu_7d_addition)

psn_icu_7d <- dat_eward_suep_7d_icu_total$psn#556 recordings 
n_distinct(psn_icu_7d) #only 516 distinct pts admitted into icu within 7d

#total pts with 12 NA from ward_type and 2 NA from d_ward_begin removed
removal_na_14 <- c('export_0025', 'export_0040', 'export_0056', 'export_0117', 'export_0341', 'export_0387', 'export_0444', 'export_0526', 'export_1054', 'export_1967', 'export_0973', 'export_1836', 'export_0062',  'export_0902')

dat_eward_suep_final <- dat_eward_suep %>% 
  filter(ward_adm_no == 0,
         !psn %in% removal_na_14) %>% 
  select(psn,
         d_hsptl = d_ward_begin) %>% #1: icu within 7d; 0: icu beyond 7d or non-icu
  mutate(icu_7d = if_else(
    psn %in% psn_icu_7d, 1, 0
  ))

dat_eward_suep <- dat_eward_suep_final

#recode the variable of 'icu_7d'
dat_eward_suep <- dat_eward_suep %>% 
  mutate(icu_7d = recode(
    icu_7d,
    '1' = 'yes',
    '0' = 'no'
  ))
```

```{r create dat_stv1_suep}
#variable extract
dat_stv1_suep <- stv1_suep %>% 
  select(psn = export_psn,
        vis_label = mnpvislabel,
        bp_sys = gec_vitals_psys,
        bp_dia = gec_vitals_pdias,
        hr = gec_vitals_hf,
        rr = gec_vitals_resp,
        temp = gec_vitals_temp,
        spo2 = gec_vitals_so2,
        o2_supplement = vitals_so2_context, #1 = Unter Sauerstoffgabe, 2 = Bei Raumluft, -1 = Keine Informationen verfügbar
        gcs = vitals_gcs, #1 = Explizit dokumentierte Information, 2 = Einschätzung anhand der Aktenlage (Educated Guess), -1 = Keine Informationen verfügbar
        consciousness = p_vitals_avpu #1 = A = alert = Patient:in ist wach, 2 = V= verbal = Patient:in reagiert auf Ansprache, 3 = P = pain = Patient:in reagiert auf Schmerzreize, 4 = U = unresponsive = Patient:in zeigt keine Reaktion, -1 = Keine Informationen verfügbar
) %>% 
  filter(psn %in% hsptl_psn) %>%  # Selection of hospitalized patients only
  mutate(o2_supplement = recode(o2_supplement,
                            '1' = 'with oxygen supply',
                            '2' = 'ambient air',
                            '-1' = 'na')
         ) %>% 
  filter(vis_label == "Baseline") # Selection of baseline values from all values recorded from baseline through 12m follow-up:
```

```{r create dat_stv2_suep}
#variable extract
dat_stv2_suep <- data.frame(psn = stv2_suep$export_psn,
                            vis_label = stv1_suep$mnpvislabel,
                            albumin = stv2_suep$gec_albumin, #unit: 1 = g/dl, 2 = g/l
                            unit_albumin = stv2_suep$gec_albumin_u,
                            crp = stv2_suep$gec_crp, #unit: 1 = mg/l, 2 = mg/dl
                            unit_crp = stv2_suep$gec_crp_u,
                            crp_est = stv2_suep$gec_crp_est,# < values
                            ferritin = stv2_suep$gec_ferritin, #unit: 3 = µg/l, 1 = mg/l, 2 = ng/ml, 4 = pmol/l
                            unit_ferritin = stv2_suep$gec_ferritin_u, #all converted to 3 = µg/l
                            pct = stv2_suep$gec_pct, #unit: 1 = ng/ml, 2 = µg/l
                            unit_pct = stv2_suep$gec_pct_u,
                            pct_est = stv2_suep$gec_pct_est, # < values
                            dimer = stv2_suep$gec_coag_ddimer, #unit: 1 = mg/l, 2 = ng/ml, 3 = µg/l, 4 = µg/ml
                            unit_dimer = stv2_suep$gec_coag_ddimer_u,
                            wbc_abs = stv2_suep$gec_bc_wbc, #unit: 2 = /nl, 1 = /µl, 3 = x10^3/µl, 4 = Ts/µl, 5 = x1E9/l, 6 = Gpt/l
                            unit_wbc_abs = stv2_suep$gec_bc_wbc_u,
                            lympho_abs = stv2_suep$gec_bc_lymphoc, #unit: 1 = %, 2 = /µl, 3 = /nl, 4 = x10^3/µl, 5 = Ts/µl, 6 = x1E9/l, 7 = Gpt/l
                            unit_lympho_abs = stv2_suep$gec_bc_lymphoc_u,
                            neutro_abs = stv2_suep$gec_bc_neutroph, #unit: 1 = %, 2 = /µl, 3 = /nl, 4 = x10^3/µl, 5 = Ts/µl, 6 = x1E9/l, 7 = Gpt/l
                            unit_neutro_abs = stv2_suep$gec_bc_neutroph_u,
                            platelet_abs = stv2_suep$gec_bc_platelet,
                            unit_platelet_abs = stv2_suep$gec_bc_platelet_u, #2 = /nl, 1 = /µl, 3 = x10^3/µl, 4 = Ts/µl, 5 = x1E9/l, 6 = Gpt/l, 7 = K/µl
                            urea = stv2_suep$urea,
                            unit_urea = stv2_suep$urea_u, #3 = mg/dl, 1 = mg/l, 2 = µmol/l, 4 = mmol/l, 5 = nmol/ml
                            creatinine = stv2_suep$gec_crea,
                            unit_creatinine = stv2_suep$gec_crea_u,#2 = mg/dl, 1 = µmol/l, 3 = nmol/ml
                            ldh = stv2_suep$gec_ldh,
                            unit_ldh = stv2_suep$gec_ldh_u #2 = U/l, 1 = µkat/l
                            ) %>% 
  filter(psn %in% hsptl_psn) %>%  # Selection of hospitalized patients only
  filter(vis_label == "Baseline") %>%  # Selection of baseline values from all values recorded from baseline through 12m follow-up
  select( # Removal of unnecessary variables
    -crp_est, #only 10 values available in the context of only 153 missingness for crp
    -pct_est
  ) %>% 
  mutate(#unit conversion
    albumin = if_else(unit_albumin == 1, albumin / 0.1, albumin),#HAP standard
    crp = if_else(unit_crp == 1, crp, crp / 0.1),#HAP standard
    ferritin = case_when(
      unit_ferritin == 3 ~ ferritin,#HAP standard
      unit_ferritin == 1 ~ ferritin * 1000,#chatgpt 
      unit_ferritin == 2 ~ ferritin,#HAP standard
      unit_ferritin == 4 ~ ferritin / 2.2472), #HAP standard
    pct = if_else(unit_pct == 1, pct, pct / 1),#HAP standard
    dimer = case_when(
      unit_dimer == 1 ~ dimer,#HAP standard
      unit_dimer == 2 ~ dimer / 1000,#HAP standard
      unit_dimer == 3 ~ dimer / 1000,#HAP standard
      unit_dimer == 4 ~ dimer / 1),#HAP standard
    wbc_abs = case_when(
      unit_wbc_abs == 2 ~ wbc_abs,#HAP standard
      unit_wbc_abs == 1 ~ wbc_abs / 1000, #chatgpt 
      unit_wbc_abs == 3 ~ wbc_abs,#HAP standard
      unit_wbc_abs == 4 ~ wbc_abs,#https://www.jung-stilling.de/fileadmin/contents/02_klinikum_jung_stilling/06_fachabteilungen/04_geburtshilfe/artikel_fulminantes_postpartales_hellp_syndrom.pdf 
      unit_wbc_abs == 5 ~ wbc_abs,#HAP standard
      unit_wbc_abs == 6 ~ wbc_abs#HAP standard
    ),
    lympho_abs = case_when(
      unit_lympho_abs == 1 ~ lympho_abs / 100,#https://academic.oup.com/amamanualofstyle/si-conversion-calculator  
      unit_lympho_abs == 2 ~ lympho_abs / 1000,
      unit_lympho_abs == 3 ~ lympho_abs,#HAP standard
      unit_lympho_abs == 4 ~ lympho_abs,#HAP standard
      unit_lympho_abs == 5 ~ lympho_abs,#https://www.jung-stilling.de/fileadmin/contents/02_klinikum_jung_stilling/06_fachabteilungen/04_geburtshilfe/artikel_fulminantes_postpartales_hellp_syndrom.pdf 
      unit_lympho_abs == 6 ~ lympho_abs,#HAP standard
      unit_lympho_abs == 7 ~ lympho_abs#HAP standard
    ),
     neutro_abs = case_when(
      unit_neutro_abs == 1 ~ neutro_abs / 100,#https://academic.oup.com/amamanualofstyle/si-conversion-calculator 
      unit_neutro_abs == 2 ~ neutro_abs / 1000,
      unit_neutro_abs == 3 ~ neutro_abs,#HAP standard
      unit_neutro_abs == 4 ~ neutro_abs,#HAP standard
      unit_neutro_abs == 5 ~ neutro_abs,#https://www.jung-stilling.de/fileadmin/contents/02_klinikum_jung_stilling/06_fachabteilungen/04_geburtshilfe/artikel_fulminantes_postpartales_hellp_syndrom.pdf 
      unit_neutro_abs == 6 ~ neutro_abs,#HAP standard
      unit_neutro_abs == 7 ~ neutro_abs#HAP standard
    ),
     platelet_abs = case_when(
      unit_platelet_abs == 2 ~ platelet_abs,#HAP standard
      unit_platelet_abs == 1 ~ platelet_abs / 1000,
      unit_platelet_abs == 3 ~ platelet_abs,#HAP standard
      unit_platelet_abs == 4 ~ platelet_abs,#https://www.jung-stilling.de/fileadmin/contents/02_klinikum_jung_stilling/06_fachabteilungen/04_geburtshilfe/artikel_fulminantes_postpartales_hellp_syndrom.pdf
      unit_platelet_abs == 5 ~ platelet_abs,#HAP standard
      unit_platelet_abs == 6 ~ platelet_abs#HAP standard
    ),
    urea = case_when(
      unit_urea == 3 ~ urea,#HAP standard
      unit_urea == 1 ~ urea / 10,#HAP standard
      unit_urea == 2 ~ urea / 166.5002,#HAP standard
      unit_urea == 4 ~ urea / 0.1665,#HAP standard
      unit_urea == 5 ~ urea / 166.5#https://www.google.com/search?q=nmol%2Fml+to+mmol%2Fl&oq=nmol%2Fml+to+mmol%2Fl&aqs=edge..69i57j0i19i22i30j69i58.11927j0j1&sourceid=chrome&ie=UTF-8 
    ),
    creatinine = case_when(
      unit_creatinine == 2 ~ creatinine,#HAP standard
      unit_creatinine == 1 ~ creatinine / 88.4017,#HAP standard
      unit_creatinine == 3 ~ creatinine/ 88.4017#https://hextobinary.com/unit/molarconc/from/nmolpml/to/umolpl 
    ),
     albumin = case_when(
      unit_albumin == 1 ~ albumin / 0.1,
      unit_albumin == 2 ~ albumin
    ),
     ldh = case_when(
      unit_ldh == 2 ~ ldh,#HAP standard
      unit_ldh == 1 ~ ldh / 0.01667#HAP standard
    )
      )
```

```{r create dat_fuv1_suep}
dat_fuv1_suep <- fuv1_suep %>% 
  select(psn = export_psn,
         vis = mnpvislabel,
         weight = gec_weight, #unit: kg (for all values)
         est_weight = weight_estimated #unit: kg (for all values)
         )

#combine 'weight' and 'est_weight' above to make a single variable of 'weight':
dat_fuv1_suep$weight[is.na(dat_fuv1_suep$weight)] <- dat_fuv1_suep$est_weight

#combine weight and est_weight
dat_fuv1_suep$weight <- ifelse(is.na(dat_fuv1_suep$weight), dat_fuv1_suep$est_weight, dat_fuv1_suep$weight)

#calculate 'bmi':
dat_fuv1_suep$bmi <- dat_fuv1_suep$weight/(dat_bv1_suep$height/100) ** 2
dat_fuv1_suep$bmi <- round(dat_fuv1_suep$bmi, 2)

#recode 'bmi'
dat_fuv1_suep$obesity <- ifelse(dat_fuv1_suep$bmi >= 30, 'yes', 'no')

#selection of hospitalized patients only
dat_fuv1_suep <- dat_fuv1_suep %>% 
  filter(psn %in% hsptl_psn, 
         vis == 'Baseline')

#keep 'bmi' alone:
dat_fuv1_suep <- dat_fuv1_suep[, c('psn', 'obesity')]
```

```{r create dat_fv2_1_suep}
dat_fv2_1_suep <- fv2_1_suep %>% 
  select(psn = export_psn,
         comor_cvd = gec_cv #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar
         ) %>% 
  #selection of hospitalized patients only
  filter(psn %in% hsptl_psn) %>% 
  mutate(
    comor_cvd = ifelse(comor_cvd == -1, NA, comor_cvd) # Reset all '-1' as 'NA'
  )
```

```{r create dat_fv2_2_suep}
dat_fv2_2_suep <- fv2_2_suep %>% 
  select(psn = export_psn,
         comor_chronic_lung = gec_pd, #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar
         comor_asthma = gec_pd_asthma, #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar (too many missingness to be meaningful)
         comor_ckd = gec_ckd, #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar
         comor_chronic_liver = gec_lv #0 = Nein, 1 = Ja, -1 = Keine Informationen verfügbar
         ) %>% 
  # Selection of hospitalized patients only
  filter(psn %in% hsptl_psn) %>% 
  mutate(across(where(is.numeric), ~ ifelse(. == -1, NA, .)),
         comor_chronic_lung_no_asthma = ifelse(comor_chronic_lung == 1 & comor_asthma == 1, 0, comor_chronic_lung) # Create 'comor_chronic_lung_no_asthma'
         ) %>% 
  select(-comor_asthma)
```

```{r create dat_ptcenter_suep}
dat_ptcenter_suep <- ptcenter_suep %>% 
  select(psn = export_psn,
         ptcenter = Zentrum
         ) %>% 
# Selection of hospitalized patients only
  filter(psn %in% hsptl_psn)
```

```{r create raw_data_suep}
#joining selected variables from all tables checked above 
dat_raw_suep <- merge(dat_scv_suep, dat_fv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_bv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_ptcenter_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv2_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fuv1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_2_suep, by = "psn", all.y = T)
dat_raw_suep <- left_join(dat_raw_suep, dat_eward_suep, by = "psn")

#remove unnecessary variables
dat_raw_suep <- dat_raw_suep %>% 
  select(-vis_label.x,
         -vis_label.y,
         -hsptl,
         -p_inclusion,
         -unit_albumin,
         -unit_crp,
         -unit_ferritin,
         -unit_pct,
         -unit_dimer,
         -unit_wbc_abs,
         -unit_lympho_abs,
         -unit_neutro_abs,
         -unit_platelet_abs,
         -unit_urea,
         -unit_creatinine,
         -unit_ldh,
         -d_hsptl,
         -d_baseline,
         -height) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

dat_raw_suep <- dat_raw_suep %>% 
  mutate(
    # Combine two variables (e.g., consciousness & gcs) into one (confusiion_gcs15)
    impaired_consciousness = ifelse(gcs == 15, 'no', 'yes')
  ) %>% 
  # Remove the two replaced variables: concisousness & gcs
  select(-c(consciousness, gcs)) %>% 
  # Reorder all variables
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())
```

```{r merge dat_raw_hap & dat_raw_suep}
#remove comorbidity variables out of HAP, which are not sufficiently present in SUEP
dat_raw_hap <- subset(dat_raw_hap, select = -c(comor_dm, comor_chronic_neuro, comor_dementia, comor_tumor_or_cancer, comor_rheuma_immuno, comor_hiv_aids))

#remove those missing for 'icu_7d'
dat <- rbind(dat_raw_hap, dat_raw_suep) %>%
  mutate(icu_7d = if_else(is.na(icu_7d), 'missing', icu_7d)) %>%
  filter(!icu_7d %in% 'missing') %>% 
  # Recode variables
  mutate(
    icu_7d = ifelse(icu_7d == 'yes', 1, 0),
    o2_supplement = ifelse(o2_supplement == 'ambient air', 0, 1), #1: with oxygen supplement
    impaired_consciousness = ifelse(impaired_consciousness == 'no', 0, 1), #no/0: unimpaired; 1: impaired
    obesity = ifelse(obesity == 'no', 0, 1) #1: yes
    ) 

#create the variable 'num_comor'
dat$num_comor <- rowSums(
  select(dat, obesity:comor_chronic_liver))

# Reorder the variables
   dat <- dat %>% 
     select(ptcenter, age, sex, o2_supplement, impaired_consciousness, obesity, comor_cvd, comor_chronic_lung, comor_ckd, comor_chronic_liver, comor_chronic_lung_no_asthma, num_comor, everything())

# Convert character variables to factors
dat <- convert_to_factor(dat, c('icu_7d',
                                'sex', 
                                'o2_supplement', 
                                'impaired_consciousness',
                                'obesity',
                                'comor_cvd',
                                'comor_chronic_lung',
                                'comor_ckd',
                                'comor_chronic_liver',
                                'comor_chronic_lung_no_asthma'
                                )
                        )

#check fop duplicated rows
duplicated_rows <- dat[duplicated(dat), ]#No duplicated rows found

#check for range of age
age_range <- summary(dat$age)#all above 18
```

```{r table1 for merged dataset stratified by outcome, eval = FALSE, echo = FALSE}
#description of combined dataset with missingness
dat_with_missing_outcome <- rbind(dat_raw_hap, dat_raw_suep)#data merge
dat_with_missing_outcome$obesity <- ifelse(dat_with_missing_outcome$obesity == 'no', 0, 1)#recode variables
dat_with_missing_outcome$num_comor <- rowSums(
  select(dat_with_missing_outcome, obesity:comor_chronic_liver))#create the variable 'num_comor'
dat_with_missing_outcome <- convert_to_factor(dat_with_missing_outcome, # Convert character variables to factors
                                              c('icu_7d',
                                                'sex', 
                                                'o2_supplement', 
                                                'impaired_consciousness',
                                                'obesity',
                                                'comor_cvd',
                                                'comor_chronic_lung',
                                                'comor_ckd',
                                                'comor_chronic_liver',
                                                'comor_chronic_lung_no_asthma'
                                                )
                                              )
summary(dat_with_missing_outcome)

#description of the three subgroups of the outcome
dat_with_missing_outcome <- dat_with_missing_outcome %>% 
  mutate(icu_7d = if_else(
    is.na(icu_7d), 'missing', icu_7d
  ))

##subgroup 1: admitted into ICU
dat_icu_7d_yes <- dat_with_missing_outcome %>% 
  filter(icu_7d == 'yes')
summary(dat_icu_7d_yes)

##subgroup 1: not admitted into ICU
dat_icu_7d_no <- dat_with_missing_outcome %>% 
  filter(icu_7d == 'no')
summary(dat_icu_7d_no)

##subgroup 1: missing for ICU admission
dat_icu_7d_na <- dat_with_missing_outcome %>% 
  filter(icu_7d == 'missing')
summary(dat_icu_7d_na)
```

```{r split merged data by south of Düsseldorf}
#separate north and south datasets
north_cities <- c('Hamburg', 'Berlin', 'Hannover', 'Dashti', 'Duisburg', 'Greifswald', 'Essen', 'Dortmund', 'Oldenburg', 'Flensburg', 'Bielefeld', 'Kiel', 'Magdeburg', 'Bochum', 'Düsseldorf', 'Göttingen', 'Münster', 'Aachen', 'Leipzig')

dat_north <- dat %>% 
  filter(str_detect(ptcenter, paste(north_cities , collapse = "|")))

dat_south <- dat %>% 
  filter(!str_detect(ptcenter, paste(north_cities , collapse = "|")))

#rename the two datasets:
der_dat <- dat_north #der_dat: data of derivation cohort
val_dat <- dat_south #val_dat: data of validation cohort
```

#3. Model development & internal validation
```{r derivation data: sample size estimate for model development, eval = FALSE, echo = FALSE}
# step 1, 2, and 3:
der_sampsize <- pmsampsize(type = "b", cstatistic = 0.76, parameters = 10, prevalence = 0.30)

# step 2:
link_text <- "Step 2 of sample size estimate"
link_url <- "https://mvansmeden.shinyapps.io/BeyondEPV/"
paste("[", link_text, "](", link_url, ")")

# Number of candidate predictors: 12
# Events fraction: 0.30
# Criterion value rMPSE: 0.05
# Sample size yielded: 980
```

```{r derivation data: all labs included}
der_dat_full_labs <- der_dat

#missing pattern
missing_patterns_der_val_full_labs <- aggr(der_dat_full_labs)
missingness <- colMeans(is.na(der_dat_full_labs)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

#select & reorder the selected variables
der_dat_full_labs <- der_dat_full_labs %>% 
  select(
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  lympho_abs, 
  neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
der_dat_full_labs_plausible <- der_dat_full_labs %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
if(FALSE){preproc_params <- preProcess(der_dat_plausible, method = c("center", "scale"))
der_dat_full_plausible_scaled <- predict(preproc_params, newdata = der_dat_full_plausible)}

# Check if scaling was performed
if (exists("der_dat_full_labs_plausible_scaled")) {
  dat_imp<- der_dat_full_labs_plausible_scaled
} else {
  dat_imp <- der_dat_full_labs_plausible
}

#multiple imputation
set.seed(123)

der_dat_full_labs_plausible_imputed <- mice(data = dat_imp, m = 10, maxit = 10, printFlag = FALSE)
summary(der_dat_full_labs_plausible_imputed)

completed_der_dat_full_labs_plausible <- lapply(1:10, function(i) complete(der_dat_full_labs_plausible_imputed, i))# Extract the completed datasets

mice::densityplot(der_dat_full_labs_plausible_imputed)# Visualization of the distribution of the imputed variables

der_dat_full_labs_plausible_stacked <- do.call(rbind, completed_der_dat_full_labs_plausible) # Stack the 10 imputed datasets

der_dat_full_labs_plausible_stacked <- der_dat_full_labs_plausible_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

#winsorization of the data
cols_to_transform <- setdiff(names(der_dat_full_labs_plausible_stacked), c( 
                                                     'ptcenter',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
der_dat_full_labs_plausible_stacked_winso <- winso_df(der_dat_full_labs_plausible_stacked, cols_to_transform)

der_dat_full_labs_final <- der_dat_full_labs_plausible_stacked_winso
```

```{r derivation data: labs included}
der_dat_full <- der_dat

#missing pattern
missing_patterns_der_dat_full <- aggr(der_dat_full)
missingness <- colMeans(is.na(der_dat_full)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

#select & reorder the selected variables
der_dat_full <- der_dat_full %>% 
  select(
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#select out outliers
der_dat_full_plausible <- der_dat_full %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
        )

#multiple imputation
set.seed(123)

if(exists('der_dat_full_plausible_scaled')){
  dat_imp <- der_dat_full_plausible_scaled
} else {
  dat_imp <- der_dat_full_plausible
}

der_dat_full_plausible_scaled_imputed <- mice(data = dat_imp, m = 10, maxit = 5, printFlag = FALSE)
summary(der_dat_full_plausible_scaled_imputed)

#Check-ups after MI
#xyplot(der_dat_full_plausible_scaled_imputed, icu_7d ~ rr + impaired_consciousness + o2_supplement)#inspecting the original and imputed data
#densityplot(der_dat_full_plausible_scaled_imputed)
#stripplot(der_dat_full_plausible_scaled_imputed, pch = 29, cex = 1.2)
#plot(der_dat_full_plausible_scaled_imputed)#check if convergence was achieved

completed_der_dat_full_plausible_scaled <- lapply(1:10, function(i) complete(der_dat_full_plausible_scaled_imputed, i))# Extract the completed datasets
mice::densityplot(der_dat_full_plausible_scaled_imputed)# Visualization of the distribution of the imputed variables
der_dat_full_plausible_scaled_stacked <- do.call(rbind, completed_der_dat_full_plausible_scaled) # Stack the 10 imputed datasets
der_dat_full_plausible_scaled_stacked <- der_dat_full_plausible_scaled_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

#data winsorization 
cols_to_transform <- setdiff(names(der_dat_full_plausible_scaled_stacked), 
                             c('ptcenter',
                               'icu_7d',
                               'sex', 
                               'o2_supplement', 
                               'impaired_consciousness',
                               'obesity',
                               'comor_cvd',
                               'comor_chronic_lung',
                               'comor_ckd',
                               'comor_chronic_liver',
                               'comor_chronic_lung_no_asthma'
                              )
                             )
der_dat_full_plausible_scaled_stacked_winso <- winso_df(der_dat_full_plausible_scaled_stacked, cols_to_transform)

#final derivation dataset
der_dat_full_final <- der_dat_full_plausible_scaled_stacked_winso
```

```{r derivation data: missing pattern}
missing_patterns_der_dat <- aggr(der_dat)

missingness <- colMeans(is.na(der_dat)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

#select & reorder the selected variables
der_dat <- der_dat %>% 
  select(
  ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )
```

```{r derivation data: remove outliers based on range defined by clinicians}
der_dat_plausible <- der_dat %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )
```

```{r derivation data: standardization of continuous variables}
#select out continuous predictors only
der_dat_plausible_standardization <- der_dat_plausible %>% 
  select(-c(ptcenter,
            icu_7d,
            sex,
            o2_supplement,
            impaired_consciousness,
            obesity,
            comor_cvd,
            comor_chronic_lung,
            comor_ckd,
            comor_chronic_liver,
            comor_chronic_lung_no_asthma))

# Compute the transformation parameters 
preproc_params <- preProcess(der_dat_plausible_standardization, method = c("center", "scale"))

# Apply the same transformation to the derivation data
der_dat_plausible_scaled <- predict(preproc_params, newdata = der_dat_plausible)
```

```{r derivation data: multiple imputation}
set.seed(123)
der_dat_plausible_scaled_imputed <- mice(data = der_dat_plausible_scaled, m = 10, maxit = 10, printFlag = FALSE)
mice::densityplot(der_dat_plausible_scaled_imputed)# Visualization of the distribution of the imputed continuous variables
summary(der_dat_plausible_scaled_imputed)

#Check-ups after MI
#xyplot(der_dat_plausible_scaled_imputed, icu_7d ~ rr + o2_supplement + impaired_consciousness)#inspecting the original and imputed data
#densityplot(der_dat_plausible_scaled_imputed)
#stripplot(der_dat_plausible_scaled_imputed, pch = 29, cex = 1.2)
#plot(der_dat_plausible_scaled_imputed)#check if convergence was achieved

#create the stacked dataset
completed_der_dat_plausible_scaled <- lapply(1:10, function(i) complete(der_dat_plausible_scaled_imputed, i))# Extract the completed datasets
der_dat_plausible_scaled_stacked <- do.call(rbind, completed_der_dat_plausible_scaled) # Stack the 10 imputed datasets
der_dat_plausible_scaled_stacked <- der_dat_plausible_scaled_stacked %>% 
  mutate(weight = 0.1)# Assign weights to each observation
```

```{r derivation data: winsorization of imputed dataset}
cols_to_transform <- setdiff(names(der_dat_plausible_scaled_stacked), 
                             c('ptcenter',
                               'icu_7d',
                               'sex', 
                               'o2_supplement', 
                               'impaired_consciousness',
                               'obesity',
                               'comor_cvd',
                               'comor_chronic_lung',
                               'comor_ckd',
                               'comor_chronic_liver',
                               'comor_chronic_lung_no_asthma'
                               )
                             )
der_dat_plausible_scaled_stacked_winso <- winso_df(der_dat_plausible_scaled_stacked, cols_to_transform)
```

```{r derivation data: determination of minimal set via grid search of hyperparameters, eval = FALSE, echo = FALSE}
#General steps: 1. Explore the model performance via a grid search of alpha and lamba values and store this exploration result. 2. Extract this result. 3. Reorder this result in ascending order of AUC and then calibration. 4. Save the results.

#explore model performance via a grid search: including AUC and calibration
##create the design matrix for the predictors
matrix_der <- der_dat_final
matrix_der_predictors <- matrix_der[, -1] # Exclude the response variable
design_matrix_der <- model.matrix(~ . - 1, data = matrix_der_predictors) # -1: remove the intercept
design_matrix_der <- design_matrix_der[, -1] # Remove 'o2_supplement0' that is used as the reference level for all categorical variables

##define alpha and lambda values for elastic net logistic regression
alpha_values <- seq(0, 1, length = 100)
lambda_values <- exp(seq(-10, 10, length = 100))

##initialize list to store models
models <- list()

##customize a function to calculate AUC and perform calibration analysis
evaluate_model <- function(model, design_matrix, response_variable) {
  predictions <- predict(model, newx = design_matrix, type = "response")
  auc_value <- roc(response_variable, predictions)$auc
  calibration_result <- perform_calibration_analysis(predictions[,1], response_variable)

  return(list(auc = auc_value, calibration = calibration_result))
}

##evaluate model performance via a grid search for alpha and lambda values
for (alpha in alpha_values) {
  for (lambda in lambda_values) {
      fit_optimal_der <- glmnet(
      x = design_matrix_der,
      y = matrix_der$icu_7d,
      family = "binomial",
      alpha = alpha,
      lambda = lambda,
      weights = rep(0.1, nrow(design_matrix_der))
    )

    evaluation <- evaluate_model(fit_optimal_der, design_matrix_der, matrix_der$icu_7d)#evaluate the model's performance

    models[[paste("Alpha", alpha, "Lambda", lambda)]] <- list(# Store model, evaluation results, and alpha and lambda values
      model = fit_optimal_der,
      evaluation = evaluation,
      alpha = alpha,
      lambda = lambda
    )
  }
}

#extract model and its performance
##initialize an empty data frame to store performance
performance <- data.frame(
  Model = character(),
  Alpha = numeric(),
  Lambda = numeric(),
  AUC = numeric(),
  Calibration_Slope = numeric(),
  Calibration_Intercept = numeric(),
  Num_Variables_Retained = numeric(),
  Retained_Variables = character(),
  stringsAsFactors = FALSE
)

for (name in names(models)) {
  model_info <- models[[name]]  # Get model information from the list
  evaluation <- model_info$evaluation  # Extract evaluation results
  auc_value <- evaluation$auc  # Extract AUC value
  calibration_result <- evaluation$calibration  # Extract calibration results
  coefficients <- coef(model_info$model, s = model_info$model$lambda.min)#extract coefficients from the model

##Identify the names of the variables retained
retained_variables <- colnames(design_matrix_der)[coefficients[-1] != 0]  # Exclude the intercept column

##count non-zero coefficients to determine the number of variables retained
num_variables_retained <- length(retained_variables)

##add model details to the data frame
performance <- rbind(performance, list(
  Model = name,
  Alpha = model_info$alpha,
  Lambda = model_info$lambda,
  AUC = auc_value,
  Calibration_Slope = calibration_result$slope,
  Calibration_Intercept = calibration_result$intercept,
  Num_Variables_Retained = num_variables_retained,
  Retained_Variables = paste(retained_variables, collapse = ", ")
))
}

#Sort the performance data frame by AUC, then by calibration slope, then by intercept
sorted_performance <- performance[order(performance$AUC, -as.numeric(performance$Calibration_Slope), -as.numeric(performance$Calibration_Intercept)), ]

#save the sorted results
write.csv2(sorted_performance, file = "full_10_var_final.csv", row.names = FALSE)
```

```{r derivation data: relationship between auc and number of variables retained, eval = FALSE, echo = FALSE, fig.height=4, fig.width=6}
dat_full_10 <- read.csv2("T:/Projects/NAPKON/prognostic_score/prognositic_score/RStudio/model development/Final/splines/hyperpara_tuning/With variable names/full_10_var_final.csv")

sorted_performance <- dat_full_10
columns_to_round <- 2:7
sorted_performance[, columns_to_round] <- lapply(sorted_performance[, columns_to_round], as.numeric)
sorted_performance[, columns_to_round] <- round(sorted_performance[, columns_to_round], digits = 2)

#visualize AUC_number of variables
sorted_performance %>%
  ggplot(aes(x = Num_Variables_Retained, y = AUC))+
  geom_point() +  
  geom_smooth(method = "loess", se = TRUE, color = 'grey') +
  scale_x_continuous(breaks = seq(min(sorted_performance$Num_Variables_Retained), 
                                   max(sorted_performance$Num_Variables_Retained),
                                   by = 1)) +
  ylim(0.5, 0.85) +
  labs(x = 'Number of variables retained',
       y = 'AUC') +
  theme_wx

#visualize calibration slope_number of variables
sorted_performance %>%# regression
  ggplot(aes(x = Num_Variables_Retained, y = Calibration_Slope))+
  geom_point() +  
  geom_smooth(method = "loess", se = TRUE, color = 'grey') +
  scale_x_continuous(breaks = seq(min(sorted_performance$Num_Variables_Retained), 
                                   max(sorted_performance$Num_Variables_Retained),
                                   by = 1)) +
  ylim(0, 50) +
  labs(x = 'Number of variables retained',
       y = 'Calibration slope') +
  theme_wx
```

```{r derivation data: composition of number of variables retained, eval = FALSE, echo = FALSE, fig.height=4, fig.width=6}
# Create data for the stacked bar chart
specific_vars <- data.frame(
  Num_Variables_Retained = c(1, 2, 3, 4, 5, 6, 7.1, 7.2, 8.1, 8.2, 9.1, 9.2, 10),
  o2_supplement = c(1, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
  impaired_consciousness = c(NA, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
  rr = c(NA, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
  spo2 = c(NA, NA, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
  bp_dia = c(NA, NA, NA, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1),
  temp = c(NA, NA, NA, NA, NA, 1, 1, 1, 1, 1, 1, 1, 1),
  bp_sys = c(NA, NA, NA, NA, NA, NA, NA, 1, 1, NA, 1, 1, 1),  
  sex = c(NA, NA, NA, NA, NA, NA, 1, NA, 1, 1, 1, 1, 1),
  hr = c(NA, NA, NA, NA, NA, NA, NA, NA, NA, 1, 1, NA, 1),
  age = c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1, 1)
)

# Reshape the data for plotting
specific_vars_long <- tidyr::pivot_longer(specific_vars, -Num_Variables_Retained, names_to = "Variable", values_to = "Value")

# Reorder the levels of the Variable factor to set o2_supplement at the bottom
specific_vars_long$Variable <- factor(specific_vars_long$Variable, levels = c('age', 'hr', 'bp_sys', 'sex', 'temp', 'bp_dia', "spo2", "rr", "impaired_consciousness", "o2_supplement"))

# Replace x-axis values
specific_vars_long$Num_Variables_Retained <- ifelse(specific_vars_long$Num_Variables_Retained %% 1 == 0.1,
                                                    specific_vars_long$Num_Variables_Retained - 0.1,
                                                    specific_vars_long$Num_Variables_Retained)

# Plot the modified stacked bar chart with reduced height for the bars and updated x-axis labels
ggplot(specific_vars_long, aes(x = factor(Num_Variables_Retained), y = Value, fill = Variable)) +
  geom_bar(stat = "identity", width = 0.5) +  # Adjusting the width of the bars
  scale_fill_manual(values = c("o2_supplement" = "#440154", "impaired_consciousness" = "#482878", "rr" = "#3e4989", 'spo2' = '#31688e', 'bp_dia' = '#26828e', 'temp' = '#1f9e89', 'bp_sys' = '#6ece58', 'sex' =  '#35b779','hr' = '#b5de2b', 'age' = '#fde725'),
                     labels = c("Age", 
                                "Heart rate", 
                                "Sex",
                                "Systolic blood pressure",
                                "Temperature", 
                                "Diastolic blood pressure", 
                                "Oxygen saturation", 
                                "Respiratory rate", 
                                "Confusion", 
                                "Oxygen supplementation")) +
  labs(x = "Number of variables retained", y = "Count") +
  scale_x_discrete(labels = function(x) { ifelse(x == "7.1", "7", ifelse(x == "7.2", "", as.character(x)))}) +  # Update x-axis labels
  theme_wx +
  #ylab('Variables') +
  guides(fill = guide_legend(title = "Variables")) 
```

```{r derivation data: final dataset for model development}
#create the final dataset for model development
minimal_set_variables <- c('icu_7d',
                           'o2_supplement',
                           'impaired_consciousness',
                           'rr',
                           'spo2'
                           )

der_dat_final <- der_dat_plausible_scaled_stacked_winso[minimal_set_variables]

#variables for the full model with labs
variables_full_model_with_labs <- c('icu_7d',
                                    'sex', 
                                    'o2_supplement',
                                    'impaired_consciousness',
                                    'num_comor',
                                    'age', 
                                    'hr', 
                                    'rr',
                                    'bp_sys', 
                                    'bp_dia',
                                    'temp', 
                                    'spo2',
                                    'wbc_abs',
                                    'platelet_abs',
                                    'urea',
                                    'creatinine',
                                    'crp',
                                    'ldh'
                                    )

der_dat_final_full_model_with_labs <- der_dat_plausible_scaled_stacked_winso[variables_full_model_with_labs]

# Variables for the second case
variables1 <- c('ptcenter')  
variables1 <- c(minimal_set_variables, variables1)
der_dat_final_by_region <- der_dat_plausible_scaled_stacked_winso[variables1]
```

```{r derivation data: unstandardized univariable association for 10 variables, eval = FALSE, echo = FALSE}
# Create a list to store the results
results_list <- list()

# Define the formula for logistic regression
formula <- "icu_7d ~ predictor"

# Iterate over each predictor
predictors <- c("sex", "o2_supplement", "impaired_consciousness", "age", "hr", "rr", "bp_sys", "bp_dia", "temp", "spo2")
for (predictor in predictors) {
  current_formula <- as.formula(paste("icu_7d ~", predictor))#create the formula dynamically
  model <- glm(current_formula, data = der_dat_final_full_model_with_labs, family = binomial)#fit the logistic regression model

  #extract coefficient, p-value, OR, and 95% CI
  coefficient <- coef(model)[2]
  p_value <- summary(model)$coefficients[2, 4]
  odds_ratio <- exp(coef(model)[2])
  ci_95 <- exp(confint(model)[2, ])

  #store the results in a data frame
  result <- data.frame(
    Predictor = predictor,
    Coefficient = coefficient,
    P_Value = p_value,
    Odds_Ratio = odds_ratio,
    CI_95_Lower = ci_95[1],
    CI_95_Upper = ci_95[2]
  )

  #append the result to the list
  results_list[[predictor]] <- result
}

#combine results into a single data frame
results_df <- do.call(rbind, results_list)

#print the results
print(results_df)
```

```{r derivation data: xgboost_final}
# Common set of variables
variables_full_model_with_labs <- c(
  'icu_7d',
  'sex', 
  'o2_supplement',
  'impaired_consciousness',
  'age', 
  'hr', 
  'rr',
  'bp_sys', 
  'bp_dia',
  'temp', 
  'spo2'
)

# Variables for der_dat_final
der_dat_final_importance <- der_dat_plausible_scaled_stacked_winso[, variables_full_model_with_labs]
der_dat_final_importance$sex <- ifelse(der_dat_final_importance$sex == 'female', 1, 0)
der_dat_final_importance$impaired_consciousness <- as.numeric(as.character(der_dat_final_importance$impaired_consciousness))
der_dat_final_importance$o2_supplement <- as.numeric(as.character(der_dat_final_importance$o2_supplement))

# Train an xgboost model
X <- as.matrix(der_dat_final_importance[, -1])  # Exclude the response variable
y <- as.numeric(as.character(der_dat_final_importance$icu_7d))

xgb_data <- xgb.DMatrix(data = X, label = y)
xgb_model_der <- xgboost(data = xgb_data, nrounds = 10, objective = "binary:logistic")

predictions <- predict(xgb_model_der, xgb_data)# Make predictions
roc_obj <- roc(y, predictions)# Calculate AUC

importance_matrix <- xgb.importance(model = xgb_model_der)#The method used to extract feature importance from the XGBoost model is the "Gain" metric. 
print(importance_matrix)
```

```{r derivation data: specification of the simplified cross model}
#find the maximized Youden's index for 'rr' and 'spo2
roc_rr <- roc(der_dat_final$icu_7d, der_dat_final$rr)#calculate the ROC curve
optimal_cutoff <- coords(roc_rr, "best", ret = "threshold", transpose = TRUE)#find the maximized Youden's index
corresponding_rr_value <- der_dat_final$rr[which.min(abs(der_dat_final$rr - optimal_cutoff))]#find the corresponding 'rr' at maximized Youden's index
print(paste("Corresponding 'rr' value for the optimal cut-off value:", corresponding_rr_value))

roc_spo2 <- roc(der_dat_final$icu_7d, der_dat_final$spo2)# Calculate the ROC curve
optimal_cutoff <- coords(roc_spo2, "best", ret = "threshold", transpose = TRUE)#find the maximized Youden's index
corresponding_spo2_value <- der_dat_final$spo2[which.min(abs(der_dat_final$spo2 - optimal_cutoff))]#find the corresponding 'spo2' at maximized Youden's index
print(paste("Corresponding 'spo2' value for the optimal cut-off value:", corresponding_spo2_value))

#dichotomization of 
der_dat_risk_score <- data.frame(
  icu_7d = der_dat_final_full_model_with_labs$icu_7d,
  o2_supplement = der_dat_final_full_model_with_labs$o2_supplement,
  impaired_consciousness = der_dat_final_full_model_with_labs$impaired_consciousness,
  rr = ifelse(der_dat_final_full_model_with_labs$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(der_dat_final_full_model_with_labs$spo2 <= corresponding_spo2_value, 1, 0)
)

#create the design matrix
matrix_der_risk_score <- der_dat_risk_score
matrix_der_predictors_risk_score <- matrix_der_risk_score[, -1]# Exclude the response variable
design_matrix_der_risk_score <- model.matrix(~ . - 1, data = matrix_der_predictors_risk_score) #-1: remove the intercept
design_matrix_der_risk_score <- design_matrix_der_risk_score[, -1] #remove 'o2_supplement0' that is used as the reference level for all categorical variables

set.seed(123)

# Define the control parameters for training
train_control <- trainControl(
  method = "repeatedcv",#Specifies the resampling method
  number = 5,#The number of resampling iterations or folds
  repeats = 5,#the repeated cross-validation process will be repeated 5 times to ensure the stability of the performance estimates
  search = "random",#This parameter is used when you want to perform hyperparameter tuning. It specifies that a random search will be conducted to find optimal hyperparameters. 
  verboseIter = FALSE#Controls whether to display verbose output
)

# Fit an elastic net model using caret's train() function
if (exists('matrix_der_risk_score')) {
  elastic_net_model_risk_score <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
} else if (exists('rcs_matrix_der')) {
  elastic_net_model <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = rcs_matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    #preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
}


final_alpha <- elastic_net_model_risk_score$bestTune$alpha
final_lambda <- elastic_net_model_risk_score$bestTune$lambda

# Fit the final logistic regression model with optimal alpha and lambda
if (exists('matrix_der_risk_score')) {
  fit_optimal_der_risk_score <- glmnet(
  x = design_matrix_der_risk_score,
  y = matrix_der_risk_score$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der_risk_score))
  )
} else if (exists('rcs_matrix_der')) {
  fit_optimal_der <- glmnet(
  x = design_matrix_der,
  y = rcs_matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der))
  )
}

coef(fit_optimal_der_risk_score)# View the coefficients or perform further analysis with the final_model
```

```{r derivation data: specification of the simplified model with five predictors, echo = FALSE, eval = FALSE}
roc_rr <- roc(der_dat_final$icu_7d, der_dat_final$rr)#calculate the ROC curve
optimal_cutoff <- coords(roc_rr, "best", ret = "threshold", transpose = TRUE)#find the maximized Youden's index
corresponding_rr_value <- der_dat_final$rr[which.min(abs(der_dat_final$rr - optimal_cutoff))]#find the corresponding 'rr' at the maximized Youden's index
print(paste("Corresponding 'rr' value for the optimal cut-off value:", corresponding_rr_value))

roc_spo2 <- roc(der_dat_final$icu_7d, der_dat_final$spo2)
optimal_cutoff <- coords(roc_spo2, "best", ret = "threshold", transpose = TRUE)
corresponding_spo2_value <- der_dat_final$spo2[which.min(abs(der_dat_final$spo2 - optimal_cutoff))]
print(paste("Corresponding 'spo2' value for the optimal cut-off value:", corresponding_spo2_value))

roc_bp_dia <- roc(der_dat_final_full_model_with_labs$icu_7d, der_dat_final_full_model_with_labs$bp_dia)
optimal_cutoff <- coords(roc_bp_dia, "best", ret = "threshold", transpose = TRUE)
corresponding_bp_dia_value <- der_dat_final_full_model_with_labs$bp_dia[which.min(abs(der_dat_final_full_model_with_labs$bp_dia - optimal_cutoff))] 
print(paste("Corresponding 'bp_dia' value for the optimal cut-off value:", corresponding_bp_dia_value))

der_dat_risk_score <- data.frame(
  icu_7d = der_dat_final_full_model_with_labs$icu_7d,
  o2_supplement = der_dat_final_full_model_with_labs$o2_supplement,
  impaired_consciousness = der_dat_final_full_model_with_labs$impaired_consciousness,
  rr = ifelse(der_dat_final_full_model_with_labs$rr >= corresponding_rr_value, 1, 0),
  spo2 = ifelse(der_dat_final_full_model_with_labs$spo2 < corresponding_spo2_value, 1, 0),
  bp_dia = ifelse(der_dat_final_full_model_with_labs$bp_dia < corresponding_bp_dia_value, 1, 0)
)

#create the design matrix
matrix_der_risk_score <- der_dat_risk_score
matrix_der_predictors_risk_score <- matrix_der_risk_score[, -1]# Exclude the response variable
design_matrix_der_risk_score <- model.matrix(~ . - 1, data = matrix_der_predictors_risk_score) #-1: remove the intercept
design_matrix_der_risk_score <- design_matrix_der_risk_score[, -1] #remove 'o2_supplement0' that is used as the reference level for all categorical variables

set.seed(123)

# Define the control parameters for training
train_control <- trainControl(
  method = "repeatedcv",#Specifies the resampling method
  number = 5,#The number of resampling iterations or folds
  repeats = 5,#the repeated cross-validation process will be repeated 5 times to ensure the stability of the performance estimates
  search = "random",#This parameter is used when you want to perform hyperparameter tuning. It specifies that a random search will be conducted to find optimal hyperparameters. 
  verboseIter = FALSE#Controls whether to display verbose output
)

# Fit an elastic net model using caret's train() function
if (exists('matrix_der_risk_score')) {
  elastic_net_model_risk_score <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
} else if (exists('rcs_matrix_der')) {
  elastic_net_model <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = rcs_matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    #preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
}

final_alpha <- elastic_net_model_risk_score$bestTune$alpha
final_lambda <- elastic_net_model_risk_score$bestTune$lambda

# Fit the final logistic regression model with optimal alpha and lambda
if (exists('matrix_der_risk_score')) {
  fit_optimal_der_risk_score <- glmnet(
  x = design_matrix_der_risk_score,
  y = matrix_der_risk_score$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der_risk_score))
  )
} else if (exists('rcs_matrix_der')) {
  fit_optimal_der <- glmnet(
  x = design_matrix_der,
  y = rcs_matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der))
  )
}

coef(fit_optimal_der_risk_score)# View the coefficients or perform further analysis with the final_model
```

```{r derivation data: specification of the simplified model with six predictors,  echo = FALSE, eval = FALSE}
roc_rr <- roc(der_dat_final$icu_7d, der_dat_final$rr)# Calculate the ROC curve
optimal_cutoff <- coords(roc_rr, "best", ret = "threshold", transpose = TRUE)# Find the optimal cut-off value that maximizes sensitivity + specificity - 1
corresponding_rr_value <- der_dat_final$rr[which.min(abs(der_dat_final$rr - optimal_cutoff))]# Find the corresponding 'rr' value at the optimal cut-off point
print(paste("Corresponding 'rr' value for the optimal cut-off value:", corresponding_rr_value))# Print the corresponding 'rr' value

roc_spo2 <- roc(der_dat_final$icu_7d, der_dat_final$spo2)# Calculate the ROC curve
optimal_cutoff <- coords(roc_spo2, "best", ret = "threshold", transpose = TRUE)
corresponding_spo2_value <- der_dat_final$spo2[which.min(abs(der_dat_final$spo2 - optimal_cutoff))]
print(paste("Corresponding 'spo2' value for the optimal cut-off value:", corresponding_spo2_value))

roc_bp_dia <- roc(der_dat_final_full_model_with_labs$icu_7d, der_dat_final_full_model_with_labs$bp_dia)
optimal_cutoff <- coords(roc_bp_dia, "best", ret = "threshold", transpose = TRUE)
corresponding_bp_dia_value <- der_dat_final_full_model_with_labs$bp_dia[which.min(abs(der_dat_final_full_model_with_labs$bp_dia - optimal_cutoff))]
print(paste("Corresponding 'bp_dia' value for the optimal cut-off value:", corresponding_bp_dia_value))

roc_temp <- roc(der_dat_final_full_model_with_labs$icu_7d, der_dat_final_full_model_with_labs$temp)
optimal_cutoff <- coords(roc_temp, "best", ret = "threshold", transpose = TRUE)
corresponding_temp_value <- der_dat_final_full_model_with_labs$temp[which.min(abs(der_dat_final_full_model_with_labs$temp - optimal_cutoff))]
print(paste("Corresponding 'temp' value for the optimal cut-off value:", corresponding_temp_value))

dat_risk_score <- data.frame(
  icu_7d = der_dat_final_full_model_with_labs$icu_7d,
  o2_supplement = der_dat_final_full_model_with_labs$o2_supplement,
  impaired_consciousness = der_dat_final_full_model_with_labs$impaired_consciousness,
  rr = ifelse(der_dat_final_full_model_with_labs$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(der_dat_final_full_model_with_labs$spo2 < corresponding_spo2_value, 1, 0),
  bp_dia = ifelse(der_dat_final_full_model_with_labs$bp_dia < corresponding_bp_dia_value, 1, 0),
  temp = ifelse(der_dat_final_full_model_with_labs$temp < corresponding_temp_value, 1, 0)
)

#create the design matrix
matrix_der_risk_score <- dat_risk_score
matrix_der_predictors_risk_score <- matrix_der_risk_score[, -1]# Exclude the response variable
design_matrix_der_risk_score <- model.matrix(~ . - 1, data = matrix_der_predictors_risk_score) #-1: remove the intercept
design_matrix_der_risk_score <- design_matrix_der_risk_score[, -1] #remove 'o2_supplement0' that is used as the reference level for all categorical variables

set.seed(123)

# Define the control parameters for training
train_control <- trainControl(
  method = "repeatedcv",#Specifies the resampling method
  number = 5,#The number of resampling iterations or folds
  repeats = 5,#the repeated cross-validation process will be repeated 5 times to ensure the stability of the performance estimates
  search = "random",#This parameter is used when you want to perform hyperparameter tuning. It specifies that a random search will be conducted to find optimal hyperparameters. 
  verboseIter = FALSE#Controls whether to display verbose output
)

# Fit an elastic net model using caret's train() function
if (exists('matrix_der_risk_score')) {
  elastic_net_model_risk_score <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
} else if (exists('rcs_matrix_der')) {
  elastic_net_model <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = rcs_matrix_der_risk_score,
    method = "glmnet", # Indicate this is an elastic net model
    #preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
}

final_alpha <- elastic_net_model_risk_score$bestTune$alpha
final_lambda <- elastic_net_model_risk_score$bestTune$lambda

# Fit the final logistic regression model with optimal alpha and lambda
if (exists('matrix_der_risk_score')) {
  fit_optimal_der_risk_score <- glmnet(
  x = design_matrix_der_risk_score,
  y = matrix_der_risk_score$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der_risk_score))
  )
} else if (exists('rcs_matrix_der')) {
  fit_optimal_der <- glmnet(
  x = design_matrix_der,
  y = rcs_matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der))
  )
}

coef(fit_optimal_der_risk_score)# View the coefficients or perform further analysis with the final_model
```

```{r derivation data: cross model, fig.width=15, fig.height=9}
continuous_vars <- c('rr',
                     'spo2'
                     )

rcs_terms_der <- lapply(continuous_vars, function(var) rcs(der_dat_final[[var]], 4))

# Combine the RCS terms into the design matrix
rcs_matrix_der <- cbind(
  der_dat_final[c('icu_7d', 
                  'o2_supplement',
                  'impaired_consciousness'
                  )],  
  do.call(cbind, rcs_terms_der)
)

column_names <- c('icu_7d', # Rename the columns of the resulting data frame
                  'o2_supplement', 
                  'impaired_consciousness',
                  sapply(continuous_vars, function(var) paste(var, c("k1", "k2", "k3"), sep = "_"))
                  )

colnames(rcs_matrix_der) <- column_names

# Create a design matrix with factors preserved
rcs_matrix_der_predictors <- rcs_matrix_der[, -1]# Exclude the response variable
design_matrix_der <- model.matrix(~ . - 1, data = rcs_matrix_der_predictors) #-1: remove the intercept
design_matrix_der <- design_matrix_der[, -1] #remove 'o2_supplement0' that is used as the reference level for all categorical variables






set.seed(123)

# Define the control parameters for training
train_control <- trainControl(
  method = "repeatedcv",#Specifies the resampling method
  number = 5,#The number of resampling iterations or folds
  repeats = 5,#the repeated cross-validation process will be repeated 5 times to ensure the stability of the performance estimates
  search = "random",#This parameter is used when you want to perform hyperparameter tuning. It specifies that a random search will be conducted to find optimal hyperparameters. 
  verboseIter = FALSE#Controls whether to display verbose output
)

# Fit an elastic net model using caret's train() function
if (exists('matrix_der')) {
  elastic_net_model <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = matrix_der,
    method = "glmnet", # Indicate this is an elastic net model
    preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
} else if (exists('rcs_matrix_der')) {
  elastic_net_model <- train(
    icu_7d ~ .,  # Response variable and predictors
    data = rcs_matrix_der,
    method = "glmnet", # Indicate this is an elastic net model
    #preProcess = c("center", "scale"),
    tuneLength = 25, # Number of combinations of hyperparameters to consider during tuning
    trControl = train_control
  )
}


final_alpha <- elastic_net_model$bestTune$alpha
final_lambda <- elastic_net_model$bestTune$lambda

# Fit the final logistic regression model with optimal alpha and lambda
if (exists('matrix_der')) {
  fit_optimal_der <- glmnet(
  x = design_matrix_der,
  y = matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der))
  )
} else if (exists('rcs_matrix_der')) {
  fit_optimal_der <- glmnet(
  x = design_matrix_der,
  y = rcs_matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = final_lambda,
  weights = rep(0.1, nrow(design_matrix_der))
  )
}

coef(fit_optimal_der)# View the coefficients or perform further analysis with the final_model

#create the elastic net coefficient profiles plot of the variables
lambda_seq <- exp(seq(-20, 20, length = 100))# Create a wider sequence of lambda values

if (exists('matrix_der')) {
  fit_optimal_der_coeff <- glmnet(# Fit the glmnet model with the extended lambda sequence
  x = design_matrix_der,
  y = matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = lambda_seq
  )
} else if (exists('rcs_matrix_der')) {
  fit_optimal_der_coeff <- glmnet(# Fit the glmnet model with the extended lambda sequence
  x = design_matrix_der,
  y = rcs_matrix_der$icu_7d,
  family = "binomial",
  alpha = final_alpha,
  lambda = lambda_seq
  )
}

plot(fit_optimal_der_coeff, xvar = "lambda", label = TRUE)# Plot the coefficients vs. log(lambda)

legend("topright", legend = colnames(design_matrix_der), col = 1:ncol(design_matrix_der), lty = 1)# Add labels and a legend

#create cross-validation plot for the penalty term
x <- design_matrix_der

if (exists('matrix_der')) {
  y <- matrix_der$icu_7d
} else if (exists('rcs_matrix_der')) {
  y <- rcs_matrix_der$icu_7d
}

lambda_seq <- 10^seq(10, -10, length = 100)# Create a sequence of lambda values to test

y <- as.numeric(as.character(y))# Assuming y is a factor, convert it to numeric

cv_model <- cv.glmnet(x, y, alpha = final_alpha, lambda = lambda_seq)# perform cross-validation

plot(cv_model)# Plot cross-validation results
```

```{r derivation data: univariable models for spo2, o2 supplement and ldh, echo = FALSE, eval = FALSE}
# Model 1: spo2 and icu_7d
model_spo2 <- glm(icu_7d ~ spo2, data = der_dat_final, family = binomial)

# Model 2: o2_supplement and icu_7d
model_o2_supplement <- glm(icu_7d ~ o2_supplement, data = der_dat_final, family = binomial)

# Model 3: ldh and icu_7d
model_ldh <- glm(icu_7d ~ ldh, data = der_dat_plausible_scaled_stacked_winso, family = binomial)
```

```{r derivation data: discrimination, fig.width=6, fig.height=6}
# Model ABC
der_pred_abc <- predict(fit_optimal_der, design_matrix_der, type = "response")
der_obs_abc <- rcs_matrix_der$icu_7d
der_roc_abc <- roc(der_obs_abc, der_pred_abc, smooth = T)

# 4C mortality score
der_dat_4c_mortality <- der_dat_full_labs_final %>% #create the data frame
  select(age, 
         sex,
         num_comor,
         rr,
         spo2,
         impaired_consciousness,
         urea,
         crp,
         icu_7d)

der_dat_4c_mortality <- der_dat_4c_mortality %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 2,
    age >= 60 & age <= 69 ~ 4,
    age >= 70 & age <= 79 ~ 6,
    age >= 80 ~ 7
  ), 
  score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
  score_num_comor = case_when(
    num_comor == 0 ~ 0,
    num_comor == 1 ~ 1,
    num_comor >= 2 ~ 2
  ),
  score_rr = case_when(
    rr < 20 ~ 0,
    rr >= 20 & rr <= 29 ~ 1,
    rr >= 30 ~ 2
  ),
  score_spo2 = case_when(
    spo2 >= 92 ~ 0,
    spo2 < 92 ~ 2
  ),
  score_impaired_consciousness = case_when(
    impaired_consciousness == '0' ~ 0,
    impaired_consciousness == '1' ~ 1
  ),
  score_urea = case_when(
    urea < 7 ~ 0,
    urea >= 7 & urea <= 14 ~ 1,
    urea > 14 ~ 3
  ),
  score_crp = case_when(
    crp < 50 ~ 0,
    crp >= 50 & crp < 100 ~ 1,
    crp >= 100 ~ 2
  )
  )

der_dat_4c_mortality <- der_dat_4c_mortality %>%
  mutate(der_score_4c_mortality = rowSums(select(., score_age:score_crp))) 

mod_4c_mortality <- glm(icu_7d ~ der_score_4c_mortality, data = der_dat_4c_mortality, family = binomial)# Fit a logistic regression model
der_pred_4c_mortality <- predict(mod_4c_mortality, type = "response")# Predict probabilities for the same data
der_obs_4c_mortality <- der_dat_4c_mortality$icu_7d
der_roc_4c_mortality <- roc(der_obs_4c_mortality, der_pred_4c_mortality)# Calculate the ROC curve

# NEWS score
der_dat_news <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         bp_sys,
         hr,
         temp,
         icu_7d)

der_dat_news <- der_dat_news %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr >= 12 & rr <= 20 ~ 0,
    rr >= 9 & rr <= 11 ~ 1,
    rr >= 21 & rr <= 24 ~ 2,
    rr >= 25 | rr <= 8 ~ 3
  ),
    score_spo2 = case_when(
    spo2 >= 96 ~ 0,
    spo2 >= 94 & spo2 <= 95 ~ 1,
    spo2 >= 92 & spo2 <= 93 ~ 2,
    spo2 <= 91 ~ 3
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_temp = case_when(
    temp >= 36.1 & temp <= 38.0 ~ 0,
    (temp >= 35.1 & temp <= 36) | (temp >= 38.1 & temp <= 39) ~ 1,
    temp >= 39.1 ~ 2,
    temp <= 35.0 ~ 3
  ),
    score_bp_sys = case_when(
    bp_sys >= 111 & bp_sys <= 219 ~ 0,
    bp_sys >= 101 & bp_sys <= 110 ~ 1,
    bp_sys >= 91 & bp_sys <= 100 ~ 2,
    bp_sys >= 220 | bp_sys <= 90 ~ 3
  ),
    score_hr = case_when(
    hr >= 51 & hr <= 90 ~ 0,
    (hr >= 41 & hr <= 50) | (hr >= 91 & hr <= 110) ~ 1,
    hr >= 111 & hr <= 130 ~ 2,
    hr >= 131 | hr <= 40 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

der_dat_news <- der_dat_news %>%
  mutate(der_score_news = rowSums(select(., score_rr:score_consciousness))) 

mod_news <- glm(icu_7d ~ der_score_news, data = der_dat_news, family = binomial)# Fit a logistic regression model
der_pred_news <- predict(mod_news, type = "response")# Predict probabilities for the same data
der_obs_news <- der_dat_news$icu_7d
der_roc_news <- roc(der_obs_news, der_pred_news)# Calculate the ROC curve

#CURB-65 score
der_dat_curb65 <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(impaired_consciousness,
         urea,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

der_dat_curb65 <- der_dat_curb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

der_dat_curb65 <- der_dat_curb65 %>%
  mutate(der_score_curb65 = rowSums(select(., score_consciousness:score_age))) 

mod_curb65 <- glm(icu_7d ~ der_score_curb65, data = der_dat_curb65, family = binomial)# Fit a logistic regression model
der_pred_curb65 <- predict(mod_curb65, type = "response")# Predict probabilities for the same data
der_obs_curb65 <- der_dat_curb65$icu_7d
der_roc_curb65 <- roc(der_obs_curb65, der_pred_curb65)# Calculate the ROC curve

#CRB-65
der_dat_crb65 <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

der_dat_crb65 <- der_dat_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

der_dat_crb65 <- der_dat_crb65 %>%
  mutate(der_score_crb65 = rowSums(select(., score_consciousness:score_age))) 

mod_crb65 <- glm(icu_7d ~ der_score_crb65, data = der_dat_crb65, family = binomial)# Fit a logistic regression model
der_pred_crb65 <- predict(mod_crb65, type = "response")# Predict probabilities for the same data
der_obs_crb65 <- der_dat_crb65$icu_7d
der_roc_crb65 <- roc(der_obs_crb65, der_pred_crb65)# Calculate the ROC curve

#A-DROP
der_dat_a_drop <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(impaired_consciousness,
         urea,
         bp_sys,
         age,
         sex,
         spo2,
         icu_7d)

der_dat_a_drop <- der_dat_a_drop %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_spo2 = case_when(
    spo2 <= 90 ~ 1,
    spo2 > 90 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 90 ~ 1,
    bp_sys > 90 ~ 0
  ),
    score_age = case_when(
    (age >= 70 & sex ==  'male') | (age >= 75 & sex ==  'female') ~ 1,
    (age < 70 & sex ==  'male') | (age < 75 & sex ==  'female') ~ 0
  )
  )

der_dat_a_drop <- der_dat_a_drop %>%
  mutate(der_score_a_drop = rowSums(select(., score_consciousness:score_age))) 

mod_a_drop <- glm(icu_7d ~ der_score_a_drop, data = der_dat_a_drop, family = binomial)# Fit a logistic regression model
der_pred_a_drop <- predict(mod_a_drop, type = "response")# Predict probabilities for the same data
der_obs_a_drop <- der_dat_a_drop$icu_7d
der_roc_a_drop <- roc(der_obs_a_drop, der_pred_a_drop)

#DS CRB-65
der_dat_ds_crb65 <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         spo2,
         num_comor,
         icu_7d)

der_dat_ds_crb65 <- der_dat_ds_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  ),
    score_spo2 = case_when(
    spo2 >= 90 ~ 0,
    spo2 < 90 ~ 1
  ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  )
  )

der_dat_ds_crb65 <- der_dat_ds_crb65 %>%
  mutate(der_score_ds_crb65 = rowSums(select(., score_consciousness:score_num_comor))) 

mod_ds_crb65 <- glm(icu_7d ~ der_score_ds_crb65, data = der_dat_ds_crb65, family = binomial)# Fit a logistic regression model
der_pred_ds_crb65 <- predict(mod_ds_crb65, type = "response")# Predict probabilities for the same data
der_obs_ds_crb65 <- der_dat_ds_crb65$icu_7d
der_roc_ds_crb65 <- roc(der_obs_ds_crb65, der_pred_ds_crb65)# Calculate the ROC curve

#DL-death 
coef_age <- log(1.01) # Existing logistic regression model coefficients
coef_sex <- log(0.45)
coef_neutro_abs <- log(1.25)#unit: 10^9/L
coef_lympho_abs <- log(0.27)#unit: 10^9/L
coef_platelet_abs <- log(0.99)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1) #unit: μmol/L
#intercept <- 4.203

der_dat_full_labs_final_sex <- der_dat_full_labs_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
der_dat_full_labs_final_sex$sex <- ifelse(der_dat_full_labs_final$sex == "Male", 1, 0)
der_pred_dl_death <- plogis(coef_age * der_dat_full_labs_final_sex$age + 
                         coef_sex * der_dat_full_labs_final_sex$sex +
                         coef_neutro_abs * der_dat_full_labs_final_sex$neutro_abs +  
                         coef_lympho_abs * der_dat_full_labs_final_sex$lympho_abs + 
                         coef_platelet_abs * der_dat_full_labs_final_sex$platelet_abs + 
                         coef_crp * der_dat_full_labs_final_sex$crp + 
                         coef_creatinine * der_dat_full_labs_final_sex$creatinine 
                        #intercept
                         )

der_obs_dl_death <- der_dat_full_labs_final_sex$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_dl_death <- roc(der_obs_dl_death, der_pred_dl_death, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#DL-poor
coef_age <- log(1.03) # Existing logistic regression model coefficients
coef_sex <- log(0.62)
coef_neutro_abs <- log(1.29)#unit: 10^9/L
coef_lympho_abs <- log(0.31)#unit: 10^9/L
coef_platelet_abs <- log(1)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1.01) #unit: μmol/L
#intercept <- 4.203

der_dat_full_labs_final_sex <- der_dat_full_labs_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
der_dat_full_labs_final_sex$sex <- ifelse(der_dat_full_labs_final$sex == "Male", 1, 0)
der_pred_dl_poor <- plogis(coef_age * der_dat_full_labs_final_sex$age + 
                         coef_sex * der_dat_full_labs_final_sex$sex +
                         coef_neutro_abs * der_dat_full_labs_final_sex$neutro_abs +  
                         coef_lympho_abs * der_dat_full_labs_final_sex$lympho_abs + 
                         coef_platelet_abs * der_dat_full_labs_final_sex$platelet_abs + 
                         coef_crp * der_dat_full_labs_final_sex$crp + 
                         coef_creatinine * der_dat_full_labs_final_sex$creatinine 
                        #intercept
                         )

der_obs_dl_poor <- der_dat_full_labs_final_sex$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_dl_poor <- roc(der_obs_dl_poor, der_pred_dl_poor, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#qSOFA
der_dat_qsofa <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         icu_7d)

der_dat_qsofa <- der_dat_qsofa %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 22 ~ 1,
    rr < 22 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 100 ~ 1,
    bp_sys > 100 ~ 0
    )
   )

der_dat_qsofa <- der_dat_qsofa %>%
  mutate(der_score_qsofa = rowSums(select(., score_consciousness:score_bp))) 

mod_qsofa <- glm(icu_7d ~ der_score_qsofa, data = der_dat_qsofa, family = binomial)# Fit a logistic regression model
der_pred_qsofa <- predict(mod_qsofa, type = "response")# Predict probabilities for the same data
der_obs_qsofa <- der_dat_qsofa$icu_7d
der_roc_qsofa <- roc(der_obs_qsofa, der_pred_qsofa)# Calculate the ROC curve

#ACP index
der_dat_acp <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(age,
         crp,
         icu_7d)

der_dat_acp <- der_dat_acp %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age >= 60 ~ 1,
    age < 60 ~ 0
  ),
    score_crp = case_when(
    crp >= 34 ~ 1,#unit: mg/L
    crp < 34 ~ 0
  )
   )

der_dat_acp <- der_dat_acp %>%
  mutate(der_score_acp = rowSums(select(., score_age:score_crp))) 

mod_acp <- glm(icu_7d ~ der_score_acp, data = der_dat_acp, family = binomial)# Fit a logistic regression model
der_pred_acp <- predict(mod_acp, type = "response")# Predict probabilities for the same data
der_obs_acp <- der_dat_acp$icu_7d
der_roc_acp <- roc(der_obs_acp, der_pred_acp)# Calculate the ROC curve

#ASCL score
der_dat_ascl <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(age,
         sex,
         crp,
         ldh,
         icu_7d)

der_dat_ascl <- der_dat_ascl %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 1,
    age >= 60 & age <= 69 ~ 2,
    age >= 70 & age <= 79 ~ 3,
    age >= 80 ~ 4
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_crp = case_when(
    crp > 60 ~ 2,#unit: mg/L
    crp <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 300 ~ 0,#unit: U/L
    ldh > 300 ~ 2
  )
   )

der_dat_ascl <- der_dat_ascl %>%
  mutate(der_score_ascl = rowSums(select(., score_age:score_ldh))) 

mod_ascl <- glm(icu_7d ~ der_score_ascl, data = der_dat_ascl, family = binomial)# Fit a logistic regression model
der_pred_ascl <- predict(mod_ascl, type = "response")# Predict probabilities for the same data
der_obs_ascl <- der_dat_ascl$icu_7d
der_roc_ascl <- roc(der_obs_ascl, der_pred_ascl)# Calculate the ROC curve

#Huang model
coef_num_comor <- 2.752# Existing logistic regression model coefficients
coef_rr <- 4.056
coef_crp <- 2.424#unit: 10^9/L
coef_ldh <- 5.392#unit: 10^9/L
intercept <- -6.488

der_dat_full_final_huang <- der_dat_full_final
der_dat_full_final_huang <- der_dat_full_final_huang %>% #computation of 4C score for each patient
  mutate(num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  ),
    rr = case_when(
    rr > 24 ~ 1,
    rr <= 24 ~ 0
  ),
    crp = case_when(
    crp > 10 ~ 1,#unit: mg/L
    crp <= 10 ~ 0
  ),
    ldh = case_when(
    ldh <= 250 ~ 0,#unit: U/L
    ldh > 250 ~ 1
  )
   )

der_pred_huang <- plogis(coef_num_comor * der_dat_full_final_huang$num_comor + 
                         coef_rr * der_dat_full_final_huang$rr +
                         coef_crp * der_dat_full_final_huang$crp +  
                         coef_ldh * der_dat_full_final_huang$ldh +
                         intercept
                         )

der_obs_huang <- der_dat_full_final_huang$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_huang <- roc(der_obs_huang, der_pred_huang, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#CALL score
der_dat_call <- der_dat_full_labs_final %>% #create the data frame
  select(num_comor,
         age,
         lympho_abs,
         ldh,
         icu_7d)

der_dat_call <- der_dat_call %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age <= 60 ~ 1,
    age > 60 ~ 3,
    ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor <= 1 ~ 3
    ),
    score_lympho_abs = case_when(
    lympho_abs > 1 ~ 2,#unit: mg/L
    lympho_abs <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 250 ~ 1,#unit: U/L
    ldh > 250 & ldh <= 500 ~ 2,
    ldh > 500 ~ 3
  )
   )

der_dat_call <- der_dat_call %>%
  mutate(der_score_call = rowSums(select(., score_age:score_ldh))) 

mod_call <- glm(icu_7d ~ der_score_call, data = der_dat_call, family = binomial)# Fit a logistic regression model
der_pred_call <- predict(mod_call, type = "response")# Predict probabilities for the same data
der_obs_call <- der_dat_call$icu_7d
der_roc_call <- roc(der_obs_call, der_pred_call)# Calculate the ROC curve

#SHI score
der_dat_shi <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(age,
         sex,
         bp_sys,
         bp_dia,
         icu_7d)

der_dat_shi <- der_dat_shi %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 ~ 1
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_hbp = case_when(
    bp_sys >= 130 | bp_dia >= 80 ~ 1,#unit: mg/L
    bp_sys < 130 & bp_dia < 80 ~ 0
  )
   )

der_dat_shi <- der_dat_shi %>%
  mutate(der_score_shi = rowSums(select(., score_age:score_hbp))) 

mod_shi <- glm(icu_7d ~ der_score_shi, data = der_dat_shi, family = binomial)# Fit a logistic regression model
der_pred_shi <- predict(mod_shi, type = "response")# Predict probabilities for the same data
der_obs_shi <- der_dat_shi$icu_7d
der_roc_shi <- roc(der_obs_shi, der_pred_shi)# Calculate the ROC curve

#XIE model
coef_age <- 0.053 # Existing logistic regression model coefficients
coef_ldh <- 0.004
coef_lympho_abs <- -1.216#unit: 10^9/L
coef_spo2 <- -0.109#unit: 10^9/L
intercept <- 5.068

der_pred_xie <- plogis(coef_age * der_dat_full_labs_final$age + 
                         coef_ldh * der_dat_full_labs_final$ldh +
                         coef_lympho_abs * der_dat_full_labs_final$lympho_abs +  
                         coef_spo2 * der_dat_full_labs_final$spo2 +
                         intercept
                         )

der_obs_xie <- der_dat_full_labs_final$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_xie <- roc(der_obs_xie, der_pred_xie, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#CROSS score
der_dat_cross <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_cross <- der_dat_cross %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_cross <- der_dat_cross %>%
  mutate(der_score_cross = rowSums(select(., score_rr:score_consciousness))) 

mod_cross <- glm(icu_7d ~ der_score_cross, data = der_dat_cross, family = binomial)# Fit a logistic regression model
der_pred_cross <- predict(mod_cross, type = "response")# Predict probabilities for the same data
der_obs_cross <- der_dat_cross$icu_7d
der_roc_cross <- roc(der_obs_cross, der_pred_cross)

# Full model with labs
coef_o2_supplement <- 0.8390
coef_impaired_consciousness <- 1.4032
coef_num_comor <- 0.1463
coef_age <- -0.0947
coef_rr <- 0.3783
coef_bp_sys <- 0.0917
coef_bp_dia <- -0.3193
coef_temp <- 0.1046
coef_spo2 <- -0.2439
coef_wbc_abs <- 0.0665
coef_platelet_abs <- -0.0466
coef_urea <- 0.2008
coef_creatinine <- -0.0847
coef_crp <- 0.1052
coef_ldh <- 0.4486
intercept <- -1.4643

#convert factors to continuous variables
der_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(der_dat_final_full_model_with_labs$o2_supplement))
der_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(der_dat_final_full_model_with_labs$impaired_consciousness))

der_pred_full <- plogis(coef_o2_supplement * der_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * der_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_num_comor * der_dat_final_full_model_with_labs$num_comor +  
                         coef_age * der_dat_final_full_model_with_labs$age +
                         coef_rr * der_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * der_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * der_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * der_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * der_dat_final_full_model_with_labs$spo2 +
                         coef_wbc_abs * der_dat_final_full_model_with_labs$wbc_abs +
                         coef_platelet_abs * der_dat_final_full_model_with_labs$platelet_abs + 
                         coef_urea * der_dat_final_full_model_with_labs$urea +
                         coef_creatinine * der_dat_final_full_model_with_labs$creatinine +  
                         coef_crp * der_dat_final_full_model_with_labs$crp +
                         coef_ldh * der_dat_final_full_model_with_labs$ldh +
                         intercept
                         )

der_obs_full <- der_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_full_model_with_labs <- roc(der_obs_full, der_pred_full, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#o2_supplement
coef_o2_supplement <- 1.4662
intercept <- -1.5509

#convert factors to continuous variables
der_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(der_dat_final_full_model_with_labs$o2_supplement))

der_pred_o2_supplement <- plogis(coef_o2_supplement * der_dat_final_full_model_with_labs$o2_supplement +
                         intercept
                         )

der_obs_o2_supplement <- der_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_o2_supplement <- roc(der_obs_o2_supplement, der_pred_o2_supplement, smooth = F)# Create an ROC curve using the predicted probabilities and observed outcomes.

#spo2
coef_spo2 <- -0.5575
intercept <- -0.8444

der_dat_final_full_model_with_labs$spo2 <- as.numeric(as.character(der_dat_final_full_model_with_labs$spo2))

der_pred_spo2 <- plogis(coef_spo2 * der_dat_final_full_model_with_labs$spo2 +
                         intercept
                         )

der_obs_spo2 <- der_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_spo2 <- roc(der_obs_spo2, der_pred_spo2, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

#LDH
if(FALSE) {
coef_ldh <- 0.8925
intercept <- -0.8926

der_dat_final_full_model_with_labs$ldh <- as.numeric(as.character(der_dat_final_full_model_with_labs$ldh))

der_pred_ldh <- plogis(coef_ldh * der_dat_final_full_model_with_labs$ldh +
                         intercept
                         )

der_obs_ldh <- der_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_ldh <- roc(der_obs_ldh, der_pred_ldh, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.
}

# Combine all ROC data into one data frame
roc_data <- rbind(
  data.frame(sensitivity = der_roc_cross$sensitivities, false_positive_rate = 1 - der_roc_cross$specificities, Model = "CROSS score"),
  #data.frame(sensitivity = roc_full_model_with_labs$sensitivities, false_positive_rate = 1 - roc_full_model_with_labs$specificities, Model = "Full model with laboratory values"),
  #data.frame(sensitivity = roc_abc$sensitivities, false_positive_rate = 1 - roc_abc$specificities, Model = "CROSS model"),
  data.frame(sensitivity = der_roc_4c_mortality$sensitivities, false_positive_rate = 1 - der_roc_4c_mortality$specificities, Model = "4C Mortality"),
  data.frame(sensitivity = der_roc_news$sensitivities, false_positive_rate = 1 - der_roc_news$specificities, Model = "NEWS"),
  data.frame(sensitivity = der_roc_curb65$sensitivities, false_positive_rate = 1 - der_roc_curb65$specificities, Model = "CURB-65"),
  data.frame(sensitivity = der_roc_crb65$sensitivities, false_positive_rate = 1 - der_roc_crb65$specificities, Model = "CRB-65"),
  data.frame(sensitivity = der_roc_a_drop$sensitivities, false_positive_rate = 1 - der_roc_a_drop$specificities, Model = "A-DROP"),
  data.frame(sensitivity = der_roc_ds_crb65$sensitivities, false_positive_rate = 1 - der_roc_ds_crb65$specificities, Model = "DS CRB-65"),
  data.frame(sensitivity = der_roc_dl_death$sensitivities, false_positive_rate = 1 - der_roc_dl_death$specificities, Model = "DL-death"),
  data.frame(sensitivity = der_roc_dl_poor$sensitivities, false_positive_rate = 1 - der_roc_dl_poor$specificities, Model = "DL-poor"),
  data.frame(sensitivity = der_roc_qsofa$sensitivities, false_positive_rate = 1 - der_roc_qsofa$specificities, Model = "qSOFA"),
  data.frame(sensitivity = der_roc_acp$sensitivities, false_positive_rate = 1 - der_roc_acp$specificities, Model = "ACP index"),
  data.frame(sensitivity = der_roc_ascl$sensitivities, false_positive_rate = 1 - der_roc_ascl$specificities, Model = "ASCL"),
  data.frame(sensitivity = der_roc_huang$sensitivities, false_positive_rate = 1 - der_roc_huang$specificities, Model = "Huang"),
  data.frame(sensitivity = der_roc_call$sensitivities, false_positive_rate = 1 - der_roc_call$specificities, Model = "CALL"),
  data.frame(sensitivity = der_roc_shi$sensitivities, false_positive_rate = 1 - der_roc_shi$specificities, Model = "Shi"),
  data.frame(sensitivity = der_roc_xie$sensitivities, false_positive_rate = 1 - der_roc_xie$specificities, Model = "Xie"),
  data.frame(sensitivity = der_roc_o2_supplement$sensitivities, false_positive_rate = 1 - der_roc_o2_supplement$specificities, Model = "Oxygen supplement"),
  data.frame(sensitivity = der_roc_spo2$sensitivities, false_positive_rate = 1 - der_roc_spo2$specificities, Model = "Oxygen saturation")
  #data.frame(sensitivity = der_roc_ldh$sensitivities, false_positive_rate = 1 - der_roc_ldh$specificities, Model = "LDH")
  )

# Define custom colors and linetypes for each model
custom_colors <- c('CROSS score' = '#B22222',
                   '4C Mortality' = '#0f00ba',
                   'NEWS' = '#5085a5',
                   'CURB-65' = '#800080', 
                   'CRB-65' = '#40e0d0', 
                   'A-DROP' = '#6fd890', 
                   'DS CRB-65' = '#4169E1',
                   'DL-death' = '#f4915f',
                   'DL-poor' =  '#ff7e6b',
                   'qSOFA' =  '#ff00cc',
                   'ACP index' = '#bc7ff7', 
                   'ASCL' = '#d5d86f', 
                   'Huang' =  '#00a1de',
                   'CALL' = '#203f8b', 
                   'Shi' =  '#82d173', 
                   'Xie' = '#660033', 
                   'Oxygen supplement' = '#79b791',
                   'Oxygen saturation' = '#cc3333'
                   #'LDH' = '#f0e936'
                   )

# Define linetypes
custom_linetypes <- c('CROSS score' = 'solid',
                      #'Full model with laboratory values' = 'solid',
                      #'CROSS model' = 'solid', 
                      '4C Mortality' = 'dashed', 
                      'NEWS' = 'dashed',
                      'CURB-65' = 'dashed', 
                      'CRB-65' = 'dashed',
                      'A-DROP' = 'dashed',
                      'DS CRB-65' = 'dashed',
                      'DL-death' = 'dashed', 
                      'DL-poor' = 'dashed', 
                      'qSOFA' = 'dashed',
                      'ACP index' = 'dashed', 
                      'ASCL' = 'dashed',
                      'Huang' = 'dashed',
                      'CALL' = 'dashed',
                      'Shi' = 'dashed',
                      'Xie' = 'dashed', 
                      'Oxygen supplement' = 'dashed',
                      'Oxygen saturation' = 'dashed'
                      #'LDH' = 'dashed'
                      )

# Define the order of levels for the "Model" factor
roc_data$Model <- factor(roc_data$Model, 
                         levels = c(
  #'CROSS model', 
  'CROSS score',
  #'Best model', "Clinical model", 
  "NEWS", #'LDH', 
  "qSOFA", "Huang", "Oxygen supplement", "DL-poor", "ASCL", "Xie", "DL-death", "DS CRB-65", "A-DROP", "4C Mortality", "CURB-65", "CRB-65", 'Oxygen saturation', "ACP index", "Shi", "CALL"  
                                  )
  )

# Plot ROC curves using ggplot2 with custom colors and linetypes
ggplot(roc_data, aes(x = false_positive_rate, y = sensitivity, color = Model, linetype = Model)) +
  geom_line(size = 0.4) +
  labs(title = "ROC Curves for Multiple Models",
       x = "False positive rate",
       y = "True positive rate") +
  scale_color_manual(values = custom_colors) + # Specify custom colors
  scale_linetype_manual(values = custom_linetypes) + # Specify custom linetypes
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#808080", size = 0.4, alpha = 0.6) +
  theme_wx +
  theme(legend.position = "none") + # Remove the legend
  #theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  #theme(legend.position = "right") +
  #theme(legend.position = c(0.9, 0.4)) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Calculate the AUC
list_auc <- list(auc_cross = auc(der_roc_cross), 
                 #auc_full_model_with_laboratory_values = auc(der_roc_full_model_with_laboratory_values),
                 auc_abc = auc(der_roc_abc), 
                 auc_4c_mortality = auc(der_roc_4c_mortality), 
                 auc_news = auc(der_roc_news),
                 #auc_ldh = auc(der_roc_ldh),
                 auc_curb65 = auc(der_roc_curb65),
                 auc_crb65 = auc(der_roc_crb65),
                 auc_a_drop = auc(der_roc_a_drop),
                 auc_ds_curb65 = auc(der_roc_ds_crb65),
                 auc_dl_death = auc(der_roc_dl_death),
                 auc_dl_poor = auc(der_roc_dl_poor),
                 auc_qsofa = auc(der_roc_qsofa),
                 auc_acp = auc(der_roc_acp),
                 auc_ascl = auc(der_roc_ascl),
                 auc_huang = auc(der_roc_huang),
                 auc_call = auc(der_roc_call),
                 auc_shi = auc(der_roc_shi),
                 auc_xie = auc(der_roc_xie),
                 auc_o2_supplement = auc(der_roc_o2_supplement),
                 auc_spo2 = auc(der_roc_spo2)
                 )
list_auc

# Calculate the confidence intervals for the AUC using the bootstrap method
list_ci <- list(ci_cross = ci.auc(der_roc_cross, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                #ci_full_model_with_laboratory_values = ci.auc(der_roc_full_model_with_laboratory_values, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_abc = ci.auc(der_roc_abc, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_4c_mortality = ci.auc(der_roc_4c_mortality, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_news = ci.auc(der_roc_news, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                #ci_ldh = ci.auc(der_roc_ldh, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_curb65 = ci.auc(der_roc_curb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_crb65 = ci.auc(der_roc_crb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_a_drop = ci.auc(der_roc_a_drop, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_ds_crb65 = ci.auc(der_roc_ds_crb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_dl_death = ci.auc(der_roc_dl_death, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_dl_poor = ci.auc(der_roc_dl_poor, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_qsofa = ci.auc(der_roc_qsofa, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_acp = ci.auc(der_roc_acp, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_ascl = ci.auc(der_roc_ascl, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_huang = ci.auc(der_roc_huang, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_call = ci.auc(der_roc_call, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_shi = ci.auc(der_roc_shi, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_xie = ci.auc(der_roc_xie, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_o2_supplement = ci.auc(der_roc_o2_supplement, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_spo2 = ci.auc(der_roc_spo2, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE)
                )
list_ci
```





```{r derivation_four_risk_scores_discrimination}
# clinical risk score1 (coefficients of simplified clinical model * 1)
der_dat_risk_score1 <- der_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_risk_score1 <- der_dat_risk_score1 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 1,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 0
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 1
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 2
  )
  )

der_dat_risk_score1 <- der_dat_risk_score1 %>%
  mutate(der_score_risk_score1 = rowSums(select(., score_rr:score_consciousness))) 

der_mod_risk_score1 <- glm(icu_7d ~ der_score_risk_score1, data = der_dat_risk_score1, family = binomial)# Fit a logistic regression model
der_pred_risk_score1 <- predict(der_mod_risk_score1, type = "response")# Predict probabilities for the same data
der_obs_risk_score1 <- der_dat_risk_score1$icu_7d
der_roc_risk_score1 <- roc(der_obs_risk_score1, der_pred_risk_score1)

# clinical risk score2 (coefficients of simplified clinical model * 2)
der_dat_risk_score2 <- der_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_risk_score2 <- der_dat_risk_score2 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 1,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

der_dat_risk_score2 <- der_dat_risk_score2 %>%
  mutate(der_score_risk_score2 = rowSums(select(., score_rr:score_consciousness))) 

der_mod_risk_score2 <- glm(icu_7d ~ der_score_risk_score2, data = der_dat_risk_score2, family = binomial)# Fit a logistic regression model
der_pred_risk_score2 <- predict(der_mod_risk_score2, type = "response")# Predict probabilities for the same data
der_obs_risk_score2 <- der_dat_risk_score2$icu_7d
der_roc_risk_score2 <- roc(der_obs_risk_score2, der_pred_risk_score2)

# clinical risk score3 (coefficients of simplified clinical model * 3)
der_dat_risk_score3 <- der_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_risk_score3 <- der_dat_risk_score3 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_risk_score3 <- der_dat_risk_score3 %>%
  mutate(der_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

der_mod_risk_score3 <- glm(icu_7d ~ der_score_risk_score3, data = der_dat_risk_score3, family = binomial)# Fit a logistic regression model
der_pred_risk_score3 <- predict(der_mod_risk_score3, type = "response")# Predict probabilities for the same data
der_obs_risk_score3 <- der_dat_risk_score3$icu_7d
der_roc_risk_score3 <- roc(der_obs_risk_score3, der_pred_risk_score3)

# clinical risk score4 (coefficients of simplified clinical model * 4)
der_dat_risk_score4 <- der_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_risk_score4 <- der_dat_risk_score4 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 3,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 2
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 4
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 6
  )
  )

der_dat_risk_score4 <- der_dat_risk_score4 %>%
  mutate(der_score_risk_score4 = rowSums(select(., score_rr:score_consciousness))) 

der_mod_risk_score4 <- glm(icu_7d ~ der_score_risk_score4, data = der_dat_risk_score4, family = binomial)# Fit a logistic regression model
der_pred_risk_score4 <- predict(der_mod_risk_score4, type = "response")# Predict probabilities for the same data
der_obs_risk_score4 <- der_dat_risk_score4$icu_7d
der_roc_risk_score4 <- roc(der_obs_risk_score4, der_pred_risk_score4)
```

```{r derivation_model apparent performance_discrimination, fig.width=6, fig.height=6}
# Predictions and ROC curve for the ABC model
pred_abc <- predict(fit_optimal_der, design_matrix_der, type = "response")
if (exists('matrix_der')) {
  der_obs_abc <- matrix_der$icu_7d
} else if (exists('rcs_matrix_der')) {
  der_obs_abc <- rcs_matrix_der$icu_7d
}
der_roc_abc <- roc(der_obs_abc, der_pred_abc, smooth = T)

# Simplified CROSS model (continuous variables were dichotomized)
coef_o2_supplement <- 0.9604146
coef_impaired_consciousness <- 1.5691841
coef_rr <- 0.6687391
coef_spo2 <- 0.4777998
intercept <- -1.8937371

#convert factors to continuous variables
der_dat_risk_score$o2_supplement <- as.numeric(as.character(der_dat_risk_score$o2_supplement))
der_dat_risk_score$impaired_consciousness <- as.numeric(as.character(der_dat_risk_score$impaired_consciousness))

der_pred_simplified_cross_model <- plogis(coef_o2_supplement * der_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * der_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * der_dat_risk_score$num_comor +  
                         #coef_age * der_dat_risk_score$age +
                         coef_rr * der_dat_risk_score$rr +
                         #coef_bp_sys * der_dat_risk_score$bp_sys + 
                         #coef_bp_dia * der_dat_risk_score$bp_dia +
                         #coef_temp * der_dat_risk_score$temp +  
                         coef_spo2 * der_dat_risk_score$spo2 +
                         #coef_wbc_abs * der_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * der_dat_risk_score$platelet_abs + 
                         #coef_urea * der_dat_risk_score$urea +
                         #coef_creatinine * der_dat_risk_score$creatinine +  
                         #coef_crp * der_dat_risk_score$crp +
                         #coef_ldh * der_dat_risk_score$ldh +
                         intercept
                         )

der_obs_simplified_cross_model <- der_dat_risk_score$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
der_roc_simplified_cross_model <- roc(der_obs_simplified_cross_model, der_pred_simplified_cross_model, smooth = T)

# clinical risk score3 (coefficients of simplified clinical model * 3)
der_dat_risk_score3 <- der_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_risk_score3 <- der_dat_risk_score3 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_risk_score3 <- der_dat_risk_score3 %>%
  mutate(der_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

der_mod_risk_score3 <- glm(icu_7d ~ der_score_risk_score3, data = der_dat_risk_score3, family = binomial)# Fit a logistic regression model
der_pred_risk_score3 <- predict(der_mod_risk_score3, type = "response")# Predict probabilities for the same data
der_obs_risk_score3 <- der_dat_risk_score3$icu_7d
der_roc_risk_score3 <- roc(der_obs_risk_score3, der_pred_risk_score3)

# ROC for the full model without labs
coef_o2_supplement <- 1.1270
coef_impaired_consciousness <- 1.9790
coef_sex <- 0.1671
coef_age <- -0.1182
coef_rr <- 0.4615
coef_bp_sys <- 0.2653
coef_bp_dia <- -0.4866
coef_temp <- 0.1050
coef_hr <- 0.0366
coef_spo2 <- -0.4063
intercept <- -1.7365

#convert factors to continuous variables
der_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(der_dat_final_full_model_with_labs$o2_supplement))
der_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(der_dat_final_full_model_with_labs$impaired_consciousness))
der_dat_final_full_model_with_labs$sex <- ifelse(der_dat_final_full_model_with_labs$sex == 'female', 0, 1)

der_pred_full_model_without_labs <- plogis(coef_o2_supplement * der_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * der_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_sex * der_dat_final_full_model_with_labs$sex +  
                         coef_age * der_dat_final_full_model_with_labs$age +
                         coef_rr * der_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * der_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * der_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * der_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * der_dat_final_full_model_with_labs$spo2 +
                         coef_hr * der_dat_final_full_model_with_labs$hr +
                         intercept
                         )

der_obs_full_model_without_labs <- der_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

der_roc_full_model_without_labs <- roc(der_obs_full_model_without_labs, der_pred_full_model_without_labs, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# Combine all ROC data into one data frame
roc_data <- rbind(
  data.frame(sensitivity = der_roc_abc$sensitivities, false_positive_rate = 1 - der_roc_abc$specificities, Model = "CROSS model"),
  data.frame(sensitivity = der_roc_risk_score3$sensitivities, false_positive_rate = 1 - der_roc_risk_score3$specificities, Model = "CROSS score"),
  data.frame(sensitivity = der_roc_simplified_cross_model$sensitivities, false_positive_rate = 1 - der_roc_simplified_cross_model$specificities, Model = "sCROSS model"),
  data.frame(sensitivity = der_roc_full_model_without_labs$sensitivities, false_positive_rate = 1 - der_roc_full_model_without_labs$specificities, Model = "Full model")
  )

# Define custom colors and linetypes for each model
custom_colors <- c('CROSS score' = '#B22222',
                   'CROSS model' = '#32CD32',
                   'sCROSS model' = '#7341D1',
                   'Full model' = '#f4915f'
                   )

# Define linetypes
custom_linetypes <- c('CROSS score' = 'solid',
                      'sCROSS model' = 'dashed',
                      'Full model' = 'dashed',
                      'CROSS model' = 'dashed' 
                      
)

# Define the order of levels for the "Model" factor
roc_data$Model <- factor(roc_data$Model, 
                         levels = c(
  'CROSS score',
  'CROSS model', 
  'sCROSS model', 
  "Full model"
  )
  )

#customize the theme
theme_wx <-  theme_minimal() +
    theme(axis.line = element_line(colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank(),
  axis.text = element_text(size = 12),
  axis.title = element_text(size = 14),
  legend.text = element_text(size = 10),
  legend.title = element_text(size = 12)) +
  theme(axis.line = element_line(color = "grey"))

# Plot ROC curves using ggplot2 with custom colors and linetypes
ggplot(roc_data, aes(x = false_positive_rate, y = sensitivity, color = Model, linetype = Model)) +
  geom_line(size = 0.4) +
  labs(title = "ROC Curves for Multiple Models",
       x = "False positive rate",
       y = "True positive rate") +
  scale_color_manual(values = custom_colors) + # Specify custom colors
  scale_linetype_manual(values = custom_linetypes) + # Specify custom linetypes
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#808080", size = 0.4, alpha = 0.6) +
  theme_wx +
  theme(legend.position = "none") + # Remove the legend
  #theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  #theme(legend.position = "right") +
  #theme(legend.position = c(0.9, 0.4)) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Calculate the AUC
list_auc <- list(auc_cross_model = auc(der_roc_abc), 
                 auc_cross_score = auc(der_roc_risk_score3), 
                 auc_simplified_cross_model = auc(der_roc_simplified_cross_model), 
                 auc_full_model_without_labs = auc(der_roc_full_model_without_labs)
                 )
list_auc

# Calculate the confidence intervals for the AUC using the bootstrap method
list_ci <- list(ci_cross_model = ci.auc(der_roc_abc, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_cross_score = ci.auc(der_roc_risk_score3, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_simplified_cross_model = ci.auc(der_roc_simplified_cross_model, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_full_model_without_labs = ci.auc(der_roc_full_model_without_labs, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE)
                )
list_ci
```

```{r derivation_cross_score_risk_groups_1, eval = FALSE, echo = FALSE}
# iF tertile
quantiles <- quantile(der_dat_risk_score3$der_score_risk_score3, probs = c(0.25, 0.75))

der_dat_risk_score3_risk_group <- der_dat_risk_score3
der_dat_risk_score3_risk_group <- der_dat_risk_score3_risk_group %>% 
  mutate(
  risk_group = case_when(
  der_score_risk_score3 == 0 ~ 'low',
  (der_score_risk_score3 >= 1) &  (der_score_risk_score3 <= 4) ~ 'medium',
  der_score_risk_score3 >= 5 ~ 'high'
  )
  )

#Number of patients
table(der_dat_risk_score3_risk_group$risk_group)

#Number of ICU admission
der_dat_risk_score3_risk_group %>%
  group_by(risk_group, icu_7d) %>%
  summarise(yes= sum(icu_7d == 1)
            #no = sum(icu_7d == 0)
  )
```

```{r derivation_cross_score_risk_groups_3, echo = FALSE, eval = FALSE}
# Calculate the quantiles
quantiles <- quantile(der_dat_risk_score3$der_score_risk_score3, probs = c(0, 0.25, 0.50, 0.75, 1))

der_dat_risk_score3_risk_group <- der_dat_risk_score3
der_dat_risk_score3_risk_group <- der_dat_risk_score3_risk_group %>% 
  mutate(
  risk_group = case_when(
  der_score_risk_score3 <= 1 ~ 'low',
  (der_score_risk_score3 >= 2) &  (der_score_risk_score3 <= 3) ~ 'medium',
  (der_score_risk_score3 >= 4) &  (der_score_risk_score3 <= 5) ~ 'high',
  der_score_risk_score3 >= 6 ~ 'very high'
  )
  )

#Number of patients
table(der_dat_risk_score3_risk_group$risk_group)

#Number of ICU admission
der_dat_risk_score3_risk_group %>%
  group_by(risk_group, icu_7d) %>%
  summarise(yes= sum(icu_7d == 1)
            #no = sum(icu_7d == 0)
  )
```

```{r derivation_model apparent performance_calibration_calibration_plot, fig.width=6, fig.height=6}
#model abc
if(exists('matrix_der')) {
  der_obs_abc = as.numeric(as.character(matrix_der$icu_7d))
} else if(exists('rcs_matrix_der')) {
  der_obs_abc = as.numeric(as.character(rcs_matrix_der$icu_7d))
}

der_pred_abc <- predict(fit_optimal_der, design_matrix_der, type = "response")
der_dat_calib_abc <- data.frame(pred_risk = der_pred_abc[,1], true_outcome = der_obs_abc) 
der_dat_calib_abc <- der_dat_calib_abc[order(der_dat_calib_abc$pred_risk), ]

der_calib_abc <- ggplot(der_dat_calib_abc, aes(x = pred_risk, y = true_outcome)) +#Create the calibration plot using ggplot2
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  geom_smooth(method = "loess", se = FALSE, color = '#32CD32', size = 0.4) +  # Add loess smoother
  labs(x = "Predicted risk", y = "Observed risk", title = "Calibration Plot_ABC") +
  theme_wx

print(der_calib_abc)

#CROSS score
der_obs_cross <- as.numeric(der_obs_cross) - 1
der_dat_calib_cross_score <- data.frame(pred_risk = der_pred_cross, true_outcome = der_obs_cross)
der_dat_calib_cross_score <- der_dat_calib_cross_score[order(der_dat_calib_cross_score$pred_risk), ]

der_calib_cross_score <- ggplot(der_dat_calib_cross_score, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#B22222", size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_cross_score") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(der_calib_cross_score)

#Simplified cross model
der_obs_simplified_cross_model <- as.numeric(der_obs_simplified_cross_model) - 1
der_dat_calib_simplified_cross_model <- data.frame(pred_risk = der_pred_simplified_cross_model, true_outcome = der_obs_simplified_cross_model)
der_dat_calib_simplified_cross_model <- der_dat_calib_simplified_cross_model [order(der_dat_calib_simplified_cross_model$pred_risk), ]

der_calibration_simplified_cross_model <- ggplot(der_dat_calib_simplified_cross_model, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#7341D1", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_simplified_cross_model") +
  theme_wx

print(der_calibration_simplified_cross_model)

#Full model without labs
der_obs_full_model_without_labs <- as.numeric(der_obs_full_model_without_labs) - 1
der_dat_calib_full_model_without_labs <- data.frame(pred_risk = der_pred_full_model_without_labs, true_outcome = der_obs_full_model_without_labs)
der_dat_calib_full_model_without_labs <- der_dat_calib_full_model_without_labs[order(der_dat_calib_full_model_without_labs$pred_risk), ]

der_calib_full_model_without_labs <- ggplot(der_dat_calib_full_model_without_labs, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#f4915f", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_full_model_without_labs") +
  theme_wx

print(der_calib_full_model_without_labs)

#combined_calibration_plot <- calibration_plot_best_model
combined_calib_plot <- der_calib_cross_score

# Define the calibration data sources
calib_data_list <- list(
  der_dat_calib_cross_score,
  der_dat_calib_abc,
  der_dat_calib_simplified_cross_model,
  der_dat_calib_full_model_without_labs
)

calib_data_names <- c(
  "CROSS score",
  "CROSS model",
  'sCROSS model',
  'Full model'
)

# Define the colors for the smooth lines
smooth_colors <- c(
                   'CROSS score' = '#B22222',
                   'CROSS model' = '#32CD32',
                   'sCROSS model' = '#7341D1',
                   'Full model without labs' = '#f4915f'
)

# Add smooth lines for each calibration data source with specified line types
for (i in 1:length(calib_data_list)) {
  calib_data_list[[i]]$calib_name <- calib_data_names[i]
  
  combined_calib_plot <- combined_calib_plot +
    geom_smooth(
      data = calib_data_list[[i]],
      aes(color = calib_name, linetype = calib_name),  # Add the linetype aesthetic and specify the calibration data name
      method = "loess", 
      se = FALSE, 
      size = 0.4
    )
}

# Customize the legend title and position, including both line colors and line types
combined_calib_plot <- combined_calib_plot +
  labs(color = "Calibration Data", linetype = "Calibration Data") +
  scale_color_manual(values = smooth_colors) +
  scale_linetype_manual(values = c("CROSS score" = 'solid',
  "CROSS model" = 'dashed',
  'sCROSS model' = 'dashed',
  'Full model' = 'dashed'),
                        ) +
  theme_wx +
  ylim(0, 1) + 
  theme(legend.position = "none") +
  #theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Save the combined plot as an image
print(combined_calib_plot)
```

```{r derivation_calibration slope_calibration intercept}
#Model abc
der_cali_result_abc <- perform_calibration_analysis(der_pred_abc[,1], der_obs_abc)

#Model o2_supplement
if(exists('matrix_der')) {
  mod_o2_supplement <- glm(icu_7d ~ o2_supplement, data = matrix_der, family = "binomial")
  pred_o2_supplement <- predict(mod_o2_supplement, newdata = matrix_der['o2_supplement'], type = "response")
} else if(exists('rcs_matrix_der')) {
  mod_o2_supplement <- glm(icu_7d ~ o2_supplement, data = rcs_matrix_der, family = "binomial")
  pred_o2_supplement <- predict(mod_o2_supplement, newdata = rcs_matrix_der['o2_supplement'], type = "response")
}
der_cali_result_o2_supplement <- perform_calibration_analysis(pred_o2_supplement, der_obs_o2_supplement)

#Model spo2
der_cali_result_spo2 <- perform_calibration_analysis(der_pred_spo2, der_obs_spo2)

# Simplified cross model (continuous variables were dichotomized)
der_cali_result_simplified_cross_model <- perform_calibration_analysis(der_pred_simplified_cross_model, der_obs_simplified_cross_model)

#Full model without labs
der_cali_result_full_model_without_labs <- perform_calibration_analysis(der_pred_full_model_without_labs, der_obs_full_model_without_labs)

#Risk score1 (coefficients of simplified clinical model multiplied by 1)
der_cali_result_der_risk_score1 <- perform_calibration_analysis(der_pred_risk_score1, der_obs_risk_score1)

# Risk score2 (coefficients of simplified clinical model * 2)
der_cali_result_der_risk_score2 <- perform_calibration_analysis(der_pred_risk_score2, der_obs_risk_score2)

#Risk score3 (coefficients of simplified clinical model * 3)
der_cali_result_der_risk_score3 <- perform_calibration_analysis(der_pred_risk_score3, der_obs_risk_score3)

# Risk score4 (coefficients of simplified clinical model * 4)
der_cali_result_der_risk_score4 <- perform_calibration_analysis(der_pred_risk_score4, der_obs_risk_score4)


if(FALSE) {
#data frames for models including bp_dia
roc_rr <- roc(der_dat_final$icu_7d, der_dat_final$rr)# Calculate the ROC curve
optimal_cutoff <- coords(roc_rr, "best", ret = "threshold", transpose = TRUE)# Find the optimal cut-off value that maximizes sensitivity + specificity - 1
corresponding_rr_value <- der_dat_final$rr[which.min(abs(der_dat_final$rr - optimal_cutoff))]# Find the corresponding 'rr' value at the optimal cut-off point
print(paste("Corresponding 'rr' value for the optimal cut-off value:", corresponding_rr_value))# Print the corresponding 'rr' value

roc_spo2 <- roc(der_dat_final$icu_7d, der_dat_final$spo2)
optimal_cutoff <- coords(roc_spo2, "best", ret = "threshold", transpose = TRUE)
corresponding_spo2_value <- der_dat_final$spo2[which.min(abs(der_dat_final$spo2 - optimal_cutoff))]
print(paste("Corresponding 'spo2' value for the optimal cut-off value:", corresponding_spo2_value))

roc_bp_dia <- roc(der_dat_final_full_model_with_labs$icu_7d, der_dat_final_full_model_with_labs$bp_dia)
optimal_cutoff <- coords(roc_bp_dia, "best", ret = "threshold", transpose = TRUE)
corresponding_bp_dia_value <- der_dat_final_full_model_with_labs$bp_dia[which.min(abs(der_dat_final_full_model_with_labs$bp_dia - optimal_cutoff))]
print(paste("Corresponding 'bp_dia' value for the optimal cut-off value:", corresponding_bp_dia_value))

der_dat_risk_score <- data.frame(
  icu_7d = der_dat_final$icu_7d,
  o2_supplement = der_dat_final$o2_supplement,
  impaired_consciousness = der_dat_final$impaired_consciousness,
  rr = ifelse(der_dat_final$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(der_dat_final$spo2 < corresponding_spo2_value, 1, 0),
  bp_dia = ifelse(der_dat_final_full_model_with_labs$bp_dia > corresponding_bp_dia_value, 1, 0)
)

# Calibration for the clinical model3
coef_o2_supplement <- 1.1291567
coef_impaired_consciousness <- 2.0675746
coef_rr <- 0.5184567
coef_spo2 <- -0.4524848
coef_bp_dia <- -0.3288151
intercept <- -1.6290295

#convert factors to continuous variables
der_dat_final$o2_supplement <- as.numeric(as.character(der_dat_final$o2_supplement))
der_dat_final$impaired_consciousness <- as.numeric(as.character(der_dat_final$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * der_dat_final$o2_supplement +
                         coef_impaired_consciousness * der_dat_final$impaired_consciousness +
                         #coef_num_comor * der_dat_final$num_comor +  
                         #coef_age * der_dat_final$age +
                         coef_rr * der_dat_final$rr +
                         #coef_bp_sys * der_dat_final$bp_sys + 
                         coef_bp_dia * der_dat_final_full_model_with_labs$bp_dia +
                         #coef_temp * der_dat_final$temp +  
                         coef_spo2 * der_dat_final$spo2 +
                         #coef_wbc_abs * der_dat_final$wbc_abs +
                         #coef_platelet_abs * der_dat_final$platelet_abs + 
                         #coef_urea * der_dat_final$urea +
                         #coef_creatinine * der_dat_final$creatinine +  
                         #coef_crp * der_dat_final$crp +
                         #coef_ldh * der_dat_final$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_clinical_model3 <- der_dat_final_full_model_with_labs
dat_clinical_model3$icu_7d <- as.numeric(as.character(dat_clinical_model3$icu_7d))
df_calib_plot_clinical_model3 <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model3$icu_7d)
cali_result_clinical_model3 <- perform_calibration_analysis(df_calib_plot_clinical_model3$pred_risk, df_calib_plot_clinical_model3$true_outcome)

# Calibration for the clinical model4
coef_o2_supplement <- 1.1673183
coef_impaired_consciousness <- 1.9170308
coef_rr <- 0.7519391
coef_spo2 <- 0.8881070
coef_bp_dia <- -0.3360711
intercept <- -2.0176201

#convert factors to continuous variables
der_dat_risk_score$o2_supplement <- as.numeric(as.character(der_dat_risk_score$o2_supplement))
der_dat_risk_score$impaired_consciousness <- as.numeric(as.character(der_dat_risk_score$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * der_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * der_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * der_dat_risk_score$num_comor +  
                         #coef_age * der_dat_risk_score$age +
                         coef_rr * der_dat_risk_score$rr +
                         #coef_bp_sys * der_dat_risk_score$bp_sys + 
                         coef_bp_dia * der_dat_risk_score$bp_dia +
                         #coef_temp * der_dat_risk_score$temp +  
                         coef_spo2 * der_dat_risk_score$spo2 +
                         #coef_wbc_abs * der_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * der_dat_risk_score$platelet_abs + 
                         #coef_urea * der_dat_risk_score$urea +
                         #coef_creatinine * der_dat_risk_score$creatinine +  
                         #coef_crp * der_dat_risk_score$crp +
                         #coef_ldh * der_dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_clinical_model4 <- der_dat_risk_score
dat_clinical_model4$icu_7d <- as.numeric(as.character(dat_clinical_model4$icu_7d))
df_calib_plot_clinical_model4 <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model4$icu_7d)
cali_result_clinical_model4 <- perform_calibration_analysis(df_calib_plot_clinical_model4$pred_risk, df_calib_plot_clinical_model4$true_outcome)
}

if(FALSE) {
# Calibration for clinical model (continuous variables remain continuous)
#Plot for the clinical model
coef_o2_supplement <- 0.9345135
coef_impaired_consciousness <- 1.6277604
coef_rr <- 0.3905663
coef_spo2 <- -0.3423773
intercept <- -1.4405898

#convert factors to continuous variables
der_dat_final$o2_supplement <- as.numeric(as.character(der_dat_final$o2_supplement))
der_dat_final$impaired_consciousness <- as.numeric(as.character(der_dat_final$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * der_dat_final$o2_supplement +
                         coef_impaired_consciousness * der_dat_final$impaired_consciousness +
                         #coef_num_comor * der_dat_final$num_comor +  
                         #coef_age * der_dat_final$age +
                         coef_rr * der_dat_final$rr +
                         #coef_bp_sys * der_dat_final$bp_sys + 
                         #coef_bp_dia * der_dat_final$bp_dia +
                         #coef_temp * der_dat_final$temp +  
                         coef_spo2 * der_dat_final$spo2 +
                         #coef_wbc_abs * der_dat_final$wbc_abs +
                         #coef_platelet_abs * der_dat_final$platelet_abs + 
                         #coef_urea * der_dat_final$urea +
                         #coef_creatinine * der_dat_final$creatinine +  
                         #coef_crp * der_dat_final$crp +
                         #coef_ldh * der_dat_final$ldh +
                         intercept
                         )

dat_clinical_model <- der_dat_final
dat_clinical_model$icu_7d <- as.numeric(as.character(dat_clinical_model$icu_7d))
df_calib_plot_clinical_model <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model$icu_7d)
der_cali_result_clinical_model <- perform_calibration_analysis(df_calib_plot_clinical_model$pred_risk, df_calib_plot_clinical_model$true_outcome)
}
```

```{r derivation_model apparent performance_clinical utility_old, fig.width=7.5, fig.height=6, echo = FALSE, eval = FALSE}
set.seed(123)

#make DCA for the model 'ABC'
if(exists('matrix_der')) {
  matrix_der_dca <- matrix_der %>% 
  mutate(icu_7d = as.numeric(as.character(matrix_der$icu_7d)))
} else if(exists('rcs_matrix_der')) {
  rcs_matrix_der_dca <- rcs_matrix_der %>% 
  mutate(icu_7d = as.numeric(as.character(rcs_matrix_der$icu_7d)))
}

if(exists('matrix_der')) {
  baseline_model_abc <- decision_curve(icu_7d ~
                                       sex +
                                       o2_supplement +
                                       impaired_consciousness +
                                       #obesity +
                                       #comor_cvd +
                                       #comor_chronic_lung +
                                       #comor_ckd +
                                       #comor_chronic_liver +
                                       #comor_chronic_lung_no_asthma +
                                       #num_comor +
                                       age +
                                       hr +
                                       rr +
                                       bp_sys +
                                       bp_dia +
                                       temp +
                                       spo2,
                                       #wbc_abs +
                                       #lympho_abs + +
                                       #neutro_abs +
                                       #platelet_abs +
                                       #urea +
                                       #creatinine +
                                       #crp +
                                       #ldh,
                                data = matrix_der_dca,
                                family = binomial(link ='logit'),
                                thresholds = seq(0, 1, by = .01),
                                study.design = 'cohort',
                                bootstraps = 1)
} else if(exists('rcs_matrix_der')) {
  baseline_model_abc <- decision_curve(icu_7d ~
                                       #sex +
                                       o2_supplement +
                                       impaired_consciousness +
                                       #obesity +
                                       #comor_cvd +
                                       #comor_chronic_lung +
                                       #comor_ckd +
                                       #comor_chronic_liver +
                                       #comor_chronic_lung_no_asthma +
                                       #num_comor +
                                       #age_k1 + age_k2 + age_k3 +
                                       #hr_k1 + hr_k2 + hr_k3 +
                                       rr_k1 + rr_k2 + rr_k3 +
                                       #bp_sys_k1 + bp_sys_k2 + bp_sys_k3 +
                                       #bp_dia_k1 + bp_dia_k2 + bp_dia_k3 +
                                       #temp_k1 + temp_k2 + temp_k3 +
                                       spo2_k1 + spo2_k2 + spo2_k3,
                                       #wbc_abs_k1 + wbc_abs_k2 + wbc_abs_k3 +
                                       #lympho_abs_k1 + lympho_abs_k2 + lympho_abs_k3 + +
                                       #neutro_abs_k1 + neutro_abs_k2 + neutro_abs_k3 +
                                       #platelet_abs_k1 + platelet_abs_k2 + platelet_abs_k3 +
                                       #urea_k1 + urea_k2 + urea_k3 +
                                       #creatinine_k1 + creatinine_k2 + creatinine_k3 +
                                       #crp_k1 + crp_k2 + crp_k3 +
                                       #ldh_k1 + ldh_k2 + ldh_k3,
                                data = rcs_matrix_der_dca,
                                family = binomial(link ='logit'),
                                thresholds = seq(0, 1, by = .01),
                                study.design = 'cohort',
                                bootstraps = 1)
}

plot_decision_curve(baseline_model_abc,  curve.names = "baseline model_ABC", ylim = c(0, 0.7), confidence.intervals = FALSE)

df_all <- data.frame(icu_7d = rcs_matrix_der_dca$icu_7d, der_pred_cross_score, predicted_prob_full_model_without_labs, predicted_prob_simplified_cross_model, predicted_risk_der)

# ggplot2 code to create DCA figure
x <- dcurves::dca(icu_7d ~ rcs_matrix_der_dca$icu_7d + der_pred_cross_score + predicted_prob_full_model_without_labs + predicted_prob_simplified_cross_model +  predicted_risk_der, data = df_all, time = 100, 
                    prevalence = 0.3081081)

# Define color and labels mapping
color_labels <- c(
                   'der_pred_cross_score' = '#B22222',
                   'predicted_risk_der' = '#32CD32',
                   'predicted_prob_simplified_cross_model' = '#7341D1',
                   'predicted_prob_full_model_without_labs' = '#f4915f',
                   'Treat All' = 'black', 
                   'Treat None' = 'grey'
)

# Define the desired line types
linetype_labels <- c(
  
                   'der_pred_cross_score' = 'solid',
                   'predicted_risk_der' = 'dashed',
                   'predicted_prob_simplified_cross_model' = 'dashed',
                   'predicted_prob_full_model_without_labs' = 'dashed',
                   'Treat All' = 'solid', 
                   'Treat None' = 'solid'
)

# Define the desired order of legend items
legend_order <- c('der_pred_cross_score',
                   'predicted_risk_der',
                   'predicted_prob_simplified_cross_model',
                   'predicted_prob_full_model_without_labs',
                   'Treat All', 
                   'Treat None'
                  )

# Define the desired legend labels
legend_labels <- c(
                   'der_pred_cross_score' = 'CROSS score',
                   'predicted_risk_der' = 'CROSS model',
                   'predicted_prob_simplified_cross_model' = 'sCROSS model',
                   'predicted_prob_full_model_without_labs' = 'Full model',
                   'Treat All' = 'Treat all', 
                   'Treat None' = 'Treat none'
)

# Convert to tibble and filter
df_plot <- as_tibble(x) %>%
  dplyr::filter(!is.na(net_benefit))

# ggplot with corrected line types in legend
ggplot(df_plot, aes(x = threshold, y = net_benefit)) +
  geom_smooth(aes(color = label, linetype = label), method = "loess", se = FALSE, size = 0.4) +
  coord_cartesian(ylim = c(0, 0.3)) +
  labs(title = "DCA for Multiple Models",
       x = "Threshold probability",
       y = "Net benefit") +
  theme_wx +
  theme(legend.position = "none") +
  #theme(legend.position = "right", legend.box = "horizontal") +
  scale_color_manual(values = color_labels, breaks = legend_order, labels = legend_labels) +
  scale_linetype_manual(values = linetype_labels, breaks = legend_order, labels = legend_labels) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))
```

```{r derivation_model apparent performance_clinical utility_new, fig.width=6, fig.height=6}
der_dat_cross <- der_dat_final_full_model_with_labs %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

der_dat_cross <- der_dat_cross %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_cross <- der_dat_cross %>%
  mutate(score_cross = rowSums(select(., score_rr:score_consciousness))) 

der_mod_cross <- glm(icu_7d ~ score_cross, data = der_dat_cross, family = binomial)# Fit a logistic regression model
der_pred_cross <- predict(der_mod_cross, type = "response")# Predict probabilities for the same data

#DCA for all
dat_cross <- data.frame(der_dat_cross, der_pred_cross)

dat_all <- data.frame(icu_7d = der_dat_cross$icu_7d, der_pred_cross, der_pred_news, der_pred_qsofa, der_pred_huang, der_pred_o2_supplement, der_pred_dl_poor, der_pred_ascl, der_pred_xie, der_pred_dl_death, der_pred_ds_crb65, der_pred_a_drop, der_pred_4c_mortality, der_pred_curb65, der_pred_crb65, der_pred_spo2, der_pred_acp, der_pred_shi, der_pred_call)

# ggplot2 code to create DCA figure
x <- dcurves::dca(icu_7d ~ der_pred_cross + der_pred_news + der_pred_qsofa + der_pred_huang + der_pred_o2_supplement + der_pred_dl_poor + der_pred_ascl + der_pred_xie +  der_pred_dl_death + der_pred_ds_crb65 + der_pred_a_drop + der_pred_4c_mortality + der_pred_curb65 + der_pred_crb65 + der_pred_spo2 + der_pred_acp + der_pred_shi + der_pred_call, data = dat_all, time = 100, 
                  #prevalence = 0.2952854
                  prevalence = 0.308)

# Define color and labels mapping
color_labels <- c(
  'der_pred_cross' = '#B22222', 'der_pred_news' = '#5085a5', 'der_pred_qsofa' = '#ff00cc',
  'der_pred_huang' = '#00a1de', 'der_pred_o2_supplement' = '#79b791',
  'der_pred_dl_poor' = '#ff7e6b', 'der_pred_ascl' = '#d5d86f',  
  'der_pred_xie' = '#660033', 'der_pred_dl_death' = '#f4915f',
  'der_pred_ds_crb65' = '#4169E1', 'der_pred_a_drop' = '#6fd890', 
  'der_pred_4c_mortality' = '#0f00ba', 'der_pred_curb65' = '#800080', 
  'der_pred_crb65' = '#40e0d0', 'der_pred_spo2' = '#cc3333',
  'der_pred_acp' = '#bc7ff7', 'der_pred_shi' = '#82d173', 
  'der_pred_call' = '#203f8b', 'Treat All' = 'black', 'Treat None' = 'grey'
)

# Define the desired line types
linetype_labels <- c(
  'der_pred_cross' = 'solid', 'der_pred_news' = 'dashed', 'der_pred_qsofa' = 'dashed', 
  'der_pred_huang' = 'dashed', 'der_pred_o2_supplement' = 'dashed', 
  'der_pred_dl_poor' = 'dashed', 'der_pred_ascl' = 'dashed', 
  'der_pred_xie' = 'dashed', 'der_pred_dl_death' = 'dashed', 
  'der_pred_ds_crb65' = 'dashed', 'der_pred_a_drop' = 'dashed', 
  'der_pred_4c_mortality' = 'dashed', 'der_pred_curb65' = 'dashed', 
  'der_pred_crb65' = 'dashed', 'der_pred_spo2' = 'dashed', 
  'der_pred_acp' = 'dashed', 'der_pred_shi' = 'dashed', 'der_pred_call' = 'dashed', 'Treat All' = 'solid', 'Treat None' = 'solid'
)

# Define the desired order of legend items
legend_order <- c('der_pred_cross', 'der_pred_news', 'der_pred_qsofa', 'der_pred_huang', 'der_pred_o2_supplement', 'der_pred_dl_poor', 'der_pred_ascl', 'der_pred_xie', 'der_pred_dl_death', 'der_pred_ds_crb65', 'der_pred_a_drop', 'der_pred_4c_mortality', 'der_pred_curb65', 'der_pred_crb65', 'der_pred_spo2', 'der_pred_acp', 'der_pred_shi', 'der_pred_call', 'Treat All', 'Treat None')

# Define the desired legend labels
legend_labels <- c(
  'der_pred_cross' = 'CROSS score', 'der_pred_news' = 'NEWS', 'der_pred_qsofa' = 'qSOFA', 
  'der_pred_huang' = 'Huang', 'der_pred_o2_supplement' = 'Oxygen supplementation', 
  'der_pred_dl_poor' = 'DL-poor', 'der_pred_ascl' = 'ASCL', 
  'der_pred_xie' = 'Xie', 'der_pred_dl_death' = 'DL-death', 
  'der_pred_ds_crb65' = 'DS CRB-65', 'der_pred_a_drop' = 'A-DROP', 
  'der_pred_4c_mortality' = '4C mortality', 'der_pred_curb65' = 'CURB-65', 
  'der_pred_crb65' = 'CRB-65', 'der_pred_spo2' = 'Oxygen saturation', 
  'der_pred_acp' = 'ACP index', 'der_pred_shi' = 'Shi', 'der_pred_call' = 'CALL', 'Treat All' = 'Treat all', 'Treat None' = 'Treat none'
)

# Convert to tibble and filter
df_plot <- as_tibble(x) %>%
  dplyr::filter(!is.na(net_benefit))

# ggplot with corrected line types in legend
ggplot(df_plot, aes(x = threshold, y = net_benefit)) +
  geom_smooth(aes(color = label, linetype = label), method = "loess", se = FALSE, size = 0.4) +
  coord_cartesian(ylim = c(-0.1, 0.3)) +
  labs(title = "DCA for Multiple Models",
       x = "Threshold probability",
       y = "Net benefit") +
  theme_wx +
  theme(legend.position = 'none') +
  #theme(legend.position = "right", legend.box = "horizontal") +
  scale_color_manual(values = color_labels, breaks = legend_order, labels = legend_labels) +
  scale_linetype_manual(values = linetype_labels, breaks = legend_order, labels = legend_labels) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))
```

```{r derivation_figure_Association between each predictor and the outcome from the final model trained on the full development cohort, fig.width=12, fig.height=12, echo = FALSE, eval = FLASE}
# Predict the risk using the fitted model
predicted_risk_der <- predict(fit_optimal_der, design_matrix_der, type = "response")

# Filter out continous variables
if(exists('matrix_der')) {
  continuous_vars <- c(
                     #'num_commor',
                     #'age', 
                     #'hr', 
                     'rr',
                     #'bp_sys', 
                     #'bp_dia', 
                     #'temp', 
                     'spo2'
                     #'wbc_abs', 
                     #'lympho_abs', 
                     #'neutro_abs', 
                     #'platelet_abs', 
                     #'urea', 
                     #'creatinine', 
                     #'crp', 
                     #'ldh'
                     )
} else if(exists('rcs_matrix_der')) {
  continuous_vars <- c(
                     #'num_commor' = c('num_commor_k1', 'num_commor_k2', 'num_commor_k3'),
                     #'age' = c('age_k1', 'age_k2', 'age_k3'), 
                     #'hr' = c('hr_k1', 'hr_k2', 'hr_k3'), 
                     'rr' = c('rr_k1', 'rr_k2', 'rr_k3'),
                     #'bp_sys' = c('bp_sys_k1', 'bp_sys_k2', 'bp_sys_k3'), 
                     #'bp_dia' = c('bp_dia_k1', 'bp_dia_k2', 'bp_dia_k3'), 
                     #'temp' = c('temp_k1', 'temp_k2', 'temp_k3'), 
                     'spo2' = c('spo2_k1', 'spo2_k2', 'spo2_k3')
                     #'wbc_abs'= c('wbc_abs_k1', 'wbc_abs_k2', 'wbc_abs_k3'), 
                     #'lympho_abs' = c('lympho_abs_k1', 'lympho_abs_k2', 'lympho_abs_k3'), 
                     #'neutro_abs' = c('neutro_abs_k1', 'neutro_abs_k2', 'neutro_abs_k3'), 
                     #'platelet_abs' = c('platelet_abs_k1', 'platelet_abs_k2', 'platelet_abs_k3'), 
                     #'urea'= c('urea_k1', 'urea_k2', 'urea_k3'), 
                     #'creatinine'= c('creatinine_k1', 'creatinine_k2', 'creatinine_k3'), 
                     #'crp' = c('crp_k1', 'crp_k2', 'crp_k3'), 
                     #'ldh' = c('ldh_k1', 'ldh_k2', 'ldh_k3')
                     )
}

# Create an empty list to store the scatter plots
asso_plots_list <- list()

# Iterate through each continuous predictor and create a scatter plot
if(exists('matrix_der')) {
  for (var in continuous_vars) {
  plot_data <- data.frame(predicted_risk_der = predicted_risk_der, predictor = matrix_der[, var])
  
  asso_plot <- ggplot(plot_data, aes(x = predictor, y = predicted_risk_der)) +
    geom_smooth() +
    labs(title = paste("Predicted Risk vs.", var),
         x = var,
         y = "Predicted Risk") +
    theme_wx
  
  asso_plots_list[[var]] <- asso_plot
}

} else if(exists('rcs_matrix_der')) {
  for (var in continuous_vars) {
  plot_data <- data.frame(predicted_risk_der = predicted_risk_der, predictor = rcs_matrix_der[, var])
  
  asso_plot <- ggplot(plot_data, aes(x = predictor, y = predicted_risk_der)) +
    geom_smooth() +
    labs(
         #title = paste("Predicted Risk vs.", var),
         title = paste("Predicted .", var),
         x = var,
         y = "Predicted risk") +
    theme_wx
  
  asso_plots_list[[var]] <- asso_plot
}
}

#modify the x range for each variable
asso_plots_list[['rr']] <- asso_plots_list[['rr']] +
   scale_x_continuous(limits = c(6, 45)) +
   #scale_x_continuous(limits = c(-2.455877, 7.055275)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['spo2']] <- asso_plots_list[['spo2']] +
   scale_x_continuous(limits = c(70, 100)) +
   #scale_x_continuous(limits = c(-11.77261, 1.314261)) +
   scale_y_continuous(limits = c(0.2, 0.5))

if(FALSE) {
asso_plots_list[['age']] <- asso_plots_list[['age']] +
   scale_x_continuous(limits = c(18, 100)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['hr']] <- asso_plots_list[['hr']] +
   scale_x_continuous(limits = c(40, 150)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['bp_sys']] <- asso_plots_list[['bp_sys']] +
   scale_x_continuous(limits = c(50, 250)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['bp_dia']] <- asso_plots_list[['bp_dia']] +
   scale_x_continuous(limits = c(10, 200)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['temp']] <- asso_plots_list[['temp']] +
   scale_x_continuous(limits = c(33, 42)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['wbc_abs']] <- asso_plots_list[['wbc_abs']] +
   scale_x_continuous(limits = c(0, 50)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['lympho_abs']] <- asso_plots_list[['lympho_abs']] +
   scale_x_continuous(limits = c(0, 20)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['neutro_abs']] <- asso_plots_list[['neutro_abs']] +
   scale_x_continuous(limits = c(0, 30)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['platelet_abs']] <- asso_plots_list[['platelet_abs']] +
   scale_x_continuous(limits = c(0, 600)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['urea']] <- asso_plots_list[['urea']] +
   scale_x_continuous(limits = c(5, 300)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['creatinine']] <- asso_plots_list[['creatinine']] +
   scale_x_continuous(limits = c(0, 10)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['crp']] <- asso_plots_list[['crp']] +
   scale_x_continuous(limits = c(0, 300)) +
   scale_y_continuous(limits = c(0.2, 0.5))

asso_plots_list[['ldh']] <- asso_plots_list[['ldh']] +
   scale_x_continuous(limits = c(10, 3000)) +
   scale_y_continuous(limits = c(0.2, 0.5))
}
          
#create the figure for 'sex'
if(FALSE) {
df_fig_asso <- data.frame(risk = predicted_risk_der, sex = der_dat_full_final[,'sex'])
df_fig_asso <- df_fig_asso %>% 
  rename(risk = s0)

df_fig_asso_sex <- df_fig_asso %>%
  group_by(sex) %>%
  summarise(mean = mean(risk),
            lci = t.test(risk)$conf.int[1],
            uci = t.test(risk)$conf.int[2])

df_fig_asso_sex$sex <- c('Female', 'Male')

asso_plots_list[['sex']] <- ggplot(data = df_fig_asso_sex) +
  geom_point(aes(x = sex, y = mean), color = "red", size = 0.75) +
  geom_errorbar(aes(x = sex, ymin = lci, ymax = uci), width = 0.02, color = "red", size = 1) +
  scale_y_continuous(limits = c(0.2, 0.4)) +
  theme_wx +
  labs(title = "Predicted risk by sex") +
  labs(x = "Sex", y = "Predicted Risk")
}

#create the figure for 'o2_supplement'
if(exists('matrix_der')) {
  df_fig_asso_o2_supplement <- data.frame(risk = predicted_risk_der, o2_supplement = matrix_der[,'o2_supplement'])
} else if(exists('rcs_matrix_der')) {
  df_fig_asso_o2_supplement <- data.frame(risk = predicted_risk_der, o2_supplement = rcs_matrix_der[,'o2_supplement'])
}
df_fig_asso_o2_supplement <- df_fig_asso_o2_supplement %>% rename(risk = s0)

df_fig_asso_o2_supplement <- df_fig_asso_o2_supplement %>%
  group_by(o2_supplement) %>%
  summarise(mean = mean(risk),
            lci = t.test(risk)$conf.int[1],
            uci = t.test(risk)$conf.int[2])

df_fig_asso_o2_supplement$o2_supplement <- c('Ambient air', 'Oxygen-assisited')

asso_plots_list[['o2_supplement']] <- ggplot(data = df_fig_asso_o2_supplement) +
  geom_point(aes(x = o2_supplement, y = mean), color = "red", size = 0.75) +
  geom_errorbar(aes(x = o2_supplement, ymin = lci, ymax = uci), width = 0.02, color = "red", size = 1) +
  scale_y_continuous(limits = c(0.1, 0.6)) +
  theme_wx +
  labs(title = "Predicted risk by o2_supplement") +
  labs(x = "o2_supplement", y = "Predicted Risk")

#create the figure for 'impaired_consciousness'
if(exists('matrix_der')) {
 df_fig_asso_impaired_consciousness <- data.frame(risk = predicted_risk_der, impaired_consciousness = matrix_der[,'impaired_consciousness'])
} else if(exists('rcs_matrix_der')) {
  df_fig_asso_impaired_consciousness <- data.frame(risk = predicted_risk_der, impaired_consciousness = rcs_matrix_der[,'impaired_consciousness'])
}

df_fig_asso_impaired_consciousness <- df_fig_asso_impaired_consciousness %>% rename(risk = s0)

df_fig_asso_impaired_consciousness <- df_fig_asso_impaired_consciousness %>%
  group_by(impaired_consciousness) %>%
  summarise(mean = mean(risk),
            lci = t.test(risk)$conf.int[1],
            uci = t.test(risk)$conf.int[2])

df_fig_asso_impaired_consciousness$impaired_consciousness <- c('normal consciousness', 'confusion')

asso_plots_list[['impaired_consciousness']] <- ggplot(data = df_fig_asso_impaired_consciousness) +
  geom_point(aes(x = impaired_consciousness, y = mean), color = "red", size = 0.75) +
  geom_errorbar(aes(x = impaired_consciousness, ymin = lci, ymax = uci), width = 0.02, color = "red", size = 1) +
  scale_y_continuous(limits = c(0.2, 0.8)) +
  theme_wx +
  labs(title = "Predicted risk by impaired_consciousness") +
  labs(x = "impaired_consciousness", y = "Predicted Risk")

# Arrange the scatter plots in a grid
grid.arrange(grobs = asso_plots_list, ncol = 2)

#save the image above
p <- grid.arrange(grobs = asso_plots_list, ncol = 2)

# Specify the file name and format (e.g., PNG, PDF, JPEG)
file_name <- "output_plot.png"  # Change the file name and format as needed

# Use ggsave to save the plot
ggsave(file_name, plot = p, width = 9, height = 24)  # Adjust width and height as needed
```

```{r derivation_univariable_association_four_var_continuous, fig.width=8, fig.height=6, echo = FALSE, eval = FALSE}
matrix_der <- der_dat_final

# Predict the risk using the fitted model
predicted_risk_der <- predict(fit_optimal_der, design_matrix_der, type = "response")

#plot for rr
df_rr <- data.frame(predicted_risk_der = predicted_risk_der, predictor = matrix_der[, 'rr'])
  
  plot_rr <- ggplot(df_rr, aes(x = predictor, y = predicted_risk_der)) +
    geom_smooth(method = "loess", color = 'black', fill = 'grey', size = 0.5) +
    labs(title = 'Respiratory rate (per min)',
         x = NULL,
         y = "Predicted risk") +
         ylim(0.2, 0.7) +
        theme_wx
  
#Plot for spo2  
df_spo2 <- data.frame(predicted_risk_der = predicted_risk_der, predictor = matrix_der[, 'spo2'])
  
  plot_spo2 <- ggplot(df_spo2, aes(x = predictor, y = predicted_risk_der)) +
    geom_smooth(method = "loess", color = 'black', fill = 'grey', size = 0.5) +
    labs(title = 'Oxygen saturation (%)',
         x = NULL,
         y = NULL) +
    ylim(0.2, 0.7) +
    theme_wx
  
#Plot for 'o2_supplement'
df_o2_supplement <- data.frame(risk = predicted_risk_der, o2_supplement = matrix_der[,'o2_supplement'])

df_o2_supplement <- df_o2_supplement %>% rename(risk = s0)

df_o2_supplement <- df_o2_supplement %>%
  group_by(o2_supplement) %>%
  summarise(mean = mean(risk),
            lci = t.test(risk)$conf.int[1],
            uci = t.test(risk)$conf.int[2])

df_o2_supplement$o2_supplement <- c('Ambient air', 'Supplementary oxygen')

plot_o2_supplement <- ggplot(data = df_o2_supplement) +
  geom_point(aes(x = o2_supplement, y = mean), color = "black", size = 0.8) +
  geom_errorbar(aes(x = o2_supplement, ymin = lci, ymax = uci), width = 0, color = "black", size = 0.5) +
  scale_y_continuous(limits = c(0.1, 0.6)) +
  theme_wx +
  ylim(0.18, 0.68) +
  labs(title = "Oxygen supplementation",
       x = NULL,
       y = "Predicted risk") 

#Plot for 'impaired_consciousness'
df_impaired_consciousness <- data.frame(risk = predicted_risk_der, impaired_consciousness = matrix_der[,'impaired_consciousness'])

df_impaired_consciousness <- df_impaired_consciousness %>% rename(risk = s0)

df_impaired_consciousness <- df_impaired_consciousness %>%
  group_by(impaired_consciousness) %>%
  summarise(mean = mean(risk),
            lci = t.test(risk)$conf.int[1],
            uci = t.test(risk)$conf.int[2])

df_impaired_consciousness$impaired_consciousness <- c('Normal', 'Confusion')
df_impaired_consciousness$impaired_consciousness <- factor(df_impaired_consciousness$impaired_consciousness, levels = c("Normal", "Confusion"))#manually set levels of the factor so that Normal would be on the left of the graph


plot_impaired_consciousness <- ggplot(data = df_impaired_consciousness) +
  geom_point(aes(x = impaired_consciousness, y = mean), color = "black", size = 0.8) +
  geom_errorbar(aes(x = impaired_consciousness, ymin = lci, ymax = uci), width = 0, color = "black", size = 0.5) +
  scale_y_continuous(limits = c(0.2, 0.7)) +
  theme_wx +
  ylim(0.18, 0.7) +
  labs(title = "Confusion",
       x = NULL,
       y = NULL) 

# Combine the four ggplot figures
combined_figure <- grid.arrange(plot_rr, plot_spo2, plot_o2_supplement, plot_impaired_consciousness, ncol = 2)

# Print the combined figure
print(combined_figure)
```

#4. Model external validation
```{r validation_data_full_MI_no_outcome, eval = FALSE, echo = FALSE}
val_dat_full <- val_dat

#missing pattern
missing_patterns_val_dat_full <- aggr(val_dat_full)
#summary(missing_patterns_der_dat_full)

missingness <- colMeans(is.na(val_dat_full)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

#select & reorder the selected variables
val_dat_full <- val_dat_full %>% 
  select(
  #ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  lympho_abs, 
  neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
val_dat_full_plausible <- val_dat_full %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
if(FALSE){preproc_params <- preProcess(der_dat_plausible, method = c("center", "scale"))
val_dat_full_plausible_scaled <- predict(preproc_params, newdata = val_dat_full_plausible)}

# Check if scaling was performed
if (exists("val_dat_full_plausible_scaled")) {
  dat_imp<- val_dat_full_plausible_scaled
} else {
  dat_imp <- val_dat_full_plausible
}

#multiple imputation
set.seed(123)

val_dat_full_plausible_no_icu <- subset(dat_imp, select = -icu_7d)
val_dat_full_plausible_imputed <- mice(data = val_dat_full_plausible_no_icu, m = 10, maxit = 10, printFlag = FALSE)
summary(val_dat_full_plausible_imputed)

# The 10 imputed datasets can be extracted as follows:
completed_val_dat_full_plausible <- list()

for (i in 1:10) {
  completed_val_dat_full_plausible[[i]] <- complete(val_dat_full_plausible_imputed, i)
}

#add icu_7d back into the imputed data set
for (i in 1:10) {
  completed_val_dat_full_plausible[[i]]$icu_7d <- dat_imp$icu_7d
}

mice::densityplot(val_dat_full_plausible_imputed)# Visualization of the distribution of the imputed variables

completed_val_dat_full_plausible_stacked <- do.call(rbind, completed_val_dat_full_plausible)

#assign the weight to each observation
completed_val_dat_full_plausible_stacked <- completed_val_dat_full_plausible_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

val_dat_full_plausible_stacked <- completed_val_dat_full_plausible_stacked

#winsorization of the data
cols_to_transform <- setdiff(names(val_dat_full_plausible_stacked), c( 
                                                     'ptcenter',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
val_dat_full_plausible_stacked_winso <- winso_df(val_dat_full_plausible_stacked, cols_to_transform)

val_dat_full_final <- val_dat_full_plausible_stacked_winso
```

```{r validation_data_full}
val_dat_full <- val_dat

#missing pattern
missing_patterns_val_dat_full <- aggr(val_dat_full)

missingness <- colMeans(is.na(val_dat_full)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

#select & reorder the selected variables
val_dat_full <- val_dat_full %>% 
  select(
  #ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  lympho_abs, 
  neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
val_dat_full_plausible <- val_dat_full %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
if(FALSE){preproc_params <- preProcess(der_dat_plausible, method = c("center", "scale"))
val_dat_full_plausible_scaled <- predict(preproc_params, newdata = val_dat_full_plausible)}

# Check if scaling was performed
if (exists("val_dat_full_plausible_scaled")) {
  dat_imp<- val_dat_full_plausible_scaled
} else {
  dat_imp <- val_dat_full_plausible
}

#multiple imputation
set.seed(123)

val_dat_full_plausible_imputed <- mice(data = dat_imp, m = 10, maxit = 10, printFlag = FALSE)
summary(val_dat_full_plausible_imputed)

#Check-ups after MI
#xyplot(val_dat_full_plausible_imputed, icu_7d ~ rr + impaired_consciousness + o2_supplement)#inspecting the original and imputed data
#densityplot(val_dat_full_plausible_imputed)
#stripplot(val_dat_full_plausible_imputed, pch = 29, cex = 1.2)

#plot(val_dat_full_plausible_imputed)#check if convergence was achieved

completed_val_dat_full_plausible <- lapply(1:10, function(i) complete(val_dat_full_plausible_imputed, i))# Extract the completed datasets

mice::densityplot(val_dat_full_plausible_imputed)# Visualization of the distribution of the imputed variables

val_dat_full_plausible_stacked <- do.call(rbind, completed_val_dat_full_plausible) # Stack the 10 imputed datasets

val_dat_full_plausible_stacked <- val_dat_full_plausible_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

#winsorization of the data
cols_to_transform <- setdiff(names(val_dat_full_plausible_stacked), c( 
                                                     'ptcenter',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
val_dat_full_plausible_stacked_winso <- winso_df(val_dat_full_plausible_stacked, cols_to_transform)

val_dat_full_final <- val_dat_full_plausible_stacked_winso
```

```{r validation_data_missing_pattern}
missing_patterns_val_dat <- aggr(val_dat)
#summary(missing_patterns_der_dat)

missingness <- colMeans(is.na(val_dat)) * 100
threshold <- 40
selected_vars <- names(missingness[missingness < threshold])

# Subset the original data frame to retain only the selected variables
val_dat <- val_dat[, selected_vars]

#select & reorder the selected variables
val_dat <- val_dat %>% 
  select(
  #ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  #comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  #lympho_abs, 
  #neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )
```

```{r validation_data_histogram_before_plausibility, echo = FALSE, eval = FALSE}
# Define a function for generating histograms
generate_histogram <- function(data, variable, xlim, main, xlab) {
  hist(
    data[[variable]],
    breaks = 100,
    xlim = xlim,
    main = main,
    xlab = xlab,
    ylab = 'Frequency'
  )
}

# Generate histograms for multiple variables
#generate_histogram(val_dat, 'hr', c(40, 150), 'Histogram of hr', 'hr [/min]')
generate_histogram(val_dat, 'rr', c(6, 60), 'Histogram of rr', 'rr [/min]')
#generate_histogram(val_dat, 'bp_sys', c(50, 250), 'Histogram of bp_sys', 'bp_sys [mmHg]')
generate_histogram(val_dat, 'bp_dia', c(10, 200), 'Histogram of bp_dia', 'bp_dia [mmHg]')
#generate_histogram(val_dat, 'temp', c(33, 42), 'Histogram of temp', 'temp [C]')
generate_histogram(val_dat, 'spo2', c(50, 100), 'Histogram of spo2', 'spo2 [%]')
#generate_histogram(val_dat, 'wbc_abs', c(0, 50), 'Histogram of wbc_abs', 'wbc_abs [10E9/l]')
#generate_histogram(val_dat, "neutro_abs", c(0, 30), "Histogram of neutro_abs", "neutro_abs [10E9/l]")
#generate_histogram(val_dat, "lympho_abs", c(0, 30), "Histogram of lympho_abs", "lympho_abs [10E9/l]")
#generate_histogram(val_dat, "platelet_abs", c(0, 700), "Histogram of platelet_abs", "platelet_abs [10E9/l]")
generate_histogram(val_dat, "urea", c(0, 400), "Histogram of urea", "urea [mg/dl]")
generate_histogram(val_dat, "crp", c(0, 500), "Histogram of crp", "crp [µg/ml]")
generate_histogram(val_dat, "ldh", c(0, 3000), "Histogram of ldh", "ldh [U/l]")
#generate_histogram(dat[dat$creatinine > 0 & dat$creatinine < 40], 'creatinine', c(0, 40), "Histogram of creatinine", "Creatinine [mg/dl]")

if(FALSE) {  
hist(val_dat$creatinine[val_dat$creatinine >= 0 & val_dat$creatinine <= 40],
     breaks = 100,
     xlim = c(0, 40),
     main = "Histogram of creatinine",
     xlab = "Creatinine [mg/dl]",
     ylab = "Frequency"
)
}
```

```{r validation_data_plausibility}
val_dat_plausible <- val_dat %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )
```

```{r validation_data_histogram_after_plausibility, echo = FALSE, eval = FALSE}
# Define a function for generating histograms
generate_histogram <- function(data, variable, xlim, main, xlab) {
  hist(
    data[[variable]],
    breaks = 100,
    xlim = xlim,
    main = main,
    xlab = xlab,
    ylab = 'Frequency'
  )
}

# Generate histograms for multiple variables
#generate_histogram(val_dat_plausible, 'hr', c(40, 150), 'Histogram of hr', 'hr [/min]')
generate_histogram(val_dat_plausible, 'rr', c(6, 60), 'Histogram of rr', 'rr [/min]')
generate_histogram(val_dat_plausible, 'bp_sys', c(50, 250), 'Histogram of bp_sys', 'bp_sys [mmHg]')
generate_histogram(val_dat_plausible, 'bp_dia', c(10, 200), 'Histogram of bp_dia', 'bp_dia [mmHg]')
#generate_histogram(val_dat_plausible, 'temp', c(33, 42), 'Histogram of temp', 'temp [C]')
generate_histogram(val_dat_plausible, 'spo2', c(50, 100), 'Histogram of spo2', 'spo2 [%]')
generate_histogram(val_dat_plausible, 'wbc_abs', c(0, 50), 'Histogram of wbc_abs', 'wbc_abs [10E9/l]')
#generate_histogram(val_dat_plausible, "neutro_abs", c(0, 30), "Histogram of neutro_abs", "neutro_abs [10E9/l]")
#generate_histogram(val_dat_plausible, "lympho_abs", c(0, 30), "Histogram of lympho_abs", "lympho_abs [10E9/l]")
#generate_histogram(val_dat_plausible, "platelet_abs", c(0, 700), "Histogram of platelet_abs", "platelet_abs [10E9/l]")
generate_histogram(val_dat_plausible, "urea", c(0, 400), "Histogram of urea", "urea [mg/dl]")
generate_histogram(val_dat_plausible, "crp", c(0, 500), "Histogram of crp", "crp [µg/ml]")
generate_histogram(val_dat_plausible, "ldh", c(0, 3000), "Histogram of ldh", "ldh [U/l]")
#generate_histogram(dat[dat$creatinine > 0 & dat$creatinine < 40], 'creatinine', c(0, 40), "Histogram of creatinine", "Creatinine [mg/dl]")

if(FALSE) {  
hist(val_dat_plausible$creatinine[val_dat_plausible$creatinine >= 0 & val_dat_plausible$creatinine <= 40],
     breaks = 100,
     xlim = c(0, 40),
     main = "Histogram of creatinine",
     xlab = "Creatinine [mg/dl]",
     ylab = "Frequency"
)
}
```

```{r validation_data_scaling_centering}
# Compute the transformation parameters on the training set
preproc_params <- preProcess(der_dat_plausible_standardization, method = c("center", "scale"))

# Apply the same transformation to the training set
val_dat_plausible_scaled <- predict(preproc_params, newdata = val_dat_plausible)
```

```{r validation_data_imputation_MI_no_outcome, echo = FALSE, eval = FALSE}
set.seed(123)

#check if scaling was executed
if(exists('val_dat_plausible_scaled')){
  dat_imp <-  val_dat_plausible_scaled
} else {
  dat_imp <- val_dat_plausible
}

dat_imp_no_icu <- subset(dat_imp, select = -icu_7d)
val_dat_plausible_scaled_imputed <- mice(dat_imp_no_icu, m = 10, maxit = 10, printFlag = FALSE)
summary(val_dat_plausible_scaled_imputed)

# The 10 imputed datasets can be extracted as follows:
completed_val_dat_plausible_scaled <- list()

for (i in 1:10) {
  completed_val_dat_plausible_scaled[[i]] <- complete(val_dat_plausible_scaled_imputed, i)
}

#add icu_7d back into the imputed data set
for (i in 1:10) {
  completed_val_dat_plausible_scaled[[i]]$icu_7d <- dat_imp$icu_7d
}

mice::densityplot(val_dat_plausible_scaled_imputed)# Visualization of the distribution of the imputed variables

val_dat_plausible_scaled_stacked <- do.call(rbind, completed_val_dat_plausible_scaled)

#assign the weight to each observation
val_dat_plausible_scaled_stacked <- val_dat_plausible_scaled_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)
```

```{r validation_data_imputation}
set.seed(123)

#check if scaling was executed
if(exists('val_dat_plausible_scaled')){
  dat_imp <-  val_dat_plausible_scaled
} else {
  dat_imp <- val_dat_plausible
}

#dat_imp <- subset(dat_imp, rowSums(is.na(dat_imp)) < 0.4 * ncol(dat_imp))
#dat_imp <- subset(dat_imp, rowSums(is.na(dat_imp)) <= 6)

val_dat_plausible_scaled_imputed <- mice(dat_imp, m = 10, maxit = 10, printFlag = FALSE)
summary(val_dat_plausible_scaled_imputed)

#Check-ups after MI
#xyplot(val_dat_plausible_scaled_imputed, icu_7d ~ rr + o2_supplement + impaired_consciousness)#inspecting the original and imputed data
#densityplot(val_dat_plausible_scaled_imputed)
#stripplot(val_dat_plausible_scaled_imputed, pch = 29, cex = 1.2)

#plot(val_dat_plausible_scaled_imputed)#check if convergence was achieved

completed_val_dat_plausible_scaled <- lapply(1:10, function(i) complete(val_dat_plausible_scaled_imputed, i))# Extract the completed datasets

mice::densityplot(val_dat_plausible_scaled_imputed)# Visualization of the distribution of the imputed variables

val_dat_plausible_scaled_stacked <- do.call(rbind, completed_val_dat_plausible_scaled) # Stack the 10 imputed datasets

val_dat_plausible_scaled_stacked <- val_dat_plausible_scaled_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)
```

```{r validation_data_imputed_winsorization}
cols_to_transform <- setdiff(names(val_dat_plausible_scaled_stacked), c( 
                                                     'ptcenter',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
val_dat_plausible_scaled_stacked_winso <- winso_df(val_dat_plausible_scaled_stacked, cols_to_transform)
```

```{r validation_data_variable distribution, eval = FALSE, echo = FALSE}
distri <- function(data, var) {
  # Density plot/histogram
  hist_plot <- ggplot(data = data, aes(x = !!sym(var))) +
    geom_density(fill = 'lightgreen', alpha = 0.5) + 
    #geom_histogram() +
    xlab(var) +
    ylab("Density") +
    ggtitle(paste0('Density plot of ', var))
  
    # QQ plot
  qq_plot <- ggplot(data = data, aes(sample = !!sym(var))) +
    stat_qq() +
    stat_qq_line() +
    labs(x = "Theoretical Quantiles", 
         y = "Sample Quantiles",
         title = paste0('Q-Q Plot of ', var))
  
    # Box plot
  box_plot <- ggplot(data = data, aes(x = data$icu_7d, y = !!sym(var))) +
    geom_boxplot() +
    ggtitle(paste0('Boxplot of ', var))
  
 # Compute skewness and kurtosis
  skewness_value <- skewness(data[[var]])
  kurtosis_value <- kurtosis(data[[var]])
  
  return(list(hist_plot = hist_plot, qq_plot = qq_plot, box_plot = box_plot, skewness = skewness_value, kurtosis = kurtosis_value))#In addition to 'list', 'data frame' should also work should the elements be all non-figure objects. 
  }

#remove the outcome
der_dat_predictors <- subset(der_dat, select = -c(icu_7d
                                                  #ptcenter,
                                                  #weight
                                                  )
                             )

# Create a list for the analysis
distri_list_der <- list()

for (var in names(der_dat_predictors)) {
  if (is.numeric(der_dat_predictors[[var]])) {
    distri_list_der[[var]] <- distri(der_dat_predictors, var)
  }
}

#distri_list_der

#remove the outcome
val_dat_predictors <- subset(val_dat, select = -c(icu_7d
                                                  #ptcenter,
                                                  #weight
                                                  )
                             )

# Create a list for the analysis
distri_list_val <- list()

for (var in names(val_dat_predictors)) {
  if (is.numeric(val_dat_predictors[[var]])) {
    distri_list_val[[var]] <- distri(val_dat_predictors, var)
  }
}

#distri_list_val
```

```{r validation_final_data}
variables_clinical_model <- c('icu_7d',
               #'sex', 
               'o2_supplement',
               'impaired_consciousness',
               #'obesity',
               #'comor_cvd',
               #'comor_chronic_lung',
               #'comor_ckd',
               #'comor_chronic_liver',
               #'comor_chronic_lung_no_asthma',
               #'num_comor',
               #'age', 
               #'hr', 
               'rr',
               #'bp_sys', 
               #'bp_dia',
               #'temp', 
               'spo2'
               #'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               #'platelet_abs',
               #'urea',
               #'creatinine',
               #'crp',
               #'ldh'
               )

val_dat_final <- val_dat_plausible_scaled_stacked_winso[variables_clinical_model]

variables_full_model_with_labs <- c('icu_7d',
               'sex', 
               'o2_supplement',
               'impaired_consciousness',
               #'obesity',
               #'comor_cvd',
               #'comor_chronic_lung',
               #'comor_ckd',
               #'comor_chronic_liver',
               #'comor_chronic_lung_no_asthma',
               'num_comor',
               'age', 
               'hr', 
               'rr',
               'bp_sys', 
               'bp_dia',
               'temp', 
               'spo2',
               'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               'platelet_abs',
               'urea',
               'creatinine',
               'crp',
               'ldh'
               )

val_dat_final_full_model_with_labs <- val_dat_plausible_scaled_stacked_winso[variables_full_model_with_labs]

#glimpse(val_dat_plausible_scaled_stacked)
#summary(val_dat_plausible_scaled_stacked)
```

```{r validation_xgboost_model}
# Common set of variables
common_variables <- c(
  'icu_7d',
  'sex', 
  'o2_supplement',
  'impaired_consciousness',
  'age', 
  'hr', 
  'rr',
  'bp_sys', 
  'bp_dia',
  'temp', 
  'spo2'
)

# Variables for der_dat_final
val_dat_final_importance <- val_dat_plausible_scaled_stacked_winso[, common_variables]
val_dat_final_importance$sex <- ifelse(val_dat_final_importance$sex == 'female', 1, 0)
val_dat_final_importance$impaired_consciousness <- as.numeric(as.character(val_dat_final_importance$impaired_consciousness))
val_dat_final_importance$o2_supplement <- as.numeric(as.character(val_dat_final_importance$o2_supplement))

# Train an xgboost model
X <- as.matrix(val_dat_final_importance[, -1])  # Exclude the response variable
y <- as.numeric(as.character(val_dat_final_importance$icu_7d))

xgb_data_val <- xgb.DMatrix(data = X, label = y)
#xgb_model_val <- xgboost(data = xgb_data, nrounds = 10, objective = "binary:logistic")

predictions <- predict(xgb_model_der, xgb_data_val)# Make predictions
roc_obj <- roc(y, predictions)# Calculate AUC
```

```{r validation_rcs}
#without rcs
if(FALSE) {
matrix_val <- val_dat_final
matrix_val_predictors <- matrix_val[, -1]# Exclude the response variable
design_matrix_val <- model.matrix(~ . - 1, data = matrix_val_predictors) #-1: remove the intercept
design_matrix_val <- design_matrix_val[, -1] #remove 'icu_7d0'
}

# Define the list of continuous variables and apply restricted cubic splines with 4 knots to each continuous variable
if(TRUE) {
continuous_vars <- c(
               #'num_comor',
               #'age', 
               #'hr', 
               'rr',
               #'bp_sys' ,
               #'bp_dia' ,
               #'temp', 
               'spo2'
               #'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               #'platelet_abs',
               #'urea',
               #'creatinine',
               #'crp',
               #'ldh'
               )

rcs_terms_val <- lapply(continuous_vars, function(var) rcs(val_dat_final[[var]], 4))

# Combine the RCS terms into the design matrix
rcs_matrix_val <- cbind(
  val_dat_final[c('icu_7d', # Include categorical variables
                  #'sex', 
                  'o2_supplement',
                  'impaired_consciousness'
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma'
                  #'num_comor'
               )],  
                  do.call(cbind, rcs_terms_val)
)

column_names <- c(
                  'icu_7d', # Rename the columns of the resulting data frame
                  #'sex', 
                  'o2_supplement', 
                  'impaired_consciousness',
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma',
                  #'num_comor',
                  sapply(continuous_vars, function(var) paste(var, c("k1", "k2", "k3"), sep = "_"))
                  )

colnames(rcs_matrix_val) <- column_names

# Create a design matrix with factors preserved
rcs_matrix_val_predictors <- rcs_matrix_val[, -1]# Exclude the response variable
design_matrix_val <- model.matrix(~ . - 1, data = rcs_matrix_val_predictors) #-1: remove the intercept
design_matrix_val <- design_matrix_val[, -1] #remove 'icu_7d0'
}
```

```{r validation_model apparent performance_discrimination, fig.width=6, fig.height=6}
# ABC model
val_pred_abc <- predict(fit_optimal_der, design_matrix_val, type = "response")
if(exists('matrix_val')) {
  val_obs_abc <- matrix_val$icu_7d
} else if(exists('rcs_matrix_val')) {
  val_obs_abc <- rcs_matrix_val$icu_7d
}

val_roc_abc <- roc(val_obs_abc, val_pred_abc, smooth = T)

# 4C mortality score
val_dat_4c_mortality <- val_dat_full_final %>% #create the data frame
  select(age, 
         sex,
         num_comor,
         rr,
         spo2,
         impaired_consciousness,
         urea,
         crp,
         icu_7d)

val_dat_4c_mortality <- val_dat_4c_mortality %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 2,
    age >= 60 & age <= 69 ~ 4,
    age >= 70 & age <= 79 ~ 6,
    age >= 80 ~ 7
  ), 
  score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
  score_num_comor = case_when(
    num_comor == 0 ~ 0,
    num_comor == 1 ~ 1,
    num_comor >= 2 ~ 2
  ),
  score_rr = case_when(
    rr < 20 ~ 0,
    rr >= 20 & rr <= 29 ~ 1,
    rr >= 30 ~ 2
  ),
  score_spo2 = case_when(
    spo2 >= 92 ~ 0,
    spo2 < 92 ~ 2
  ),
  score_impaired_consciousness = case_when(
    impaired_consciousness == '0' ~ 0,
    impaired_consciousness == '1' ~ 1
  ),
  score_urea = case_when(
    urea < 7 ~ 0,
    urea >= 7 & urea <= 14 ~ 1,
    urea > 14 ~ 3
  ),
  score_crp = case_when(
    crp < 50 ~ 0,
    crp >= 50 & crp < 100 ~ 1,
    crp >= 100 ~ 2
  )
  )

val_dat_4c_mortality <- val_dat_4c_mortality %>%
  mutate(val_score_4c_mortality = rowSums(select(., score_age:score_crp))) 

val_mod_4c_mortality <- glm(icu_7d ~ val_score_4c_mortality, data = val_dat_4c_mortality, family = binomial)# Fit a logistic regression model
val_pred_4c_mortality <- predict(val_mod_4c_mortality, type = "response")# Predict probabilities for the same data
val_obs_4c_mortality <- val_dat_4c_mortality$icu_7d
val_roc_4c_mortality <- roc(val_obs_4c_mortality, val_pred_4c_mortality)# Calculate the ROC curve

# NEWS score
val_dat_news <- val_dat_full_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         bp_sys,
         hr,
         temp,
         icu_7d)

val_dat_news <- val_dat_news %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr >= 12 & rr <= 20 ~ 0,
    rr >= 9 & rr <= 11 ~ 1,
    rr >= 21 & rr <= 24 ~ 2,
    rr >= 25 | rr <= 8 ~ 3
  ),
    score_spo2 = case_when(
    spo2 >= 96 ~ 0,
    spo2 >= 94 & spo2 <= 95 ~ 1,
    spo2 >= 92 & spo2 <= 93 ~ 2,
    spo2 <= 91 ~ 3
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_temp = case_when(
    temp >= 36.1 & temp <= 38.0 ~ 0,
    (temp >= 35.1 & temp <= 36) | (temp >= 38.1 & temp <= 39) ~ 1,
    temp >= 39.1 ~ 2,
    temp <= 35.0 ~ 3
  ),
    score_bp_sys = case_when(
    bp_sys >= 111 & bp_sys <= 219 ~ 0,
    bp_sys >= 101 & bp_sys <= 110 ~ 1,
    bp_sys >= 91 & bp_sys <= 100 ~ 2,
    bp_sys >= 220 | bp_sys <= 90 ~ 3
  ),
    score_hr = case_when(
    hr >= 51 & hr <= 90 ~ 0,
    (hr >= 41 & hr <= 50) | (hr >= 91 & hr <= 110) ~ 1,
    hr >= 111 & hr <= 130 ~ 2,
    hr >= 131 | hr <= 40 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

val_dat_news <- val_dat_news %>%
  mutate(val_score_news = rowSums(select(., score_rr:score_consciousness))) 

val_mod_news <- glm(icu_7d ~ val_score_news, data = val_dat_news, family = binomial)# Fit a logistic regression model
val_pred_news <- predict(val_mod_news, type = "response")# Predict probabilities for the same data
val_obs_news <- val_dat_news$icu_7d
val_roc_news <- roc(val_obs_news, val_pred_news)# Calculate the ROC curve

# CURB-65 score
val_dat_curb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         urea,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

val_dat_curb65 <- val_dat_curb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

val_dat_curb65 <- val_dat_curb65 %>%
  mutate(val_score_curb65 = rowSums(select(., score_consciousness:score_age))) 

val_mod_curb65 <- glm(icu_7d ~ val_score_curb65, data = val_dat_curb65, family = binomial)# Fit a logistic regression model
val_pred_curb65 <- predict(val_mod_curb65, type = "response")# Predict probabilities for the same data
val_obs_curb65 <- val_dat_curb65$icu_7d
val_roc_curb65 <- roc(val_obs_curb65, val_pred_curb65)# Calculate the ROC curve

# CRB-65 score
val_dat_crb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

val_dat_crb65 <- val_dat_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

val_dat_crb65 <- val_dat_crb65 %>%
  mutate(val_score_crb65 = rowSums(select(., score_consciousness:score_age))) 

val_mod_crb65 <- glm(icu_7d ~ val_score_crb65, data = val_dat_crb65, family = binomial)# Fit a logistic regression model
val_pred_crb65 <- predict(val_mod_crb65, type = "response")# Predict probabilities for the same data
val_obs_crb65 <- val_dat_crb65$icu_7d
val_roc_crb65 <- roc(val_obs_crb65, val_pred_crb65)# Calculate the ROC curve

# A-DROP score
val_dat_a_drop <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         urea,
         bp_sys,
         age,
         sex,
         spo2,
         icu_7d)

val_dat_a_drop <- val_dat_a_drop %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_spo2 = case_when(
    spo2 <= 90 ~ 1,
    spo2 > 90 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 90 ~ 1,
    bp_sys > 90 ~ 0
  ),
    score_age = case_when(
    (age >= 70 & sex ==  'male') | (age >= 75 & sex ==  'female') ~ 1,
    (age < 70 & sex ==  'male') | (age < 75 & sex ==  'female') ~ 0
  )
  )

val_dat_a_drop <- val_dat_a_drop %>%
  mutate(val_score_a_drop = rowSums(select(., score_consciousness:score_age))) 

val_mod_a_drop <- glm(icu_7d ~ val_score_a_drop, data = val_dat_a_drop, family = binomial)# Fit a logistic regression model
val_pred_a_drop <- predict(val_mod_a_drop, type = "response")# Predict probabilities for the same data
val_obs_a_drop <- val_dat_a_drop$icu_7d
val_roc_a_drop <- roc(val_obs_a_drop, val_pred_a_drop)# Calculate the ROC curve

# DS CRB-65 score
val_dat_ds_crb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         spo2,
         num_comor,
         icu_7d)

val_dat_ds_crb65 <- val_dat_ds_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  ),
    score_spo2 = case_when(
    spo2 >= 90 ~ 0,
    spo2 < 90 ~ 1
  ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  )
  )

val_dat_ds_crb65 <- val_dat_ds_crb65 %>%
  mutate(val_score_ds_crb65 = rowSums(select(., score_consciousness:score_num_comor))) 

val_mod_ds_crb65 <- glm(icu_7d ~ val_score_ds_crb65, data = val_dat_ds_crb65, family = binomial)# Fit a logistic regression model
val_pred_ds_crb65 <- predict(val_mod_ds_crb65, type = "response")# Predict probabilities for the same data
val_obs_ds_crb65 <- val_dat_ds_crb65$icu_7d
val_roc_ds_crb65 <- roc(val_obs_ds_crb65, val_pred_ds_crb65)# Calculate the ROC curve

# DL-death model
coef_age <- log(1.01) # Existing logistic regression model coefficients
coef_sex <- log(0.45)
coef_neutro_abs <- log(1.25)#unit: 10^9/L
coef_lympho_abs <- log(0.27)#unit: 10^9/L
coef_platelet_abs <- log(0.99)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1) #unit: μmol/L
#intercept <- 4.203

val_dat_full_final_sex <- val_dat_full_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
val_dat_full_final_sex$sex <- ifelse(val_dat_full_final$sex == "Male", 1, 0)
val_pred_dl_death <- plogis(coef_age * val_dat_full_final_sex$age + 
                         coef_sex * val_dat_full_final_sex$sex +
                         coef_neutro_abs * val_dat_full_final_sex$neutro_abs +  
                         coef_lympho_abs * val_dat_full_final_sex$lympho_abs + 
                         coef_platelet_abs * val_dat_full_final_sex$platelet_abs + 
                         coef_crp * val_dat_full_final_sex$crp + 
                         coef_creatinine * val_dat_full_final_sex$creatinine 
                        #intercept
                         )

val_obs_dl_death <- val_dat_full_final_sex$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_dl_death <- roc(val_obs_dl_death, val_pred_dl_death, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# DL-poor model
coef_age <- log(1.03) # Existing logistic regression model coefficients
coef_sex <- log(0.62)
coef_neutro_abs <- log(1.29)#unit: 10^9/L
coef_lympho_abs <- log(0.31)#unit: 10^9/L
coef_platelet_abs <- log(1)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1.01) #unit: μmol/L
#intercept <- 4.203

val_dat_full_final_sex <- val_dat_full_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
val_dat_full_final_sex$sex <- ifelse(val_dat_full_final$sex == "Male", 1, 0)
val_pred_dl_poor <- plogis(coef_age * val_dat_full_final_sex$age + 
                         coef_sex * val_dat_full_final_sex$sex +
                         coef_neutro_abs * val_dat_full_final_sex$neutro_abs +  
                         coef_lympho_abs * val_dat_full_final_sex$lympho_abs + 
                         coef_platelet_abs * val_dat_full_final_sex$platelet_abs + 
                         coef_crp * val_dat_full_final_sex$crp + 
                         coef_creatinine * val_dat_full_final_sex$creatinine 
                        #intercept
                         )

val_obs_dl_poor <- val_dat_full_final_sex$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_dl_poor <- roc(val_obs_dl_poor, val_pred_dl_poor, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# qSOFA score
val_dat_qsofa <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         icu_7d)

val_dat_qsofa <- val_dat_qsofa %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 22 ~ 1,
    rr < 22 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 100 ~ 1,
    bp_sys > 100 ~ 0
    )
   )

val_dat_qsofa <- val_dat_qsofa %>%
  mutate(val_score_qsofa = rowSums(select(., score_consciousness:score_bp))) 

val_mod_qsofa <- glm(icu_7d ~ val_score_qsofa, data = val_dat_qsofa, family = binomial)# Fit a logistic regression model
val_pred_qsofa <- predict(val_mod_qsofa, type = "response")# Predict probabilities for the same data
val_obs_qsofa <- val_dat_qsofa$icu_7d
val_roc_qsofa <- roc(val_obs_qsofa, val_pred_qsofa)# Calculate the ROC curve

# ACP index
val_dat_acp <- val_dat_full_final %>% #create the data frame
  select(age,
         crp,
         icu_7d)

val_dat_acp <- val_dat_acp %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age >= 60 ~ 1,
    age < 60 ~ 0
  ),
    score_crp = case_when(
    crp >= 34 ~ 1,#unit: mg/L
    crp < 34 ~ 0
  )
   )

val_dat_acp <- val_dat_acp %>%
  mutate(val_score_acp = rowSums(select(., score_age:score_crp))) 

val_mod_acp <- glm(icu_7d ~ val_score_acp, data = val_dat_acp, family = binomial)# Fit a logistic regression model
val_pred_acp <- predict(val_mod_acp, type = "response")# Predict probabilities for the same data
val_obs_acp <- val_dat_acp$icu_7d
val_roc_acp <- roc(val_obs_acp, val_pred_acp)# Calculate the ROC curve

# ASCL score
val_dat_ascl <- val_dat_full_final %>% #create the data frame
  select(age,
         sex,
         crp,
         ldh,
         icu_7d)

val_dat_ascl <- val_dat_ascl %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 1,
    age >= 60 & age <= 69 ~ 2,
    age >= 70 & age <= 79 ~ 3,
    age >= 80 ~ 4
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_crp = case_when(
    crp > 60 ~ 2,#unit: mg/L
    crp <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 300 ~ 0,#unit: U/L
    ldh > 300 ~ 2
  )
   )

val_dat_ascl <- val_dat_ascl %>%
  mutate(val_score_ascl = rowSums(select(., score_age:score_ldh))) 

val_mod_ascl <- glm(icu_7d ~ val_score_ascl, data = val_dat_ascl, family = binomial)# Fit a logistic regression model
val_pred_ascl <- predict(val_mod_ascl, type = "response")# Predict probabilities for the same data
val_obs_ascl <- val_dat_ascl$icu_7d
val_roc_ascl <- roc(val_obs_ascl, val_pred_ascl)# Calculate the ROC curve

# Huang model
coef_num_comor <- 2.752# Existing logistic regression model coefficients
coef_rr <- 4.056
coef_crp <- 2.424#unit: 10^9/L
coef_ldh <- 5.392#unit: 10^9/L
intercept <- -6.488

val_dat_full_final_huang <- val_dat_full_final
val_dat_full_final_huang <- val_dat_full_final_huang %>% #computation of 4C score for each patient
  mutate(num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  ),
    rr = case_when(
    rr > 24 ~ 1,
    rr <= 24 ~ 0
  ),
    crp = case_when(
    crp > 10 ~ 1,#unit: mg/L
    crp <= 10 ~ 0
  ),
    ldh = case_when(
    ldh <= 250 ~ 0,#unit: U/L
    ldh > 250 ~ 1
  )
   )

val_pred_huang <- plogis(coef_num_comor * val_dat_full_final_huang$num_comor + 
                         coef_rr * val_dat_full_final_huang$rr +
                         coef_crp * val_dat_full_final_huang$crp +  
                         coef_ldh * val_dat_full_final_huang$ldh +
                         intercept
                         )

val_obs_huang <- val_dat_full_final_huang$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_huang <- roc(val_obs_huang, val_pred_huang, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# CALL score
val_dat_call <- val_dat_full_final %>% #create the data frame
  select(num_comor,
         age,
         lympho_abs,
         ldh,
         icu_7d)

val_dat_call <- val_dat_call %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age <= 60 ~ 1,
    age > 60 ~ 3,
    ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor <= 1 ~ 3
    ),
    score_lympho_abs = case_when(
    lympho_abs > 1 ~ 2,#unit: mg/L
    lympho_abs <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 250 ~ 1,#unit: U/L
    ldh > 250 & ldh <= 500 ~ 2,
    ldh > 500 ~ 3
  )
   )

val_dat_call <- val_dat_call %>%
  mutate(val_score_call = rowSums(select(., score_age:score_ldh))) 

val_mod_call <- glm(icu_7d ~ val_score_call, data = val_dat_call, family = binomial)# Fit a logistic regression model
val_pred_call <- predict(val_mod_call, type = "response")# Predict probabilities for the same data
val_obs_call <- val_dat_call$icu_7d
val_roc_call <- roc(val_obs_call, val_pred_call)# Calculate the ROC curve

# SHI score
val_dat_shi <- val_dat_full_final %>% #create the data frame
  select(age,
         sex,
         bp_sys,
         bp_dia,
         icu_7d)

val_dat_shi <- val_dat_shi %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 ~ 1
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_hbp = case_when(
    bp_sys >= 130 | bp_dia >= 80 ~ 1,#unit: mg/L
    bp_sys < 130 & bp_dia < 80 ~ 0
  )
   )

val_dat_shi <- val_dat_shi %>%
  mutate(val_score_shi = rowSums(select(., score_age:score_hbp))) 

val_mod_shi <- glm(icu_7d ~ val_score_shi, data = val_dat_shi, family = binomial)# Fit a logistic regression model
val_pred_shi <- predict(val_mod_shi, type = "response")# Predict probabilities for the same data
val_obs_shi <- val_dat_shi$icu_7d
val_roc_shi <- roc(val_obs_shi, val_pred_shi)# Calculate the ROC curve

# XIE model
coef_age <- 0.053 # Existing logistic regression model coefficients
coef_ldh <- 0.004
coef_lympho_abs <- -1.216#unit: 10^9/L
coef_spo2 <- -0.109#unit: 10^9/L
intercept <- 5.068

val_pred_xie <- plogis(coef_age * val_dat_full_final$age + 
                         coef_ldh * val_dat_full_final$ldh +
                         coef_lympho_abs * val_dat_full_final$lympho_abs +  
                         coef_spo2 * val_dat_full_final$spo2 +
                         intercept
                         )

val_obs_xie <- val_dat_full_final$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_xie <- roc(val_obs_xie, val_pred_xie, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# CROSS score
val_dat_cross_score <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_cross_score <- val_dat_cross_score %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_cross_score <- val_dat_cross_score %>%
  mutate(val_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_mod_cross_score <- glm(icu_7d ~ val_score_cross_score, data = val_dat_cross_score, family = binomial)# Fit a logistic regression model
val_pred_cross_score <- predict(val_mod_cross_score, type = "response")# Predict probabilities for the same data
val_obs_cross_score <- val_dat_cross_score$icu_7d
val_roc_cross_score <- roc(val_obs_cross_score, val_pred_cross_score)

# Full model with labs
coef_o2_supplement <- 0.8390
coef_impaired_consciousness <- 1.4032
coef_num_comor <- 0.1463
coef_age <- -0.0947
coef_rr <- 0.3783
coef_bp_sys <- 0.0917
coef_bp_dia <- -0.3193
coef_temp <- 0.1046
coef_spo2 <- -0.2439
coef_wbc_abs <- 0.0665
coef_platelet_abs <- -0.0466
coef_urea <- 0.2008
coef_creatinine <- -0.0847
coef_crp <- 0.1052
coef_ldh <- 0.4486
intercept <- -1.4643

#convert factors to continuous variables
val_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(val_dat_final_full_model_with_labs$o2_supplement))
val_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(val_dat_final_full_model_with_labs$impaired_consciousness))

val_pred_full_model_with_labs <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * val_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_num_comor * val_dat_final_full_model_with_labs$num_comor +  
                         coef_age * val_dat_final_full_model_with_labs$age +
                         coef_rr * val_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * val_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * val_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * val_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         coef_wbc_abs * val_dat_final_full_model_with_labs$wbc_abs +
                         coef_platelet_abs * val_dat_final_full_model_with_labs$platelet_abs + 
                         coef_urea * val_dat_final_full_model_with_labs$urea +
                         coef_creatinine * val_dat_final_full_model_with_labs$creatinine +  
                         coef_crp * val_dat_final_full_model_with_labs$crp +
                         coef_ldh * val_dat_final_full_model_with_labs$ldh +
                         intercept
                         )

val_obs_full_model_with_labs <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_full_model_with_labs <- roc(val_obs_full_model_with_labs, val_pred_full_model_with_labs, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# o2_supplement alone
coef_o2_supplement <- 1.4662
intercept <- -1.5509

#convert factors to continuous variables
val_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(val_dat_final_full_model_with_labs$o2_supplement))

val_pred_o2_supplement <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         intercept
                         )

val_obs_o2_supplement <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
val_roc_o2_supplement <- roc(val_obs_o2_supplement, val_pred_o2_supplement, smooth = F)# Create an ROC curve using the predicted probabilities and observed outcomes.

# spo2 alone
coef_spo2 <- -0.5575
intercept <- -0.8444

val_dat_final_full_model_with_labs$spo2 <- as.numeric(as.character(val_dat_final_full_model_with_labs$spo2))

val_pred_spo2 <- plogis(coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         intercept
                         )

val_obs_spo2 <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
val_roc_spo2 <- roc(val_obs_spo2, val_pred_spo2, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# LDH alone
if(FALSE) {
coef_ldh <- 0.8925
intercept <- -0.8926

val_dat_final_full_model_with_labs$ldh <- as.numeric(as.character(val_dat_final_full_model_with_labs$ldh))

val_pred_ldh <- plogis(coef_ldh * val_dat_final_full_model_with_labs$ldh +
                         intercept
                         )

val_obs_ldh <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.
val_roc_ldh <- roc(val_obs_ldh, val_pred_ldh, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.
}

# Combine all ROC data into one data frame
val_roc_data <- rbind(
  data.frame(sensitivity = val_roc_cross_score$sensitivities, false_positive_rate = 1 - val_roc_cross_score$specificities, Model = "CROSS score"),
  #data.frame(sensitivity = roc_full_model_with_labs$sensitivities, false_positive_rate = 1 - roc_full_model_with_labs$specificities, Model = "Full model with laboratory values"),
  #data.frame(sensitivity = roc_abc$sensitivities, false_positive_rate = 1 - roc_abc$specificities, Model = "CROSS model"),
  data.frame(sensitivity = val_roc_4c_mortality$sensitivities, false_positive_rate = 1 - val_roc_4c_mortality$specificities, Model = "4C Mortality"),
  data.frame(sensitivity = val_roc_news$sensitivities, false_positive_rate = 1 - val_roc_news$specificities, Model = "NEWS"),
  data.frame(sensitivity = val_roc_curb65$sensitivities, false_positive_rate = 1 - val_roc_curb65$specificities, Model = "CURB-65"),
  data.frame(sensitivity = val_roc_crb65$sensitivities, false_positive_rate = 1 - val_roc_crb65$specificities, Model = "CRB-65"),
  data.frame(sensitivity = val_roc_a_drop$sensitivities, false_positive_rate = 1 - val_roc_a_drop$specificities, Model = "A-DROP"),
  data.frame(sensitivity = val_roc_ds_crb65$sensitivities, false_positive_rate = 1 - val_roc_ds_crb65$specificities, Model = "DS CRB-65"),
  data.frame(sensitivity = val_roc_dl_death$sensitivities, false_positive_rate = 1 - val_roc_dl_death$specificities, Model = "DL-death"),
  data.frame(sensitivity = val_roc_dl_poor$sensitivities, false_positive_rate = 1 - val_roc_dl_poor$specificities, Model = "DL-poor"),
  data.frame(sensitivity = val_roc_qsofa$sensitivities, false_positive_rate = 1 - val_roc_qsofa$specificities, Model = "qSOFA"),
  data.frame(sensitivity = val_roc_acp$sensitivities, false_positive_rate = 1 - val_roc_acp$specificities, Model = "ACP index"),
  data.frame(sensitivity = val_roc_ascl$sensitivities, false_positive_rate = 1 - val_roc_ascl$specificities, Model = "ASCL"),
  data.frame(sensitivity = val_roc_huang$sensitivities, false_positive_rate = 1 - val_roc_huang$specificities, Model = "Huang"),
  data.frame(sensitivity = val_roc_call$sensitivities, false_positive_rate = 1 - val_roc_call$specificities, Model = "CALL"),
  data.frame(sensitivity = val_roc_shi$sensitivities, false_positive_rate = 1 - val_roc_shi$specificities, Model = "Shi"),
  data.frame(sensitivity = val_roc_xie$sensitivities, false_positive_rate = 1 - val_roc_xie$specificities, Model = "Xie"),
  data.frame(sensitivity = val_roc_o2_supplement$sensitivities, false_positive_rate = 1 - val_roc_o2_supplement$specificities, Model = "Oxygen supplement"),
  data.frame(sensitivity = val_roc_spo2$sensitivities, false_positive_rate = 1 - val_roc_spo2$specificities, Model = "Oxygen saturation")
  #data.frame(sensitivity = roc_ldh$sensitivities, false_positive_rate = 1 - roc_ldh$specificities, Model = "LDH")
  )

# Define custom colors and linetypes for each model
val_custom_colors <- c('CROSS score' = '#B22222',
                   #'Full model with laboratory values' = '#7341D1',
                   #'CROSS model' = '#32CD32',
                   '4C Mortality' = '#0f00ba',
                   'NEWS' = '#5085a5',
                   'CURB-65' = '#800080', 
                   'CRB-65' = '#40e0d0', 
                   'A-DROP' = '#6fd890', 
                   'DS CRB-65' = '#4169E1',
                   'DL-death' = '#f4915f',
                   'DL-poor' =  '#ff7e6b',
                   'qSOFA' =  '#ff00cc',
                   'ACP index' = '#bc7ff7', 
                   'ASCL' = '#d5d86f', 
                   'Huang' =  '#00a1de',
                   'CALL' = '#203f8b', 
                   'Shi' =  '#82d173', 
                   'Xie' = '#660033', 
                   'Oxygen supplement' = '#79b791',
                   'Oxygen saturation' = '#cc3333'
                   #'LDH' = '#f0e936'
                   )

# Define linetypes
val_custom_linetypes <- c('CROSS score' = 'solid',
                      #'Full model with laboratory values' = 'solid',
                      #'CROSS model' = 'solid', 
                      '4C Mortality' = 'dashed', 
                      'NEWS' = 'dashed',
                      'CURB-65' = 'dashed', 
                      'CRB-65' = 'dashed',
                      'A-DROP' = 'dashed',
                      'DS CRB-65' = 'dashed',
                      'DL-death' = 'dashed', 
                      'DL-poor' = 'dashed', 
                      'qSOFA' = 'dashed',
                      'ACP index' = 'dashed', 
                      'ASCL' = 'dashed',
                      'Huang' = 'dashed',
                      'CALL' = 'dashed',
                      'Shi' = 'dashed',
                      'Xie' = 'dashed', 
                      'Oxygen supplement' = 'dashed',
                      'Oxygen saturation' = 'dashed'
                      #'LDH' = 'dashed'
                      )

# Define the order of levels for the "Model" factor
val_roc_data$Model <- factor(val_roc_data$Model, 
                         levels = c(
  #'CROSS model', 
  'CROSS score',
  #'Best model', "Clinical model", 
  "NEWS", #'LDH', 
  "qSOFA", "Huang", "Oxygen supplement", "DL-poor", "ASCL", "Xie", "DL-death", "DS CRB-65", "A-DROP", "4C Mortality", "CURB-65", "CRB-65", 'Oxygen saturation', "ACP index", "Shi", "CALL"  
                                  )
  )

# Plot ROC curves using ggplot2 with custom colors and linetypes
ggplot(val_roc_data, aes(x = false_positive_rate, y = sensitivity, color = Model, linetype = Model)) +
  geom_line(size = 0.4) +
  labs(title = "ROC Curves for Multiple Models",
       x = "False positive rate",
       y = "True positive rate") +
  scale_color_manual(values = val_custom_colors) + # Specify custom colors
  scale_linetype_manual(values = val_custom_linetypes) + # Specify custom linetypes
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#808080", size = 0.4, alpha = 0.6) +
  theme_wx +
  theme(legend.position = "none") + # Remove the legend
  #theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  #theme(legend.position = "right") +
  #theme(legend.position = c(0.9, 0.4)) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Calculate the AUC
val_list_auc <- list(auc_cross = auc(val_roc_cross_score), 
                 #auc_full_model_with_laboratory_values = auc(roc_full_model_with_laboratory_values),
                 auc_abc = auc(val_roc_abc), 
                 auc_4c_mortality = auc(val_roc_4c_mortality), 
                 auc_news = auc(val_roc_news),
                 #auc_ldh = auc(val_roc_ldh),
                 auc_curb65 = auc(val_roc_curb65),
                 auc_crb65 = auc(val_roc_crb65),
                 auc_a_drop = auc(val_roc_a_drop),
                 auc_ds_curb65 = auc(val_roc_ds_crb65),
                 auc_dl_death = auc(val_roc_dl_death),
                 auc_dl_poor = auc(val_roc_dl_poor),
                 auc_qsofa = auc(val_roc_qsofa),
                 auc_acp = auc(val_roc_acp),
                 auc_ascl = auc(val_roc_ascl),
                 auc_huang = auc(val_roc_huang),
                 auc_call = auc(val_roc_call),
                 auc_shi = auc(val_roc_shi),
                 auc_xie = auc(val_roc_xie),
                 auc_o2_supplement = auc(val_roc_o2_supplement),
                 auc_spo2 = auc(val_roc_spo2)
                 )
val_list_auc

# Calculate the confidence intervals for the AUC using the bootstrap method
val_list_ci <- list(ci_cross = ci.auc(val_roc_cross_score, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                #ci_full_model_with_laboratory_values = ci.auc(val_roc_full_model_with_laboratory_values, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_abc = ci.auc(val_roc_abc, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_4c_mortality = ci.auc(val_roc_4c_mortality, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_news = ci.auc(val_roc_news, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                #ci_ldh = ci.auc(roc_ldh, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_curb65 = ci.auc(val_roc_curb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_crb65 = ci.auc(val_roc_crb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_a_drop = ci.auc(val_roc_a_drop, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_ds_crb65 = ci.auc(val_roc_ds_crb65, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_dl_death = ci.auc(val_roc_dl_death, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_dl_poor = ci.auc(val_roc_dl_poor, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_qsofa = ci.auc(val_roc_qsofa, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_acp = ci.auc(val_roc_acp, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_ascl = ci.auc(val_roc_ascl, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_huang = ci.auc(val_roc_huang, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_call = ci.auc(val_roc_call, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_shi = ci.auc(val_roc_shi, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_xie = ci.auc(val_roc_xie, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_o2_supplement = ci.auc(val_roc_o2_supplement, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE),
                ci_spo2 = ci.auc(val_roc_spo2, conf.level = 0.95, method = "bootstrap", boot.n = 100, stratified = TRUE)
                )
list_ci
```

```{r validation_risk_score_discrimination_four_variables, fig.width=6, fig.height=6}
# Full model with labs
coef_o2_supplement <- 0.8390
coef_impaired_consciousness <- 1.4032
coef_num_comor <- 0.1463
coef_age <- -0.0947
coef_rr <- 0.3783
coef_bp_sys <- 0.0917
coef_bp_dia <- -0.3193
coef_temp <- 0.1046
coef_spo2 <- -0.2439
coef_wbc_abs <- 0.0665
coef_platelet_abs <- -0.0466
coef_urea <- 0.2008
coef_creatinine <- -0.0847
coef_crp <- 0.1052
coef_ldh <- 0.4486
intercept <- -1.4643

#convert factors to continuous variables
val_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(val_dat_final_full_model_with_labs$o2_supplement))
val_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(val_dat_final_full_model_with_labs$impaired_consciousness))

val_pred_full_model_with_labs <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * val_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_num_comor * val_dat_final_full_model_with_labs$num_comor +  
                         coef_age * val_dat_final_full_model_with_labs$age +
                         coef_rr * val_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * val_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * val_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * val_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         coef_wbc_abs * val_dat_final_full_model_with_labs$wbc_abs +
                         coef_platelet_abs * val_dat_final_full_model_with_labs$platelet_abs + 
                         coef_urea * val_dat_final_full_model_with_labs$urea +
                         coef_creatinine * val_dat_final_full_model_with_labs$creatinine +  
                         coef_crp * val_dat_final_full_model_with_labs$crp +
                         coef_ldh * val_dat_final_full_model_with_labs$ldh +
                         intercept
                         )

val_obs_full_model_with_labs <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_full_model_with_labs <- roc(val_obs_full_model_with_labs, val_pred_full_model_with_labs, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# Full model without labs
coef_o2_supplement <- 1.1270
coef_impaired_consciousness <- 1.9790
coef_sex <- 0.1671
coef_age <- -0.1182
coef_rr <- 0.4615
coef_bp_sys <- 0.2653
coef_bp_dia <- -0.4866
coef_temp <- 0.1050
coef_hr <- 0.0366
coef_spo2 <- -0.4063
intercept <- -1.7365

#convert factors to continuous variables
val_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(val_dat_final_full_model_with_labs$o2_supplement))
val_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(val_dat_final_full_model_with_labs$impaired_consciousness))
val_dat_final_full_model_with_labs$sex <- ifelse(val_dat_final_full_model_with_labs$sex == 'female', 0, 1)

val_pred_full_model_without_labs <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * val_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_sex * val_dat_final_full_model_with_labs$sex +  
                         coef_age * val_dat_final_full_model_with_labs$age +
                         coef_rr * val_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * val_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * val_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * val_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         coef_hr * val_dat_final_full_model_with_labs$hr +
                         intercept
                         )

val_obs_full_model_without_labs <- val_dat_final_full_model_with_labs$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_full_model_without_labs <- roc(val_obs_full_model_without_labs, val_pred_full_model_without_labs, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# CROSS model with continuous variable being continuous
coef_o2_supplement <- 0.9345
coef_impaired_consciousness <- 1.6278
coef_rr <- 0.3906
coef_spo2 <- -0.3424
intercept <- -1.4406

#convert factors to continuous variables
val_dat_final$o2_supplement <- as.numeric(as.character(val_dat_final$o2_supplement))
val_dat_final$impaired_consciousness <- as.numeric(as.character(val_dat_final$impaired_consciousness))

val_pred_cross_model_continuous <- plogis(coef_o2_supplement * val_dat_final$o2_supplement +
                         coef_impaired_consciousness * val_dat_final$impaired_consciousness +
                         coef_rr * val_dat_final$rr +
                         coef_spo2 * val_dat_final$spo2 +
                         intercept
                         )

val_obs_cross_model_continuous <- val_dat_final$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_cross_model_continuous <- roc(val_obs_cross_model_continuous, val_pred_cross_model_continuous, smooth = T)# Create an ROC curve using the predicted probabilities and observed outcomes.

# sCROSS model (continuous variables were dichotomized)
coef_o2_supplement <- 0.9604146
coef_impaired_consciousness <- 1.5691841
coef_rr <- 0.6687391
coef_spo2 <- 0.4777998
intercept <- -1.8937371

#convert factors to continuous variables
val_dat_risk_score <- data.frame(
  icu_7d = val_dat_final_full_model_with_labs$icu_7d,
  o2_supplement = val_dat_final_full_model_with_labs$o2_supplement,
  impaired_consciousness = val_dat_final_full_model_with_labs$impaired_consciousness,
  rr = ifelse(val_dat_final_full_model_with_labs$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(val_dat_final_full_model_with_labs$spo2 <= corresponding_spo2_value, 1, 0)
)

val_dat_risk_score$o2_supplement <- as.numeric(as.character(val_dat_risk_score$o2_supplement))
val_dat_risk_score$impaired_consciousness <- as.numeric(as.character(val_dat_risk_score$impaired_consciousness))

val_pred_simplified_cross_model <- plogis(coef_o2_supplement * val_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * val_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * val_dat_risk_score$num_comor +  
                         #coef_age * val_dat_risk_score$age +
                         coef_rr * val_dat_risk_score$rr +
                         #coef_bp_sys * val_dat_risk_score$bp_sys + 
                         #coef_bp_dia * val_dat_risk_score$bp_dia +
                         #coef_temp * val_dat_risk_score$temp +  
                         coef_spo2 * val_dat_risk_score$spo2 +
                         #coef_wbc_abs * val_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * val_dat_risk_score$platelet_abs + 
                         #coef_urea * val_dat_risk_score$urea +
                         #coef_creatinine * val_dat_risk_score$creatinine +  
                         #coef_crp * val_dat_risk_score$crp +
                         #coef_ldh * val_dat_risk_score$ldh +
                         intercept
                         )

val_obs_simplified_cross_model <- val_dat_risk_score$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

val_roc_simplifed_cross_model <- roc(val_obs_simplified_cross_model, val_pred_simplified_cross_model, smooth = T)# clinical model: continuous variables remain continuous in the model; clinical model2: continuous variables were categorized.

# Risk score1
val_dat_risk_score1 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score1 <- val_dat_risk_score1 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 1,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 0
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 1
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 2
  )
  )

val_dat_risk_score1 <- val_dat_risk_score1 %>%
  mutate(val_score_risk_score1 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score1 <- glm(icu_7d ~ val_score_risk_score1, data = val_dat_risk_score1, family = binomial)# Fit a logistic regression model
val_pred_risk_score1 <- predict(val_mod_risk_score1, type = "response")# Predict probabilities for the same data
val_obs_risk_score1 <- val_dat_risk_score1$icu_7d
val_roc_risk_score1 <- roc(val_obs_risk_score1, val_pred_risk_score1)# Calculate the ROC curve

# Predictions and ROC curve for clinical risk score2
val_dat_risk_score2 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score2 <- val_dat_risk_score2 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 1,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

val_dat_risk_score2 <- val_dat_risk_score2 %>%
  mutate(val_score_risk_score2 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score2 <- glm(icu_7d ~ val_score_risk_score2, data = val_dat_risk_score2, family = binomial)# Fit a logistic regression model
val_pred_risk_score2 <- predict(val_mod_risk_score2, type = "response")# Predict probabilities for the same data
val_obs_risk_score2 <- val_dat_risk_score2$icu_7d
val_roc_risk_score2 <- roc(val_obs_risk_score2, val_pred_risk_score2)

# Risk score3
val_dat_risk_score3 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_obs_risk_score3 <- val_dat_risk_score3$icu_7d
val_roc_risk_score3 <- roc(val_obs_risk_score3, val_pred_risk_score3)

df_for_pred <- data.frame(val_dat_risk_score3, val_pred_risk_score3)
df_for_pred %>% filter(val_score_risk_score3 == 7)

# Risk score4
val_dat_risk_score4 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score4 <- val_dat_risk_score4 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 3,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 2
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 4
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 6
  )
  )

val_dat_risk_score4 <- val_dat_risk_score4 %>%
  mutate(val_score_risk_score4 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score4 <- glm(icu_7d ~ val_score_risk_score4, data = val_dat_risk_score4, family = binomial)# Fit a logistic regression model
val_pred_risk_score4 <- predict(val_mod_risk_score4, type = "response")# Predict probabilities for the same data
val_obs_risk_score4 <- val_dat_risk_score4$icu_7d
val_roc_risk_score4 <- roc(val_obs_risk_score4, val_pred_risk_score4)# Calcul

# Combine all ROC data into one data frame
roc_data <- rbind(
  #data.frame(sensitivity = roc_full_model_with_labs$sensitivities, false_positive_rate = 1 - roc_full_model_with_labs$specificities, Model = "Full model with laboratory values"),
  data.frame(sensitivity = val_roc_full_model_without_labs$sensitivities, false_positive_rate = 1 - val_roc_full_model_without_labs$specificities, Model = "Full model"),
  data.frame(sensitivity = val_roc_cross_model_continuous$sensitivities, false_positive_rate = 1 - val_roc_cross_model_continuous$specificities, Model = "CROSS model"),
  #data.frame(sensitivity = roc_clinical_model$sensitivities, false_positive_rate = 1 - roc_clinical_model$specificities, Model = "Clinical model"),
  data.frame(sensitivity = val_roc_simplifed_cross_model$sensitivities, false_positive_rate = 1 - val_roc_simplifed_cross_model$specificities, Model = "sCROSS model"),#simplified_clinical_model: continuous variables were categorized in the model
  #data.frame(sensitivity = val_roc_risk_score1$sensitivities, false_positive_rate = 1 - val_roc_risk_score1$specificities, Model = "Risk score1"),
  data.frame(sensitivity = val_roc_risk_score3$sensitivities, false_positive_rate = 1 - val_roc_risk_score3$specificities, Model = "CROSS score")
  #data.frame(sensitivity = val_roc_risk_score3$sensitivities, false_positive_rate = 1 - val_roc_risk_score3$specificities, Model = "Risk score3"),
  #data.frame(sensitivity = val_roc_risk_score4$sensitivities, false_positive_rate = 1 - val_roc_risk_score4$specificities, Model = "Risk score4")
  )

# Define custom colors and linetypes for each model
custom_colors <- c('CROSS score' = '#B22222',
                   "CROSS model" = '#32CD32',
                   'sCROSS model' = '#7341D1',
                   #'Full model with laboratory values' = '#7341D1',
                   'Full model' = '#f4915f'
                   #'Clinical model' = '#82d173', 
                   #'Simplified clinical model' = '#32CD32'
                   #'Risk score1' = '#f4915f',
                   #'Risk score2' = '#800080', 
                   #'Risk score3' = '#0f00ba', 
                   #'Risk score4' = '#660033'
                   #''CROSS score' = '#B22222'
                   )

# Define linetypes
custom_linetypes <- c('CROSS score' = 'solid',
                      "CROSS model" = 'dashed',
                      'sCROSS model' = 'dashed',
                      #'Full model with laboratory values' = 'dashed',
                      'Full model' = 'dashed'
                      #'Simplified clinical model' = 'dashed'
                      #'Risk score1' = 'solid',
                      #'Risk score2' = 'solid',
                      #'Risk score3' = 'solid',
                      #'Risk score4' = 'solid'
                      )

# Define the order of levels for the "Model" factor
roc_data$Model <- factor(roc_data$Model, 
                         levels = c(
                      'CROSS score',
                      "CROSS model",
                      "sCROSS model",
                      #'Full model with laboratory values',
                      'Full model'
                      #'Clinical model',
                      #'Simplified clinical model'
                      #'Risk score1',
                      #'Risk score2',
                      #'Risk score3',
                      #'Risk score4'
                                  )
  )

# Plot ROC curves using ggplot2 with custom colors and linetypes
ggplot(roc_data, aes(x = false_positive_rate, y = sensitivity, color = Model, linetype = Model)) +
  geom_line(size = 0.4) +
  labs(title = "ROC Curves for Multiple Models",
       x = "False positive rate",
       y = "True positive rate") +
  scale_color_manual(values = custom_colors) + # Specify custom colors
  scale_linetype_manual(values = custom_linetypes) + # Specify custom linetypes
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "#808080", size = 0.4, alpha = 0.6) +
  theme_wx +
  #theme(legend.position = 'none') +
  #theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  #theme(legend.position = "right") +
  theme(legend.position = c(0.86, 0.4)) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Calculate the AUC
list_auc <- list(auc_cross = auc(val_roc_risk_score2),
                 #auc_full_model_with_labs = auc(roc_full_model_with_labs),
                 auc_full_model_without_labs = auc(val_roc_full_model_without_labs),
                 auc_clinical_model_rcs = auc(val_roc_cross_model_continuous),
                 auc_clinical_model = auc(val_roc_cross_model_continuous),
                 auc_simplifed_clinical_model = auc(val_roc_simplifed_cross_model),
                 auc_risk_score1 = auc(val_roc_risk_score1), 
                 auc_risk_score2 = auc(val_roc_risk_score2),
                 auc_risk_score3 = auc(val_roc_risk_score3), 
                 auc_risk_score4 = auc(val_roc_risk_score4)
                 )
list_auc

# Calculate the confidence intervals for the AUC using the bootstrap method
list_ci <- list(ci_cross = ci.auc(val_roc_risk_score2, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_full_model_with_labs = ci.auc(val_roc_full_model_with_labs, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_full_model_without_labs = ci.auc(val_roc_full_model_without_labs, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_clinical_model_rcs = ci.auc(val_roc_cross_model_continuous, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_clinical_model = ci.auc(val_roc_cross_model_continuous, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_simplifed_clinical_model = ci.auc(val_roc_simplifed_cross_model, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_risk_score1 = ci.auc(val_roc_risk_score1, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_risk_score2 = ci.auc(val_roc_risk_score2, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_risk_score3 = ci.auc(val_roc_risk_score3, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE),
                ci_risk_score4 = ci.auc(val_roc_risk_score4, conf.level = 0.95, method = "bootstrap", boot.n = 200, stratified = TRUE)
                )
list_ci
```

```{r validation_cross_score_risk_groups_1, echo = FALSE, eval = FALSE}
# Calculate the quantiles
quantiles <- quantile(val_dat_risk_score3$val_score_risk_score3, probs = c(0.25, 0.75))

val_dat_risk_score3_risk_group <- val_dat_risk_score3
val_dat_risk_score3_risk_group <- val_dat_risk_score3_risk_group %>% 
  mutate(
  risk_group = case_when(
  val_score_risk_score3 == 0 ~ 'low',
  (val_score_risk_score3 >= 1) &  (val_score_risk_score3 <= 4) ~ 'medium',
  val_score_risk_score3 >= 5 ~ 'high'
  )
  )

#Number of patients
table(val_dat_risk_score3_risk_group$risk_group)

#Number of ICU admission
val_dat_risk_score3_risk_group %>%
  group_by(risk_group, icu_7d) %>%
  summarise(yes= sum(icu_7d == 1)
            #no = sum(icu_7d == 0)
  )
```

```{r validation_cross_score_risk_groups_2, echo = FALSE, eval = FALSE}
# Calculate the quantiles
quantiles <- quantile(val_dat_risk_score3$val_score_risk_score3, probs = c(0, 0.33, 0.67, 1))

val_dat_risk_score3_risk_group <- val_dat_risk_score3
val_dat_risk_score3_risk_group <- val_dat_risk_score3_risk_group %>% 
  mutate(
  risk_group = case_when(
  val_score_risk_score3 <= 1 ~ 'low',
  (val_score_risk_score3 >= 2) &  (val_score_risk_score3 <= 5) ~ 'medium',
  val_score_risk_score3 >= 6 ~ 'high'
  )
  )

#Number of patients
table(val_dat_risk_score3_risk_group$risk_group)

#Number of ICU admission
val_dat_risk_score3_risk_group %>%
  group_by(risk_group, icu_7d) %>%
  summarise(yes= sum(icu_7d == 1)
            #no = sum(icu_7d == 0)
  )
```

```{r validation_cross_score_risk_groups_3, echo = FALSE, eval = FALSE}
# Calculate the quantiles
quantiles <- quantile(val_dat_risk_score3$val_score_risk_score3, probs = c(0, 0.25, 0.50, 0.75, 1))

val_dat_risk_score3_risk_group <- val_dat_risk_score3
val_dat_risk_score3_risk_group <- val_dat_risk_score3_risk_group %>% 
  mutate(
  risk_group = case_when(
  val_score_risk_score3 <= 1 ~ 'low',
  (val_score_risk_score3 >= 2) &  (val_score_risk_score3 <= 3) ~ 'medium',
  (val_score_risk_score3 >= 4) &  (val_score_risk_score3 <= 5) ~ 'high',
  val_score_risk_score3 >= 6 ~ 'very high'
  )
  )

#Number of patients
table(val_dat_risk_score3_risk_group$risk_group)

#Number of ICU admission
val_dat_risk_score3_risk_group %>%
  group_by(risk_group, icu_7d) %>%
  summarise(yes= sum(icu_7d == 1)
            #no = sum(icu_7d == 0)
  )
```

```{r validation_CROSS_score_optimal_score_cut_off}
val_dat_risk_score3 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)

plot(val_roc_risk_score3, main = "ROC Curve", col = "blue", lwd = 2)

# Find the Optimal Cut-off
optimal_coords <- coords(val_roc_risk_score3, "best", ret = "threshold", transpose = TRUE)
# Extract the Optimal Cut-off
optimal_cutoff <- optimal_coords[[1]]  # Extract the first element of the vector
print(paste("Optimal Cut-off:", optimal_cutoff))

# Identify Data Points Closest to Optimal Cut-off
closest_index <- which.min(abs(val_pred_risk_score3 - optimal_cutoff))

# Extract Corresponding Risk Score
corresponding_score <- val_dat_risk_score3$val_score_risk_score3[closest_index]

# Print Corresponding Risk Score
print(paste("Corresponding Risk Score for Optimal Cut-off:", corresponding_score))
```

```{r validation_CROSS_score_performance_metrics_at_various_risk_score_thresholds}
val_dat_risk_score3 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% 
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)

#Rule out the ICU admission
results <- data.frame(
  actual_outcome = val_dat_risk_score3$icu_7d,
  predicted_score = val_dat_risk_score3$val_score_risk_score3,
  weights = rep(0.1, nrow(val_dat_risk_score3))# Assuming all weights are 0.1
)

results <- mutate(results, predicted_class = ifelse(predicted_score <= 1, 0, 1))

survey_design <- svydesign(ids = ~1, data = results, weights = ~weights)

confusion_matrix <- svytable(~actual_outcome + predicted_class, design = survey_design)

TP <- confusion_matrix[2, 2]
TN <- confusion_matrix[1, 1]
FP <- confusion_matrix[1, 2]
FN <- confusion_matrix[2, 1]

sensitivity <- TP / (TP + FN)
specificity <- TN / (TN + FP)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

print(c(TP = TP, TN = TN, FP = FP, FN = FN, Sensitivity = sensitivity, Specificity = specificity, PPV = PPV, NPV = NPV))

#When the score = 0
results <- data.frame(
  actual_outcome = val_dat_risk_score3$icu_7d,
  predicted_score = val_dat_risk_score3$val_score_risk_score3,
  weights = rep(0.1, nrow(val_dat_risk_score3))# Assuming all weights are 0.1
)

results <- mutate(results, predicted_class = ifelse(predicted_score == 0, 0, 1))# Create a new column indicating whether the predicted score is <= 3

survey_design <- svydesign(ids = ~1, data = results, weights = ~weights)# Create a survey design object with weights

confusion_matrix <- svytable(~actual_outcome + predicted_class, design = survey_design)

TP <- confusion_matrix[2, 2]
TN <- confusion_matrix[1, 1]
FP <- confusion_matrix[1, 2]
FN <- confusion_matrix[2, 1]

sensitivity <- TP / (TP + FN)
specificity <- TN / (TN + FP)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

print(c(TP = TP, TN = TN, FP = FP, FN = FN, Sensitivity = sensitivity, Specificity = specificity, PPV = PPV, NPV = NPV))

#Rule in the ICU admission
results <- data.frame(
  actual_outcome = val_dat_risk_score3$icu_7d,
  predicted_score = val_dat_risk_score3$val_score_risk_score3,
  weights = rep(0.1, nrow(val_dat_risk_score3))# Assuming all weights are 0.1
)

results <- mutate(results, predicted_class = ifelse(predicted_score >= 10, 1, 0))

survey_design <- svydesign(ids = ~1, data = results, weights = ~weights)

confusion_matrix <- svytable(~actual_outcome + predicted_class, design = survey_design)

TP <- confusion_matrix[2, 2]
TN <- confusion_matrix[1, 1]
FP <- confusion_matrix[1, 2]
FN <- confusion_matrix[2, 1]

sensitivity <- TP / (TP + FN)
specificity <- TN / (TN + FP)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

print(c(TP = TP, TN = TN, FP = FP, FN = FN, Sensitivity = sensitivity, Specificity = specificity, PPV = PPV, NPV = NPV))

#When the score = 7
results <- data.frame(
  actual_outcome = val_dat_risk_score3$icu_7d,
  predicted_score = val_dat_risk_score3$val_score_risk_score3,
  weights = rep(0.1, nrow(val_dat_risk_score3))# Assuming all weights are 0.1
)

results <- mutate(results, predicted_class = ifelse(predicted_score == 11, 1, 0))# Create a new column indicating whether the predicted score is <= 3

survey_design <- svydesign(ids = ~1, data = results, weights = ~weights)# Create a survey design object with weights

confusion_matrix <- svytable(~actual_outcome + predicted_class, design = survey_design)

TP <- confusion_matrix[2, 2]
TN <- confusion_matrix[1, 1]
FP <- confusion_matrix[1, 2]
FN <- confusion_matrix[2, 1]

sensitivity <- TP / (TP + FN)
specificity <- TN / (TN + FP)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

print(c(TP = TP, TN = TN, FP = FP, FN = FN, Sensitivity = sensitivity, Specificity = specificity, PPV = PPV, NPV = NPV))

# Calculate No of Patients for Each Risk Score
no_of_patients <- table(val_dat_risk_score3$val_score_risk_score3)

# Calculate ICU Admission Percentage at Specific Score Levels
icu_admission_percentage_val <- c(
  sum(val_dat_risk_score3$val_score_risk_score3 == 0 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 0) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 <= 1 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 <= 1) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 <= 2 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 <= 2) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 <= 3 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 <= 3) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 <= 4 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 <= 4) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 <= 5 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 <= 5) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 5 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 5) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 6 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 6) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 7 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 7) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 8 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 8) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 9 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 9) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 >= 10 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 >= 10) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 11 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 11) * 100
)

#Description of risks for each score level
icu_admission_percentage_val3 <- c(
  sum(val_dat_risk_score3$val_score_risk_score3 == 0 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 0) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 1 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 1) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 2 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 2) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 3 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 3) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 4 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 4) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 5 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 5) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 6 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 6) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 7 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 7) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 8 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 8) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 9 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 9) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 10 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 10) * 100,
  sum(val_dat_risk_score3$val_score_risk_score3 == 11 & val_dat_risk_score3$icu_7d == 1) / sum(val_dat_risk_score3$val_score_risk_score3 == 11) * 100
)
```

```{r validation_risk_score1_description_four_variables, fig.width=12, fig.height=9}
#Risk score1
val_dat_risk_score1$weight <- 0.1# Add a weight column to your data frame

ggplot(val_dat_risk_score1, aes(x = factor(val_dat_risk_score1$val_score_risk_score1), weight = weight)) +
  geom_bar(fill = "purple") +
  labs(title = "Risk Score1",
       x = "Score value",
       y = "Patient count") +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(val_dat_risk_score1, aes(x = factor(val_score_risk_score1), y = val_pred_risk_score1, weight = weight)) +
  geom_bar(stat = "sum", fill = "#FFB833") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "blue", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score1",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5")) +
  theme_wx

# Clinical risk score2
val_dat_risk_score2$weight <- 0.1# Add a weight column to your data frame

ggplot(val_dat_risk_score2, aes(x = factor(val_dat_risk_score2$val_score_risk_score2), weight = weight)) +
  geom_bar(fill = "grey") +
  labs(title = "Risk Score2",
       x = "Score value",
       y = "Patient count") +
  ylim(0, 300) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(val_dat_risk_score2, aes(x = factor(val_score_risk_score2), y = val_pred_risk_score2, weight = weight)) +
  geom_bar(stat = "sum", fill = "grey") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score2",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7")) +
  theme_wx 

# Risk score3
val_dat_risk_score3$weight <- 0.1# Add a weight column to your data frame

ggplot(val_dat_risk_score3, aes(x = factor(val_dat_risk_score3$val_score_risk_score3), weight = weight)) +
  geom_bar(fill = "grey") +
  labs(title = "Risk Score3",
       x = "Score value",
       y = "Patient count") +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(val_dat_risk_score3, aes(x = factor(val_score_risk_score3), y = val_pred_risk_score3, weight = weight)) +
  #geom_bar(stat = "sum", fill = "grey") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score3",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11")) +
  theme_wx+
  theme(
  axis.text = element_text(size = 30),
  axis.title = element_text(size = 35)
  )

# Clinical risk score4
val_dat_risk_score4$weight <- 0.1# Add a weight column to your data frame

ggplot(val_dat_risk_score4, aes(x = factor(val_dat_risk_score4$val_score_risk_score4), weight = weight)) +
  geom_bar(fill = "purple") +
  labs(title = "Risk Score4",
       x = "Score value",
       y = "Patient count") +
  scale_x_discrete(labels = c("0", "2", "4", "6", "8", "10", "12", "14")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(val_dat_risk_score4, aes(x = factor(val_score_risk_score4), y = val_pred_risk_score4, weight = weight)) +
  geom_bar(stat = "sum", fill = "#FFB833") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "blue", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score4",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "2", "4", "6", "8", "10", "12", "14")) +
  theme_wx
```

```{r validation_calibration_plot_cross_score_only, fig.width=6, fig.height=6}
# Predictions and ROC curve for CROSS score
val_dat_cross_score <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_cross_score <- val_dat_cross_score %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_cross_score <- val_dat_cross_score %>%
  mutate(val_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_mod_cross_score <- glm(icu_7d ~ val_score_cross_score, data = val_dat_cross_score, family = binomial)# Fit a logistic regression model
val_pred_cross_score <- predict(val_mod_cross_score, type = "response")# Predict probabilities for the same data
df_calib_plot_val_cross_score <- data.frame(pred_risk = val_pred_cross_score, true_outcome = as.numeric(as.character(val_dat_cross_score$icu_7d)))

# Calculate the calibration curve for the imputed stacked dataset
calibration_data_val_cross_score <- df_calib_plot_val_cross_score[order(df_calib_plot_val_cross_score$pred_risk), ]

calibration_plot_val_cross_score <- ggplot(calibration_data_val_cross_score, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#B22222", size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_cross_score") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(calibration_plot_val_cross_score)
```

```{r, validation: calibration plot, fig.width=8, fig.height=6}
#model ABC
if(exists('matrix_val')) {
  val_obs_abc = as.numeric(as.character(matrix_val$icu_7d))
} else if(exists('rcs_matrix_val')) {
  val_obs_abc = as.numeric(as.character(rcs_matrix_val$icu_7d))
}
val_predicted_abc <- predict(fit_optimal_der, design_matrix_val, type = "response")
val_dat_calib_abc <- data.frame(pred_risk = val_predicted_abc[,1],
                                true_outcome = val_obs_abc
                                ) 
val_dat_calib_abc <- val_dat_calib_abc[order(val_dat_calib_abc$pred_risk), ]#Calculate the calibration curve for the imputed stacked dataset

val_calib_plot_abc <- ggplot(val_dat_calib_abc, aes(x = pred_risk, y = true_outcome)) +#Create the calibration plot using ggplot2
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  geom_smooth(method = "loess", se = FALSE, color = '#32CD32', size = 0.8) +  # Add loess smoother
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_ABC") +
  theme_wx

print(val_calib_plot_abc)

#CROSS score
val_mod_cross_score <- glm(icu_7d ~ val_score_cross_score, data = val_dat_cross_score, family = binomial)
val_pred_cross_score <- predict(val_mod_cross_score, type = "response")
val_obs_cross_score <- as.numeric(as.character(val_dat_cross_score$icu_7d))

val_dat_calib_cross_score <- data.frame(pred_risk = val_pred_cross_score, true_outcome = val_obs_cross_score)
val_dat_calib_cross_score <- val_dat_calib_cross_score[order(val_dat_calib_cross_score$pred_risk), ]

val_calib_plot_cross_score <- ggplot(val_dat_calib_cross_score, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_cross_score") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(val_calib_plot_cross_score)

# Full model without labs
val_dat_calib_full_model_without_labs <- data.frame(pred_risk = val_pred_full_model_without_labs, true_outcome = as.numeric(as.character(val_obs_full_model_without_labs)))

val_dat_calib_full_model_without_labs <- val_dat_calib_full_model_without_labs[order(val_dat_calib_full_model_without_labs$pred_risk), ]

val_calib_plot_full_model_without_labs <- ggplot(val_dat_calib_full_model_without_labs, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "Observed risk", title = "Calibration Plot_full_model_without_labs") +
  theme_wx

print(val_calib_plot_full_model_without_labs)

# Simplified clinical model (continuous variables were dichotomized)
val_dat_calib_simplified_cross_model <- data.frame(pred_risk = val_pred_simplified_cross_model, true_outcome = as.numeric(as.character(val_obs_simplified_cross_model)))
val_dat_calib_simplified_cross_model <- val_dat_calib_simplified_cross_model[order(val_dat_calib_simplified_cross_model$pred_risk), ]

val_calib_plot_simplified_cross_model <- ggplot(val_dat_calib_simplified_cross_model, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "Observed risk", title = "Calibration Plot_simplified_cross_model") +
  theme_wx

print(val_calib_plot_simplified_cross_model)

#o2_supplement model
val_dat_calib_o2_supplement <- data.frame(pred_risk = val_pred_o2_supplement, true_outcome = as.numeric(as.character(val_obs_o2_supplement)))
val_dat_calib_o2_supplement <- val_dat_calib_o2_supplement[order(val_dat_calib_o2_supplement$pred_risk), ]

val_cali_plot_o2_supplement <- ggplot(val_dat_calib_o2_supplement, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "True outcome", title = "Calibration Plot_o2_supplement") +
  theme_wx

print(val_cali_plot_o2_supplement)

#spo2 model
val_dat_calib_spo2 <- data.frame(pred_risk = val_pred_spo2, true_outcome = as.numeric(as.character(val_obs_spo2)))
val_dat_calib_spo2 <- val_dat_calib_spo2[order(val_dat_calib_spo2$pred_risk), ]

val_calib_plot_spo2 <- ggplot(val_dat_calib_spo2, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "True outcome", title = "Calibration Plot_spo2") +
  theme_wx

print(val_calib_plot_spo2)

# LDH model
coef_ldh <- 0.8925
intercept <- -0.8926

#convert factors to continuous variables
val_dat_final_full_model_with_labs$ldh <- as.numeric(as.character(val_dat_final_full_model_with_labs$ldh))
val_dat_final_full_model_with_labs$icu_7d <- as.numeric(as.character(val_dat_final_full_model_with_labs$icu_7d))

val_pred_ldh <- plogis(coef_ldh * val_dat_final_full_model_with_labs$ldh + intercept)
val_obs_ldh <- val_dat_final_full_model_with_labs$icu_7d
val_dat_calib_ldh <- data.frame(pred_risk = val_pred_ldh, true_outcome = val_obs_ldh)
val_dat_calib_ldh <- val_dat_calib_ldh[order(val_dat_calib_ldh$pred_risk), ]

val_calib_plot_ldh <- ggplot(val_dat_calib_ldh, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "True outcome", title = "Calibration Plot_ldh") +
  theme_wx

print(val_calib_plot_ldh)

## Full model with labs
val_dat_calib_full_model_with_labs <- data.frame(pred_risk = val_pred_full_model_with_labs, true_outcome = as.numeric(as.character(val_obs_full_model_with_labs)))
val_dat_calib_full_model_with_labs <- val_dat_calib_full_model_with_labs[order(val_dat_calib_full_model_with_labs$pred_risk), ]

val_calib_plot_full_model_with_labs <- ggplot(val_dat_calib_full_model_with_labs, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = '#B22222', size = 0.4) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted risk", y = "True outcome", title = "Calibration Plot_best_model") +
  theme_wx

print(val_calib_plot_full_model_with_labs)

# DL-poor
val_dat_calib_dl_poor <- data.frame(pred_risk = val_pred_dl_poor, true_outcome = as.numeric(as.character(val_obs_dl_poor)))
val_dat_calib_dl_poor <- val_dat_calib_dl_poor[order(val_dat_calib_dl_poor$pred_risk), ]

val_calib_plot_dl_poor <- ggplot(val_dat_calib_dl_poor, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#4169E1", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_dl_poor") +
  theme_wx

print(val_calib_plot_dl_poor)

# DL-death
val_dat_calib_dl_death <- data.frame(pred_risk = val_pred_dl_death, true_outcome = as.numeric(as.character(val_obs_dl_death)))
val_dat_calib_dl_death <- val_dat_calib_dl_death[order(val_dat_calib_dl_death$pred_risk), ]

val_calib_plot_dl_death <- ggplot(val_dat_calib_dl_death, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#4169E1", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_dl_death") +
  theme_wx

print(val_calib_plot_dl_death)

#XIE model
val_dat_calib_xie <- data.frame(pred_risk = val_pred_xie, true_outcome = as.numeric(as.character(val_obs_xie)))
val_dat_calib_xie <- val_dat_calib_xie[order(val_dat_calib_xie$pred_risk), ]

val_calib_plot_xie <- ggplot(val_dat_calib_xie, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#4169E1", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_xie") +
  theme_wx

print(val_calib_plot_xie)

#HUANG model
val_dat_calib_huang <- data.frame(pred_risk = val_pred_huang, true_outcome = as.numeric(as.character(val_obs_huang)))
val_dat_calib_huang <- val_dat_calib_huang[order(val_dat_calib_huang$pred_risk), ]

val_calib_plot_huang <- ggplot(val_dat_calib_huang, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#4169E1", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_huang") +
  theme_wx

print(val_calib_plot_huang)

# Combine the three calibration plots into one coordinate system
#combined_calibration_plot <- calibration_plot_best_model
combined_val_calib_plot <- val_calib_plot_cross_score

# Define the calibration data sources
calibration_data_list <- list(
  #val_dat_calib_best_model,
  val_dat_calib_cross_score,
  val_dat_calib_abc,
  val_dat_calib_simplified_cross_model,
  val_dat_calib_full_model_without_labs,
  #val_dat_calib_ldh,
  val_dat_calib_o2_supplement,
  val_dat_calib_spo2,
  val_dat_calib_dl_poor,
  val_dat_calib_dl_death,
  val_dat_calib_xie,
  val_dat_calib_huang
)

calibration_data_names <- c(
  #"Best model",
  "CROSS score",
  "CROSS model",
  'sCROSS model',
  'Full model',
  #"LDH",
  "Oxygen supplement",
  "Oxygen saturation",
  "DL-poor",
  "DL-death",
  "Xie",
  "Huang"
)

# Define the colors for the smooth lines
smooth_colors <- c(
                   #'Best model' = '#B22222',
                   'CROSS score' = '#B22222',
                   'CROSS model' = '#32CD32',
                   'sCROSS model' = '#7341D1',
                   'Full model' = '#051BF5',
                   #'4C Mortality' = '#0f00ba',
                   #'NEWS' = '#5085a5',
                   #'CURB-65' = '#800080', 
                   #'CRB-65' = '#40e0d0', 
                   #'A-DROP' = '#6fd890', 
                   #'DS CRB-65' = '#4169E1',
                   #'qSOFA' =  '#ff00cc',
                   #'ACP index' = '#bc7ff7', 
                   #'ASCL' = '#d5d86f',
                   #'CALL' = '#203f8b', 
                   #'Shi' =  '#82d173', 
                   'Oxygen supplement' = '#79b791',
                   'Oxygen saturation' = '#cc3333',
                   'DL-poor' =  '#ff7e6b',
                   'DL-death' = '#f4915f',
                   'Xie' = '#660033', 
                   'Huang' =  '#00a1de'
                   #'LDH' = '#f0e936'
)

# Add smooth lines for each calibration data source with specified line types
for (i in 1:length(calibration_data_list)) {
  calibration_data_list[[i]]$calibration_name <- calibration_data_names[i]
  
  combined_val_calib_plot <- combined_val_calib_plot +
    geom_smooth(
      data = calibration_data_list[[i]],
      aes(color = calibration_name, linetype = calibration_name),  # Add the linetype aesthetic and specify the calibration data name
      method = "loess", 
      se = FALSE, 
      size = 0.4
    )
}


# Customize the legend title and position, including both line colors and line types
combined_val_calib_plot <- combined_val_calib_plot +
  labs(color = "Calibration Data", linetype = "Calibration Data") +
  scale_color_manual(values = smooth_colors, breaks = c(#the 'breaks' argument specifies the desired order of legend items.
    'CROSS score', 
    'CROSS model', 
    'sCROSS model',
    'Full model',
    'Oxygen supplement',
    'Oxygen saturation', 
    'DL-poor', 
    'DL-death', 
    'Xie',
    'Huang')) +
  scale_linetype_manual(values = c('CROSS score' = 'solid',
                                   'CROSS model' = 'dashed', 
                                   'sCROSS model' = 'dashed',
                                   'Full model' = 'dashed',
                                   'Oxygen supplement' = 'dashed', 
                                   'Oxygen saturation' = 'dashed', 
                                   'DL-poor' = 'dashed', 
                                   'DL-death' = 'dashed', 
                                   'Xie' = 'dashed', 
                                   'Huang' = 'dashed'),
                        breaks = c('CROSS score', #the 'breaks' argument specifies the desired order of legend items.
                                   'CROSS model', 
                                   'sCROSS model',
                                   'Full model',
                                   'Oxygen supplement',
                                   'Oxygen saturation', 
                                   'DL-poor', 
                                   'DL-death', 
                                   'Xie',
                                   'Huang'
                                   )
                        ) +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Save the combined plot as an image
print(combined_val_calib_plot)
```

```{r validation_calibration_plot_risk_scores_four_variables, fig.width=8, fig.height=6}
#Plot for the clinical model
coef_o2_supplement <- 0.9345135
coef_impaired_consciousness <- 1.6277604
coef_rr <- 0.3905663
coef_spo2 <- -0.3423773
intercept <- -1.4405898

#convert factors to continuous variables
val_dat_final$o2_supplement <- as.numeric(as.character(val_dat_final$o2_supplement))
val_dat_final$impaired_consciousness <- as.numeric(as.character(val_dat_final$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_final$o2_supplement +
                         coef_impaired_consciousness * val_dat_final$impaired_consciousness +
                         #coef_num_comor * dat_risk_score$num_comor +  
                         #coef_age * dat_risk_score$age +
                         coef_rr * val_dat_final$rr +
                         #coef_bp_sys * dat_risk_score$bp_sys + 
                         #coef_bp_dia * dat_risk_score$bp_dia +
                         #coef_temp * dat_risk_score$temp +  
                         coef_spo2 * val_dat_final$spo2 +
                         #coef_wbc_abs * dat_risk_score$wbc_abs +
                         #coef_platelet_abs * dat_risk_score$platelet_abs + 
                         #coef_urea * dat_risk_score$urea +
                         #coef_creatinine * dat_risk_score$creatinine +  
                         #coef_crp * dat_risk_score$crp +
                         #coef_ldh * dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_clinical_model <- val_dat_final
dat_clinical_model$icu_7d <- as.numeric(as.character(dat_clinical_model$icu_7d))
df_calib_plot_clinical_model <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model$icu_7d)

  # Calculate the calibration curve for the imputed stacked dataset
calibration_data_clinical_model <- df_calib_plot_clinical_model[order(df_calib_plot_clinical_model$pred_risk), ]

calibration_plot_clinical_model <- ggplot(calibration_data_clinical_model, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#B22222", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_clinical_model") +
  theme_wx

print(calibration_plot_clinical_model)

#Calibration plot for the simplified clinical model
coef_o2_supplement <- 0.9549559
coef_impaired_consciousness <- 1.5630028
coef_rr <- 0.6196270
coef_spo2 <- 0.6229567
intercept <- -1.9596728

#convert factors to continuous variables
val_dat_risk_score$o2_supplement <- as.numeric(as.character(val_dat_risk_score$o2_supplement))
val_dat_risk_score$impaired_consciousness <- as.numeric(as.character(val_dat_risk_score$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * val_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * val_dat_risk_score$num_comor +  
                         #coef_age * val_dat_risk_score$age +
                         coef_rr * val_dat_risk_score$rr +
                         #coef_bp_sys * val_dat_risk_score$bp_sys + 
                         #coef_bp_dia * val_dat_risk_score$bp_dia +
                         #coef_temp * val_dat_risk_score$temp +  
                         coef_spo2 * val_dat_risk_score$spo2 +
                         #coef_wbc_abs * val_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * val_dat_risk_score$platelet_abs + 
                         #coef_urea * val_dat_risk_score$urea +
                         #coef_creatinine * val_dat_risk_score$creatinine +  
                         #coef_crp * val_dat_risk_score$crp +
                         #coef_ldh * val_dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_simplified_clinical_model <- val_dat_risk_score
dat_simplified_clinical_model$icu_7d <- as.numeric(as.character(dat_simplified_clinical_model$icu_7d))
df_calib_plot_simplified_clinical_model <- data.frame(pred_risk = predicted_prob, true_outcome = dat_simplified_clinical_model$icu_7d)

  # Calculate the calibration curve for the imputed stacked dataset
calibration_data_simplified_clinical_model <- df_calib_plot_simplified_clinical_model[order(df_calib_plot_simplified_clinical_model$pred_risk), ]

calibration_plot_simplified_clinical_model <- ggplot(calibration_data_simplified_clinical_model, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#32CD32", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_simplified_clinical_model") +
  theme_wx

print(calibration_plot_simplified_clinical_model)

# Predictions and ROC curve for clinical risk score1
val_dat_risk_score1 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score1 <- val_dat_risk_score1 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr >= corresponding_rr_value ~ 1,
    rr < corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 >= corresponding_spo2_value ~ 0,
    spo2 < corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 1
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 2
  )
  )

val_dat_risk_score1 <- val_dat_risk_score1 %>%
  mutate(val_score_risk_score1 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score1 <- glm(icu_7d ~ val_score_risk_score1, data = val_dat_risk_score1, family = binomial)# Fit a logistic regression model
val_pred_risk_score1 <- predict(val_mod_risk_score1, type = "response")# Predict probabilities for the same data
df_calib_plot_val_risk_score1 <- data.frame(pred_risk = val_pred_risk_score1, true_outcome = as.numeric(as.character(val_dat_risk_score1$icu_7d)))

# Calculate the calibration curve for the imputed stacked dataset
calibration_data_val_risk_score1 <- df_calib_plot_val_risk_score1[order(df_calib_plot_val_risk_score1$pred_risk), ]

calibration_plot_val_risk_score1 <- ggplot(calibration_data_val_risk_score1, aes(x = pred_risk, y = true_outcome)) +
  #geom_smooth(method = "loess", se = FALSE, color = "#f4915f", size = 0.8) +  # Add loess smoother
  geom_smooth(method = "REML", se = FALSE, color = "#f4915f", size = 0.8) +
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_risk_score1") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(calibration_plot_val_risk_score1)

# Predictions and ROC curve for clinical risk score2
val_dat_risk_score2 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score2 <- val_dat_risk_score2 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 1,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

val_dat_risk_score2 <- val_dat_risk_score2 %>%
  mutate(val_score_risk_score2 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score2 <- glm(icu_7d ~ val_score_risk_score2, data = val_dat_risk_score2, family = binomial)# Fit a logistic regression model
val_pred_risk_score2 <- predict(val_mod_risk_score2, type = "response")# Predict probabilities for the same data
df_calib_plot_val_risk_score2 <- data.frame(pred_risk = val_pred_risk_score2, true_outcome = as.numeric(as.character(val_dat_risk_score2$icu_7d)))

# Calculate the calibration curve for the imputed stacked dataset
calibration_data_val_risk_score2 <- df_calib_plot_val_risk_score2[order(df_calib_plot_val_risk_score2$pred_risk), ]

calibration_plot_val_risk_score2 <- ggplot(calibration_data_val_risk_score2, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#32CD32", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "Observed risk", title = "Calibration Plot_risk_score2") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(calibration_plot_val_risk_score2)

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
df_calib_plot_val_risk_score3 <- data.frame(pred_risk = val_pred_risk_score3, true_outcome = as.numeric(as.character(val_dat_risk_score3$icu_7d)))

# Calculate the calibration curve for the imputed stacked dataset
calibration_data_val_risk_score3 <- df_calib_plot_val_risk_score3[order(df_calib_plot_val_risk_score3$pred_risk), ]

calibration_plot_val_risk_score3 <- ggplot(calibration_data_val_risk_score3, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#B22222", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_risk_score3") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(calibration_plot_val_risk_score3)

# Predictions and ROC curve for clinical risk score4
val_dat_risk_score4 <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score4 <- val_dat_risk_score4 %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr >= corresponding_rr_value ~ 2,
    rr < corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 >= corresponding_spo2_value ~ 0,
    spo2 < corresponding_spo2_value ~ 2
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 4
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 6
  )
  )

val_dat_risk_score4 <- val_dat_risk_score4 %>%
  mutate(val_score_risk_score4 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score4 <- glm(icu_7d ~ val_score_risk_score4, data = val_dat_risk_score4, family = binomial)# Fit a logistic regression model
val_pred_risk_score4 <- predict(val_mod_risk_score4, type = "response")# Predict probabilities for the same data
df_calib_plot_val_risk_score4 <- data.frame(pred_risk = val_pred_risk_score4, true_outcome = as.numeric(as.character(val_dat_risk_score4$icu_7d)))

# Calculate the calibration curve for the imputed stacked dataset
calibration_data_val_risk_score4 <- df_calib_plot_val_risk_score4[order(df_calib_plot_val_risk_score4$pred_risk), ]

calibration_plot_val_risk_score4 <- ggplot(calibration_data_val_risk_score4, aes(x = pred_risk, y = true_outcome)) +
  geom_smooth(method = "loess", se = FALSE, color = "#660033", size = 0.8) +  # Add loess smoother
  geom_line(data = data.frame(pred_risk = c(0, 1), true_outcome = c(0, 1)), 
            aes(x = pred_risk, y = true_outcome), 
            linetype = "dashed", color = "grey", size = 1) +  # Add the ideal calibration line
  labs(x = "Predicted Risk", y = "True Outcome", title = "Calibration Plot_risk_score4") +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal")

print(calibration_plot_val_risk_score4)

# Combine the three calibration plots into one coordinate system
combined_calibration_plot <- calibration_plot_val_risk_score2

# Define the calibration data sources
calibration_data_list <- list(
  #calibration_data_clinical_model,
  #calibration_data_simplified_clinical_model,
  #calibration_data_val_risk_score1,
  calibration_data_val_risk_score2,
  calibration_data_val_risk_score3
  #calibration_data_val_risk_score4
)

calibration_data_names <- c(
  #"Clinical model",
  #"Simplified clinical model",
  #"Risk score1",
  "Risk score2",
  "Risk score3"
  #"Risk score4"
)

# Define the colors for the smooth lines
smooth_colors <- c(
                   #'Clinical model' = '#B22222',
                   #'Simplified clinical model' = '#32CD32', 
                   #'Risk score1' = '#f4915f',
                   'Risk score2' = "#32CD32",
                   'Risk score3' = '#B22222'
                   #'Risk score4' = '#660033'
)

# Add smooth lines for each calibration data source with specified line types
for (i in 1:length(calibration_data_list)) {
  calibration_data_list[[i]]$calibration_name <- calibration_data_names[i]
  
  combined_calibration_plot <- combined_calibration_plot +
    geom_smooth(
      data = calibration_data_list[[i]],
      aes(color = calibration_name, linetype = calibration_name),  # Add the linetype aesthetic and specify the calibration data name
      method = "loess", 
      se = FALSE, 
      size = 0.4
    )
}

# Customize the legend title and position, including both line colors and line types
combined_calibration_plot <- combined_calibration_plot +
  labs(color = "Calibration Data", linetype = "Calibration Data") +
  scale_color_manual(values = smooth_colors) +
  scale_linetype_manual(values = c(#'Clinical model' = 'solid', 
                                   #'Simplified clinical model' = 'solid',
                                   #'Risk score1' = 'solid',
                                   'Risk score2' = 'solid',
                                   'Risk score3' = 'solid'
                                   #'Risk score4' = 'solid'
                                   )
                                   ) +
  theme_wx +
  theme(legend.position = "right", legend.box = "horizontal") + # Place the legend outside and align horizontally
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))

# Save the combined plot as an image
print(combined_calibration_plot)
```

```{r validation_calibration slope_calibration intercept}
# Function to perform calibration analysis
perform_calibration_analysis <- function(pred_risk, true_outcome) {
  df_calib_plot <- data.frame(pred_risk = pred_risk, true_outcome = true_outcome)# Create the stacked data set that contains the model predictions and the true outcomes
  #epsilon <- 1e-10 # Small epsilon to prevent division by zero
#df_calib_plot$pred_risk <- pmax(epsilon, pmin(1 - epsilon, df_calib_plot$pred_risk))
df_calib_plot$lp <- log(df_calib_plot$pred_risk / (1 - df_calib_plot$pred_risk))

  model_fit <- glm(true_outcome ~ lp, family = binomial, data = df_calib_plot)# Fit the logistic regression model
  cali_slope <- coef(model_fit)[2]#extract the calibration slope
  cali_slope_ci <- confint(model_fit)[2,]

  mod_calib <- glm(true_outcome ~ 1, family = binomial, data = df_calib_plot,# Compute and extract the calibration intercept 
                   offset = log(pred_risk / (1 - pred_risk)))
  cali_intercept <- coef(mod_calib)[1]

  pred_risk_values <- df_calib_plot$pred_risk# Compute the standard error of the calibration intercept manually
  n <- length(pred_risk_values)
  lp_values <- log(pred_risk_values / (1 - pred_risk_values))
  log_likelihood <- sum(df_calib_plot$true_outcome * lp_values + (1 - df_calib_plot$true_outcome) * log(1 - exp(lp_values)))
  vcov_matrix <- vcov(mod_calib)
  cali_intercept_se <- sqrt(vcov_matrix[1, 1] / n)

  alpha <- 0.05 # Calculate the confidence interval for the calibration intercept
  cali_intercept_ci <- c(cali_intercept - qnorm(1 - alpha / 2) * cali_intercept_se,
                         cali_intercept + qnorm(1 - alpha / 2) * cali_intercept_se)

  cali_result <- list(slope = cali_slope, ci_slope = cali_slope_ci, intercept = cali_intercept, ci_intercept = cali_intercept_ci)# Compile the results into a list
  return(cali_result)
}

# Using the function for case ABC
cali_result_abc <- perform_calibration_analysis(val_pred_abc[,1], val_dat_final$icu_7d)

# Calibration for the the full model with labs
coef_o2_supplement <- 0.8390
coef_impaired_consciousness <- 1.4032
coef_num_comor <- 0.1463
coef_age <- -0.0947
coef_rr <- 0.3783
coef_bp_sys <- 0.0917
coef_bp_dia <- -0.3193
coef_temp <- 0.1046
coef_spo2 <- -0.2439
coef_wbc_abs <- 0.0665
coef_platelet_abs <- -0.0466
coef_urea <- 0.2008
coef_creatinine <- -0.0847
coef_crp <- 0.1052
coef_ldh <- 0.4486
intercept <- -1.4643

predicted_prob <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * val_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_num_comor * val_dat_final_full_model_with_labs$num_comor +  
                         coef_age * val_dat_final_full_model_with_labs$age +
                         coef_rr * val_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * val_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * val_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * val_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         coef_wbc_abs * val_dat_final_full_model_with_labs$wbc_abs +
                         coef_platelet_abs * val_dat_final_full_model_with_labs$platelet_abs + 
                         coef_urea * val_dat_final_full_model_with_labs$urea +
                         coef_creatinine * val_dat_final_full_model_with_labs$creatinine +  
                         coef_crp * val_dat_final_full_model_with_labs$crp +
                         coef_ldh * val_dat_final_full_model_with_labs$ldh +
                         intercept
                         )
cali_result_best_model <- perform_calibration_analysis(predicted_prob, val_dat_final_full_model_with_labs$icu_7d)

# Using the function for o2_supplement
coef_o2_supplement <- 1.4662
intercept <- -1.5509

predicted_prob <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         intercept
                         )
cali_result_o2_supplement <- perform_calibration_analysis(predicted_prob, val_dat_final_full_model_with_labs$icu_7d)

# Using the function for SpO2
coef_spo2 <- -0.5575
intercept <- -0.8444

predicted_prob <- plogis(coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         intercept
                         )
cali_result_spo2 <- perform_calibration_analysis(predicted_prob, val_dat_final_full_model_with_labs$icu_7d)

# Using the function for LDH
coef_ldh <- 0.8925
intercept <- -0.8926

predicted_prob <- plogis(coef_ldh * val_dat_final_full_model_with_labs$ldh +
                         intercept
                         )
cali_result_ldh <- perform_calibration_analysis(predicted_prob, val_dat_final_full_model_with_labs$icu_7d)

## Using the function for Huang
coef_num_comor <- 2.752# Existing logistic regression model coefficients
coef_rr <- 4.056
coef_crp <- 2.424#unit: 10^9/L
coef_ldh <- 5.392#unit: 10^9/L
intercept <- -6.488

val_dat_full_final_huang <- val_dat_full_final
val_dat_full_final_huang <- val_dat_full_final_huang %>% #computation of 4C score for each patient
  mutate(num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  ),
    rr = case_when(
    rr > 24 ~ 1,
    rr <= 24 ~ 0
  ),
    crp = case_when(
    crp > 10 ~ 1,#unit: mg/L
    crp <= 10 ~ 0
  ),
    ldh = case_when(
    ldh <= 250 ~ 0,#unit: U/L
    ldh > 250 ~ 1
  )
   )

predicted_prob <- plogis(coef_num_comor * val_dat_full_final_huang$num_comor + 
                         coef_rr * val_dat_full_final_huang$rr +
                         coef_crp * val_dat_full_final_huang$crp +  
                         coef_ldh * val_dat_full_final_huang$ldh +
                         intercept
                         )

cali_result_huang <- perform_calibration_analysis(predicted_prob, val_dat_full_final_huang$icu_7d)

## Using the function for Xie
coef_age <- 0.053 # Existing logistic regression model coefficients
coef_ldh <- 0.004
coef_lympho_abs <- -1.216#unit: 10^9/L
coef_spo2 <- -0.109#unit: 10^9/L
intercept <- 5.068

predicted_prob <- plogis(coef_age * val_dat_full_final$age + 
                         coef_ldh * val_dat_full_final$ldh +
                         coef_lympho_abs * val_dat_full_final$lympho_abs +  
                         coef_spo2 * val_dat_full_final$spo2 +
                         intercept
                         )

cali_result_xie <- perform_calibration_analysis(predicted_prob, val_dat_full_final$icu_7d)

## Using the function for DL_death
coef_age <- log(1.01) # Existing logistic regression model coefficients
coef_sex <- log(0.45)
coef_neutro_abs <- log(1.25)#unit: 10^9/L
coef_lympho_abs <- log(0.27)#unit: 10^9/L
coef_platelet_abs <- log(0.99)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1) #unit: μmol/L
#intercept <- 4.203

val_dat_full_final_sex <- val_dat_full_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
val_dat_full_final_sex$sex <- ifelse(val_dat_full_final$sex == "Male", 1, 0)
predicted_prob <- plogis(coef_age * val_dat_full_final_sex$age + 
                         coef_sex * val_dat_full_final_sex$sex +
                         coef_neutro_abs * val_dat_full_final_sex$neutro_abs +  
                         coef_lympho_abs * val_dat_full_final_sex$lympho_abs + 
                         coef_platelet_abs * val_dat_full_final_sex$platelet_abs + 
                         coef_crp * val_dat_full_final_sex$crp + 
                         coef_creatinine * val_dat_full_final_sex$creatinine 
                        #intercept
                         )

cali_result_dl_death <- perform_calibration_analysis(predicted_prob, val_dat_full_final_sex$icu_7d)

## Using the function for DL_poor
coef_age <- log(1.03) # Existing logistic regression model coefficients
coef_sex <- log(0.62)
coef_neutro_abs <- log(1.29)#unit: 10^9/L
coef_lympho_abs <- log(0.31)#unit: 10^9/L
coef_platelet_abs <- log(1)#unit: 10^9/L
coef_crp <- log(1.01)#unit: mg/L
coef_creatinine <- log(1.01) #unit: μmol/L
#intercept <- 4.203

val_dat_full_final_sex <- val_dat_full_final # Calculate the predicted probabilities for the new dataset using the existing model coefficients.
val_dat_full_final_sex$sex <- ifelse(val_dat_full_final$sex == "Male", 1, 0)
predicted_prob <- plogis(coef_age * val_dat_full_final_sex$age + 
                         coef_sex * val_dat_full_final_sex$sex +
                         coef_neutro_abs * val_dat_full_final_sex$neutro_abs +  
                         coef_lympho_abs * val_dat_full_final_sex$lympho_abs + 
                         coef_platelet_abs * val_dat_full_final_sex$platelet_abs + 
                         coef_crp * val_dat_full_final_sex$crp + 
                         coef_creatinine * val_dat_full_final_sex$creatinine 
                        #intercept
                         )

cali_result_dl_poor <- perform_calibration_analysis(predicted_prob, val_dat_full_final_sex$icu_7d)

#CROSS score
val_dat_cross_score <- val_dat_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_cross_score <- val_dat_cross_score %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_cross_score <- val_dat_cross_score %>%
  mutate(val_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_mod_cross_score <- glm(icu_7d ~ val_score_cross_score, data = val_dat_cross_score, family = binomial)# Fit a logistic regression model
val_pred_cross_score <- predict(val_mod_cross_score, type = "response")# Predict probabilities for the same data
df_calib_plot_val_cross_score <- data.frame(pred_risk = val_pred_cross_score, true_outcome = as.numeric(as.character(val_dat_cross_score$icu_7d)))

cali_result_cross_score <- perform_calibration_analysis(val_pred_cross_score, val_dat_cross_score$icu_7d)

#qSOFA
val_dat_qsofa <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         icu_7d)

val_dat_qsofa <- val_dat_qsofa %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 22 ~ 1,
    rr < 22 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 100 ~ 1,
    bp_sys > 100 ~ 0
    )
   )

val_dat_qsofa <- val_dat_qsofa %>%
  mutate(val_score_qsofa = rowSums(select(., score_consciousness:score_bp))) 

val_mod_qsofa <- glm(icu_7d ~ val_score_qsofa, data = val_dat_qsofa, family = binomial)# Fit a logistic regression model
val_pred_qsofa <- predict(val_mod_qsofa, type = "response")# Predict probabilities for the same data
val_dat_qsofa$icu_7d <- as.numeric(as.character(val_dat_qsofa$icu_7d))
cali_result_qsofa <- perform_calibration_analysis(val_pred_qsofa, val_dat_qsofa$icu_7d)

#ACP index
val_dat_acp <- val_dat_full_final %>% #create the data frame
  select(age,
         crp,
         icu_7d)

val_dat_acp <- val_dat_acp %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age >= 60 ~ 1,
    age < 60 ~ 0
  ),
    score_crp = case_when(
    crp >= 34 ~ 1,#unit: mg/L
    crp < 34 ~ 0
  )
   )

val_dat_acp <- val_dat_acp %>%
  mutate(val_score_acp = rowSums(select(., score_age:score_crp))) 

val_mod_acp <- glm(icu_7d ~ val_score_acp, data = val_dat_acp, family = binomial)# Fit a logistic regression model
val_pred_acp <- predict(val_mod_acp, type = "response")# Predict probabilities for the same data
val_dat_acp$icu_7d <- as.numeric(as.character(val_dat_acp$icu_7d))
cali_result_acp <- perform_calibration_analysis(val_pred_acp, val_dat_acp$icu_7d)

#ASCL score
val_dat_ascl <- val_dat_full_final %>% #create the data frame
  select(age,
         sex,
         crp,
         ldh,
         icu_7d)

val_dat_ascl <- val_dat_ascl %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 1,
    age >= 60 & age <= 69 ~ 2,
    age >= 70 & age <= 79 ~ 3,
    age >= 80 ~ 4
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_crp = case_when(
    crp > 60 ~ 2,#unit: mg/L
    crp <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 300 ~ 0,#unit: U/L
    ldh > 300 ~ 2
  )
   )

val_dat_ascl <- val_dat_ascl %>%
  mutate(val_score_ascl = rowSums(select(., score_age:score_ldh))) 

val_mod_ascl <- glm(icu_7d ~ val_score_ascl, data = val_dat_ascl, family = binomial)# Fit a logistic regression model
val_pred_ascl <- predict(val_mod_ascl, type = "response")# Predict probabilities for the same data
val_dat_ascl$icu_7d <- as.numeric(as.character(val_dat_ascl$icu_7d))
cali_result_ascl <- perform_calibration_analysis(val_pred_ascl, val_dat_ascl$icu_7d)

# CALL score
val_dat_call <- val_dat_full_final %>% #create the data frame
  select(num_comor,
         age,
         lympho_abs,
         ldh,
         icu_7d)

val_dat_call <- val_dat_call %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age <= 60 ~ 1,
    age > 60 ~ 3,
    ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor <= 1 ~ 3
    ),
    score_lympho_abs = case_when(
    lympho_abs > 1 ~ 2,#unit: mg/L
    lympho_abs <= 60 ~ 0
  ),
    score_ldh = case_when(
    ldh <= 250 ~ 1,#unit: U/L
    ldh > 250 & ldh <= 500 ~ 2,
    ldh > 500 ~ 3
  )
   )

val_dat_call <- val_dat_call %>%
  mutate(val_score_call = rowSums(select(., score_age:score_ldh))) 

val_mod_call <- glm(icu_7d ~ val_score_call, data = val_dat_call, family = binomial)# Fit a logistic regression model
val_pred_call <- predict(val_mod_call, type = "response")# Predict probabilities for the same data
val_dat_call$icu_7d <- as.numeric(as.character(val_dat_call$icu_7d))
cali_result_call <- perform_calibration_analysis(val_pred_call, val_dat_call$icu_7d)

# SHI score
val_dat_shi <- val_dat_full_final %>% #create the data frame
  select(age,
         sex,
         bp_sys,
         bp_dia,
         icu_7d)

val_dat_shi <- val_dat_shi %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 ~ 1
  ),
    score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
    score_hbp = case_when(
    bp_sys >= 130 | bp_dia >= 80 ~ 1,#unit: mg/L
    bp_sys < 130 & bp_dia < 80 ~ 0
  )
   )

val_dat_shi <- val_dat_shi %>%
  mutate(val_score_shi = rowSums(select(., score_age:score_hbp))) 

val_mod_shi <- glm(icu_7d ~ val_score_shi, data = val_dat_shi, family = binomial)# Fit a logistic regression model
val_pred_shi <- predict(val_mod_shi, type = "response")# Predict probabilities for the same data
val_dat_shi$icu_7d <- as.numeric(as.character(val_dat_shi$icu_7d))
cali_result_shi <- perform_calibration_analysis(val_pred_shi, val_dat_shi$icu_7d)

#4C mortality score
val_dat_4c_mortality <- val_dat_full_final %>% #create the data frame
  select(age, 
         sex,
         num_comor,
         rr,
         spo2,
         impaired_consciousness,
         urea,
         crp,
         icu_7d)

val_dat_4c_mortality <- val_dat_4c_mortality %>% #computation of 4C score for each patient
  mutate(score_age = case_when(
    age < 50 ~ 0,
    age >= 50 & age <= 59 ~ 2,
    age >= 60 & age <= 69 ~ 4,
    age >= 70 & age <= 79 ~ 6,
    age >= 80 ~ 7
  ), 
  score_sex = case_when(
    sex == 'female' ~ 0,
    sex == 'male' ~ 1
  ),
  score_num_comor = case_when(
    num_comor == 0 ~ 0,
    num_comor == 1 ~ 1,
    num_comor >= 2 ~ 2
  ),
  score_rr = case_when(
    rr < 20 ~ 0,
    rr >= 20 & rr <= 29 ~ 1,
    rr >= 30 ~ 2
  ),
  score_spo2 = case_when(
    spo2 >= 92 ~ 0,
    spo2 < 92 ~ 2
  ),
  score_impaired_consciousness = case_when(
    impaired_consciousness == '0' ~ 0,
    impaired_consciousness == '1' ~ 1
  ),
  score_urea = case_when(
    urea < 7 ~ 0,
    urea >= 7 & urea <= 14 ~ 1,
    urea > 14 ~ 3
  ),
  score_crp = case_when(
    crp < 50 ~ 0,
    crp >= 50 & crp < 100 ~ 1,
    crp >= 100 ~ 2
  )
  )

val_dat_4c_mortality <- val_dat_4c_mortality %>%
  mutate(val_score_4c_mortality = rowSums(select(., score_age:score_crp))) 

val_mod_4c_mortality <- glm(icu_7d ~ val_score_4c_mortality, data = val_dat_4c_mortality, family = binomial)# Fit a logistic regression model
val_pred_4c_mortality <- predict(val_mod_4c_mortality, type = "response")# Predict probabilities for the same data
val_dat_4c_mortality$icu_7d <- as.numeric(as.character(val_dat_4c_mortality$icu_7d))
cali_result_4c_mortality <- perform_calibration_analysis(val_pred_4c_mortality, val_dat_4c_mortality$icu_7d)

#NEWS
val_dat_news <- val_dat_full_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         bp_sys,
         hr,
         temp,
         icu_7d)

val_dat_news <- val_dat_news %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr >= 12 & rr <= 20 ~ 0,
    rr >= 9 & rr <= 11 ~ 1,
    rr >= 21 & rr <= 24 ~ 2,
    rr >= 25 | rr <= 8 ~ 3
  ),
    score_spo2 = case_when(
    spo2 >= 96 ~ 0,
    spo2 >= 94 & spo2 <= 95 ~ 1,
    spo2 >= 92 & spo2 <= 93 ~ 2,
    spo2 <= 91 ~ 3
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 2
  ),
    score_temp = case_when(
    temp >= 36.1 & temp <= 38.0 ~ 0,
    (temp >= 35.1 & temp <= 36) | (temp >= 38.1 & temp <= 39) ~ 1,
    temp >= 39.1 ~ 2,
    temp <= 35.0 ~ 3
  ),
    score_bp_sys = case_when(
    bp_sys >= 111 & bp_sys <= 219 ~ 0,
    bp_sys >= 101 & bp_sys <= 110 ~ 1,
    bp_sys >= 91 & bp_sys <= 100 ~ 2,
    bp_sys >= 220 | bp_sys <= 90 ~ 3
  ),
    score_hr = case_when(
    hr >= 51 & hr <= 90 ~ 0,
    (hr >= 41 & hr <= 50) | (hr >= 91 & hr <= 110) ~ 1,
    hr >= 111 & hr <= 130 ~ 2,
    hr >= 131 | hr <= 40 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 3
  )
  )

val_dat_news <- val_dat_news %>%
  mutate(val_score_news = rowSums(select(., score_rr:score_consciousness))) 

val_mod_news <- glm(icu_7d ~ val_score_news, data = val_dat_news, family = binomial)# Fit a logistic regression model
val_pred_news <- predict(val_mod_news, type = "response")# Predict probabilities for the same data
val_dat_news$icu_7d <- as.numeric(as.character(val_dat_news$icu_7d))
cali_result_news <- perform_calibration_analysis(val_pred_news, val_dat_news$icu_7d)

#CURB-65
val_dat_curb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         urea,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

val_dat_curb65 <- val_dat_curb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

val_dat_curb65 <- val_dat_curb65 %>%
  mutate(val_score_curb65 = rowSums(select(., score_consciousness:score_age))) 

val_mod_curb65 <- glm(icu_7d ~ val_score_curb65, data = val_dat_curb65, family = binomial)# Fit a logistic regression model
val_pred_curb65 <- predict(val_mod_curb65, type = "response")# Predict probabilities for the same data
val_dat_curb65$icu_7d <- as.numeric(as.character(val_dat_curb65$icu_7d))
cali_result_curb65 <- perform_calibration_analysis(val_pred_curb65, val_dat_curb65$icu_7d)

#CRB-65
val_dat_crb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         icu_7d)

val_dat_crb65 <- val_dat_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  )
  )

val_dat_crb65 <- val_dat_crb65 %>%
  mutate(val_score_crb65 = rowSums(select(., score_consciousness:score_age))) 

val_mod_crb65 <- glm(icu_7d ~ val_score_crb65, data = val_dat_crb65, family = binomial)# Fit a logistic regression model
val_pred_crb65 <- predict(val_mod_crb65, type = "response")# Predict probabilities for the same data
val_dat_crb65$icu_7d <- as.numeric(as.character(val_dat_crb65$icu_7d))
cali_result_crb65 <- perform_calibration_analysis(val_pred_crb65, val_dat_crb65$icu_7d)

#A-DROP
val_dat_a_drop <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         urea,
         bp_sys,
         age,
         sex,
         spo2,
         icu_7d)

val_dat_a_drop <- val_dat_a_drop %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_urea = case_when(
    urea > 7 ~ 1, #unit: mmol/l
    urea <= 7 ~ 0
  ),
    score_spo2 = case_when(
    spo2 <= 90 ~ 1,
    spo2 > 90 ~ 0
  ),
    score_bp = case_when(
    bp_sys <= 90 ~ 1,
    bp_sys > 90 ~ 0
  ),
    score_age = case_when(
    (age >= 70 & sex ==  'male') | (age >= 75 & sex ==  'female') ~ 1,
    (age < 70 & sex ==  'male') | (age < 75 & sex ==  'female') ~ 0
  )
  )

val_dat_a_drop <- val_dat_a_drop %>%
  mutate(val_score_a_drop = rowSums(select(., score_consciousness:score_age))) 

val_mod_a_drop <- glm(icu_7d ~ val_score_a_drop, data = val_dat_a_drop, family = binomial)# Fit a logistic regression model
val_pred_a_drop <- predict(val_mod_a_drop, type = "response")# Predict probabilities for the same data
val_dat_a_drop$icu_7d <- as.numeric(as.character(val_dat_a_drop$icu_7d))
cali_result_a_drop <- perform_calibration_analysis(val_pred_a_drop, val_dat_a_drop$icu_7d)

#DS CRB-65
val_dat_ds_crb65 <- val_dat_full_final %>% #create the data frame
  select(impaired_consciousness,
         rr,
         bp_sys,
         bp_dia,
         age,
         spo2,
         num_comor,
         icu_7d)

val_dat_ds_crb65 <- val_dat_ds_crb65 %>% #computation of 4C score for each patient
  mutate(score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 1
  ),
    score_rr = case_when(
    rr >= 30 ~ 1,
    rr < 30 ~ 0
  ),
    score_bp = case_when(
    bp_sys < 90 | bp_dia <= 60 ~ 1,
    bp_sys >= 90 | bp_dia > 60 ~ 0
  ),
    score_age = case_when(
    age >= 65 ~ 1,
    age < 65 ~ 0
  ),
    score_spo2 = case_when(
    spo2 >= 90 ~ 0,
    spo2 < 90 ~ 1
  ),
    score_num_comor = case_when(
    num_comor >= 1 ~ 1,
    num_comor < 1 ~ 0
  )
  )

val_dat_ds_crb65 <- val_dat_ds_crb65 %>%
  mutate(val_score_ds_crb65 = rowSums(select(., score_consciousness:score_num_comor))) 

val_mod_ds_crb65 <- glm(icu_7d ~ val_score_ds_crb65, data = val_dat_ds_crb65, family = binomial)# Fit a logistic regression model
val_pred_ds_crb65 <- predict(val_mod_ds_crb65, type = "response")# Predict probabilities for the same data
val_dat_ds_crb65$icu_7d <- as.numeric(as.character(val_dat_ds_crb65$icu_7d))
cali_result_ds_crb65 <- perform_calibration_analysis(val_pred_ds_crb65, val_dat_ds_crb65$icu_7d)

```

```{r validation_calibration slope_calibration intercept_risk_score_models}
# Function to perform calibration analysis
perform_calibration_analysis <- function(pred_risk, true_outcome) {
  df_calib_plot <- data.frame(pred_risk = pred_risk, true_outcome = true_outcome)# Create the stacked data set that contains the model predictions and the true outcomes
  #epsilon <- 1e-10 # Small epsilon to prevent division by zero
#df_calib_plot$pred_risk <- pmax(epsilon, pmin(1 - epsilon, df_calib_plot$pred_risk))
df_calib_plot$lp <- log(df_calib_plot$pred_risk / (1 - df_calib_plot$pred_risk))

  model_fit <- glm(true_outcome ~ lp, family = binomial, data = df_calib_plot)# Fit the logistic regression model
  cali_slope <- coef(model_fit)[2]#extract the calibration slope
  cali_slope_ci <- confint(model_fit)[2,]

  mod_calib <- glm(true_outcome ~ 1, family = binomial, data = df_calib_plot,# Compute and extract the calibration intercept 
                   offset = log(pred_risk / (1 - pred_risk)))
  cali_intercept <- coef(mod_calib)[1]

  pred_risk_values <- df_calib_plot$pred_risk# Compute the standard error of the calibration intercept manually
  n <- length(pred_risk_values)
  lp_values <- log(pred_risk_values / (1 - pred_risk_values))
  log_likelihood <- sum(df_calib_plot$true_outcome * lp_values + (1 - df_calib_plot$true_outcome) * log(1 - exp(lp_values)))
  vcov_matrix <- vcov(mod_calib)
  cali_intercept_se <- sqrt(vcov_matrix[1, 1] / n)

  alpha <- 0.05 # Calculate the confidence interval for the calibration intercept
  cali_intercept_ci <- c(cali_intercept - qnorm(1 - alpha / 2) * cali_intercept_se,
                         cali_intercept + qnorm(1 - alpha / 2) * cali_intercept_se)

  cali_result <- list(slope = cali_slope, ci_slope = cali_slope_ci, intercept = cali_intercept, ci_intercept = cali_intercept_ci)# Compile the results into a list
  return(cali_result)
}

# Full model without labs
coef_o2_supplement <- 1.1270
coef_impaired_consciousness <- 1.9790
coef_sex <- 0.1671
coef_age <- -0.1182
coef_rr <- 0.4615
coef_bp_sys <- 0.2653
coef_bp_dia <- -0.4866
coef_temp <- 0.1050
coef_hr <- 0.0366
coef_spo2 <- -0.4063
intercept <- -1.7365

#convert factors to continuous variables
val_dat_final_full_model_with_labs$o2_supplement <- as.numeric(as.character(val_dat_final_full_model_with_labs$o2_supplement))
val_dat_final_full_model_with_labs$impaired_consciousness <- as.numeric(as.character(val_dat_final_full_model_with_labs$impaired_consciousness))
val_dat_final_full_model_with_labs$sex <- ifelse(val_dat_final_full_model_with_labs$sex == 'female', 0, 1)

predicted_prob <- plogis(coef_o2_supplement * val_dat_final_full_model_with_labs$o2_supplement +
                         coef_impaired_consciousness * val_dat_final_full_model_with_labs$impaired_consciousness +
                         coef_sex * val_dat_final_full_model_with_labs$sex +  
                         coef_age * val_dat_final_full_model_with_labs$age +
                         coef_rr * val_dat_final_full_model_with_labs$rr +
                         coef_bp_sys * val_dat_final_full_model_with_labs$bp_sys + 
                         coef_bp_dia * val_dat_final_full_model_with_labs$bp_dia +
                         coef_temp * val_dat_final_full_model_with_labs$temp +  
                         coef_spo2 * val_dat_final_full_model_with_labs$spo2 +
                         coef_hr * val_dat_final_full_model_with_labs$hr +
                         intercept
                         )

df_calib_plot_full_model_without_labs <- data.frame(pred_risk = predicted_prob, true_outcome = val_dat_final_full_model_with_labs$icu_7d)
cali_result_val_full_model_without_labs <- perform_calibration_analysis(df_calib_plot_full_model_without_labs$pred_risk, df_calib_plot_full_model_without_labs$true_outcome)

#The clinical model
coef_o2_supplement <- 0.9345135
coef_impaired_consciousness <- 1.6277604
coef_rr <- 0.3905663
coef_spo2 <- -0.3423773
intercept <- -1.4405898

#convert factors to continuous variables
val_dat_final$o2_supplement <- as.numeric(as.character(val_dat_final$o2_supplement))
val_dat_final$impaired_consciousness <- as.numeric(as.character(val_dat_final$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_final$o2_supplement +
                         coef_impaired_consciousness * val_dat_final$impaired_consciousness +
                         #coef_num_comor * dat_risk_score$num_comor +  
                         #coef_age * dat_risk_score$age +
                         coef_rr * val_dat_final$rr +
                         #coef_bp_sys * dat_risk_score$bp_sys + 
                         #coef_bp_dia * dat_risk_score$bp_dia +
                         #coef_temp * dat_risk_score$temp +  
                         coef_spo2 * val_dat_final$spo2 +
                         #coef_wbc_abs * dat_risk_score$wbc_abs +
                         #coef_platelet_abs * dat_risk_score$platelet_abs + 
                         #coef_urea * dat_risk_score$urea +
                         #coef_creatinine * dat_risk_score$creatinine +  
                         #coef_crp * dat_risk_score$crp +
                         #coef_ldh * dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
val_dat_clinical_model <- val_dat_final
val_dat_clinical_model$icu_7d <- as.numeric(as.character(val_dat_clinical_model$icu_7d))
df_calib_plot_val_clinical_model <- data.frame(pred_risk = predicted_prob, true_outcome = val_dat_clinical_model$icu_7d)
cali_result_val_clinical_model <- perform_calibration_analysis(df_calib_plot_val_clinical_model$pred_risk, df_calib_plot_val_clinical_model$true_outcome)

# Calibration for the simplified clinical model
coef_o2_supplement <- 0.9604146
coef_impaired_consciousness <- 1.5691841
coef_rr <- 0.6687391
coef_spo2 <- 0.4777998
intercept <- -1.8937371

#convert factors to continuous variables
val_dat_risk_score$o2_supplement <- as.numeric(as.character(val_dat_risk_score$o2_supplement))
val_dat_risk_score$impaired_consciousness <- as.numeric(as.character(val_dat_risk_score$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * val_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * val_dat_risk_score$num_comor +  
                         #coef_age * val_dat_risk_score$age +
                         coef_rr * val_dat_risk_score$rr +
                         #coef_bp_sys * val_dat_risk_score$bp_sys + 
                         #coef_bp_dia * val_dat_risk_score$bp_dia +
                         #coef_temp * val_dat_risk_score$temp +  
                         coef_spo2 * val_dat_risk_score$spo2 +
                         #coef_wbc_abs * val_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * val_dat_risk_score$platelet_abs + 
                         #coef_urea * val_dat_risk_score$urea +
                         #coef_creatinine * val_dat_risk_score$creatinine +  
                         #coef_crp * val_dat_risk_score$crp +
                         #coef_ldh * val_dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
val_dat_simplied_clinical_model <- val_dat_risk_score
val_dat_simplied_clinical_model$icu_7d <- as.numeric(as.character(val_dat_simplied_clinical_model$icu_7d))
df_calib_plot_val_simplied_clinical_model <- data.frame(pred_risk = predicted_prob, true_outcome = val_dat_simplied_clinical_model$icu_7d)
cali_result_val_simplied_clinical_model <- perform_calibration_analysis(df_calib_plot_val_simplied_clinical_model$pred_risk, df_calib_plot_val_simplied_clinical_model$true_outcome)

if(FALSE) {
# Calibration for the clinical model3
coef_o2_supplement <- 1.1291567
coef_impaired_consciousness <- 2.0675746
coef_rr <- 0.5184567
coef_spo2 <- -0.4524848
coef_bp_dia <- -0.3288151
intercept <- -1.6290295

#convert factors to continuous variables
val_dat_final$o2_supplement <- as.numeric(as.character(val_dat_final$o2_supplement))
val_dat_final$impaired_consciousness <- as.numeric(as.character(val_dat_final$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_final$o2_supplement +
                         coef_impaired_consciousness * val_dat_final$impaired_consciousness +
                         #coef_num_comor * dat_risk_score$num_comor +  
                         #coef_age * dat_risk_score$age +
                         coef_rr * val_dat_final$rr +
                         #coef_bp_sys * dat_risk_score$bp_sys + 
                         coef_bp_dia * val_dat_final$bp_dia +
                         #coef_temp * dat_risk_score$temp +  
                         coef_spo2 * val_dat_final$spo2 +
                         #coef_wbc_abs * dat_risk_score$wbc_abs +
                         #coef_platelet_abs * dat_risk_score$platelet_abs + 
                         #coef_urea * dat_risk_score$urea +
                         #coef_creatinine * dat_risk_score$creatinine +  
                         #coef_crp * dat_risk_score$crp +
                         #coef_ldh * dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_clinical_model3 <- val_dat_final
dat_clinical_model3$icu_7d <- as.numeric(as.character(dat_clinical_model3$icu_7d))
df_calib_plot_clinical_model3 <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model3$icu_7d)
cali_result_clinical_model3 <- perform_calibration_analysis(df_calib_plot_clinical_model3$pred_risk, df_calib_plot_clinical_model3$true_outcome)

# Calibration for the clinical model4
coef_o2_supplement <- 1.1673183
coef_impaired_consciousness <- 1.9170308
coef_rr <- 0.7519391
coef_spo2 <- 0.8881070
coef_bp_dia <- -0.3360711
intercept <- -2.0176201

#convert factors to continuous variables
val_dat_risk_score$o2_supplement <- as.numeric(as.character(val_dat_risk_score$o2_supplement))
val_dat_risk_score$impaired_consciousness <- as.numeric(as.character(val_dat_risk_score$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_risk_score$o2_supplement +
                         coef_impaired_consciousness * val_dat_risk_score$impaired_consciousness +
                         #coef_num_comor * val_dat_risk_score$num_comor +  
                         #coef_age * val_dat_risk_score$age +
                         coef_rr * val_dat_risk_score$rr +
                         #coef_bp_sys * val_dat_risk_score$bp_sys + 
                         coef_bp_dia * val_dat_risk_score$bp_dia +
                         #coef_temp * val_dat_risk_score$temp +  
                         coef_spo2 * val_dat_risk_score$spo2 +
                         #coef_wbc_abs * val_dat_risk_score$wbc_abs +
                         #coef_platelet_abs * val_dat_risk_score$platelet_abs + 
                         #coef_urea * val_dat_risk_score$urea +
                         #coef_creatinine * val_dat_risk_score$creatinine +  
                         #coef_crp * val_dat_risk_score$crp +
                         #coef_ldh * val_dat_risk_score$ldh +
                         intercept
                         )

  # create the stacked data set that contains the model predictions and the true outcomes 
dat_clinical_model4 <- val_dat_risk_score
dat_clinical_model4$icu_7d <- as.numeric(as.character(dat_clinical_model4$icu_7d))
df_calib_plot_clinical_model4 <- data.frame(pred_risk = predicted_prob, true_outcome = dat_clinical_model4$icu_7d)
cali_result_clinical_model4 <- perform_calibration_analysis(df_calib_plot_clinical_model4$pred_risk, df_calib_plot_clinical_model4$true_outcome)
}

#all four risk scores
cali_result_val_risk_score1 <- perform_calibration_analysis(df_calib_plot_val_risk_score1$pred_risk, df_calib_plot_val_risk_score1$true_outcome)
cali_result_val_risk_score2 <- perform_calibration_analysis(df_calib_plot_val_risk_score2$pred_risk, df_calib_plot_val_risk_score2$true_outcome)
cali_result_val_risk_score3 <- perform_calibration_analysis(df_calib_plot_val_risk_score3$pred_risk, df_calib_plot_val_risk_score3$true_outcome)
cali_result_val_risk_score4 <- perform_calibration_analysis(df_calib_plot_val_risk_score4$pred_risk, df_calib_plot_val_risk_score4$true_outcome)
```

```{r validation_model apparent performance_clinical utility_new, fig.width=6, fig.height=6}
df_cross <- data.frame(val_dat_cross_score, val_pred_cross_score)

df_all <- data.frame(icu_7d = df_cross$icu_7d, val_pred_cross_score, val_pred_news, val_pred_qsofa, val_pred_huang, val_pred_o2_supplement, val_pred_dl_poor, val_pred_ascl, val_pred_xie, val_pred_dl_death, val_pred_ds_crb65, val_pred_a_drop, val_pred_4c_mortality, val_pred_curb65, val_pred_crb65, val_pred_spo2, val_pred_acp, val_pred_shi, val_pred_call)

# ggplot2 code to create DCA figure
x <- dcurves::dca(icu_7d ~ val_pred_cross_score + val_pred_news + val_pred_qsofa + val_pred_huang + val_pred_o2_supplement + val_pred_dl_poor + val_pred_ascl + val_pred_xie +  val_pred_dl_death + val_pred_ds_crb65 + val_pred_a_drop + val_pred_4c_mortality + val_pred_curb65 + val_pred_crb65 + val_pred_spo2 + val_pred_acp + val_pred_shi + val_pred_call, data = df_all, time = 100, 
                  #prevalence = 0.2952854
                  prevalence = 0.2804987)

# Define color and labels mapping
color_labels <- c(
  'val_pred_cross_score' = '#B22222', 'val_pred_news' = '#5085a5', 'val_pred_qsofa' = '#ff00cc',
  'val_pred_huang' = '#00a1de', 'val_pred_o2_supplement' = '#79b791',
  'val_pred_dl_poor' = '#ff7e6b', 'val_pred_ascl' = '#d5d86f',  
  'val_pred_xie' = '#660033', 'val_pred_dl_death' = '#f4915f',
  'val_pred_ds_crb65' = '#4169E1', 'val_pred_a_drop' = '#6fd890', 
  'val_pred_4c_mortality' = '#0f00ba', 'val_pred_curb65' = '#800080', 
  'val_pred_crb65' = '#40e0d0', 'val_pred_spo2' = '#cc3333',
  'val_pred_acp' = '#bc7ff7', 'val_pred_shi' = '#82d173', 
  'val_pred_call' = '#203f8b', 'Treat All' = 'black', 'Treat None' = 'grey'
)

# Define the desired line types
linetype_labels <- c(
  'val_pred_cross_score' = 'solid', 'val_pred_news' = 'dashed', 'val_pred_qsofa' = 'dashed', 
  'val_pred_huang' = 'dashed', 'val_pred_o2_supplement' = 'dashed', 
  'val_pred_dl_poor' = 'dashed', 'val_pred_ascl' = 'dashed', 
  'val_pred_xie' = 'dashed', 'val_pred_dl_death' = 'dashed', 
  'val_pred_ds_crb65' = 'dashed', 'val_pred_a_drop' = 'dashed', 
  'val_pred_4c_mortality' = 'dashed', 'val_pred_curb65' = 'dashed', 
  'val_pred_crb65' = 'dashed', 'val_pred_spo2' = 'dashed', 
  'val_pred_acp' = 'dashed', 'val_pred_shi' = 'dashed', 'val_pred_call' = 'dashed', 'Treat All' = 'solid', 'Treat None' = 'solid'
)

# Define the desired order of legend items
legend_order <- c('val_pred_cross_score', 'val_pred_news', 'val_pred_qsofa', 'val_pred_huang', 'val_pred_o2_supplement', 'val_pred_dl_poor', 'val_pred_ascl', 'val_pred_xie', 'val_pred_dl_death', 'val_pred_ds_crb65', 'val_pred_a_drop', 'val_pred_4c_mortality', 'val_pred_curb65', 'val_pred_crb65', 'val_pred_spo2', 'val_pred_acp', 'val_pred_shi', 'val_pred_call', 'Treat All', 'Treat None')

# Define the desired legend labels
legend_labels <- c(
  'val_pred_cross_score' = 'CROSS score', 'val_pred_news' = 'NEWS', 'val_pred_qsofa' = 'qSOFA', 
  'val_pred_huang' = 'Huang', 'val_pred_o2_supplement' = 'Oxygen supplement', 
  'val_pred_dl_poor' = 'DL-poor', 'val_pred_ascl' = 'ASCL', 
  'val_pred_xie' = 'Xie', 'val_pred_dl_death' = 'DL-death', 
  'val_pred_ds_crb65' = 'DS CRB-65', 'val_pred_a_drop' = 'A-DROP', 
  'val_pred_4c_mortality' = '4C mortality', 'val_pred_curb65' = 'CURB-65', 
  'val_pred_crb65' = 'CRB-65', 'val_pred_spo2' = 'Oxygen saturation', 
  'val_pred_acp' = 'ACP index', 'val_pred_shi' = 'Shi', 'val_pred_call' = 'CALL', 'Treat All' = 'Treat all', 'Treat None' = 'Treat none'
)

# Convert to tibble and filter
df_plot <- as_tibble(x) %>%
  dplyr::filter(!is.na(net_benefit))

# ggplot with corrected line types in legend
ggplot(df_plot, aes(x = threshold, y = net_benefit)) +
  geom_smooth(aes(color = label, linetype = label), method = "loess", se = FALSE, size = 0.4) +
  coord_cartesian(ylim = c(-0.1, 0.3)) +
  labs(title = "DCA for Multiple Models",
       x = "Threshold probability",
       y = "Net benefit") +
  theme_wx +
  #theme(legend.position = "right", legend.box = "horizontal") +
  theme(legend.position = 'none') +
  scale_color_manual(values = color_labels, breaks = legend_order, labels = legend_labels) +
  scale_linetype_manual(values = linetype_labels, breaks = legend_order, labels = legend_labels) +
  guides(color = guide_legend(title = NULL), linetype = guide_legend(title = NULL))
```

#5. Sensitivity analyses
```{r sensitivity analyses_imputed data sets_temporal enrollment}
# Instructions for running this code:
#1. Run first the two sections:
    '#1. Loaded packages & customized functions'
    '#2. Create the derivation (der_dat) & validation (val_dat) cohorts'
#2. Rerun chunks 1-25 first
#3. Run the code below

#raw_data_creation_hap
dat_raw_hap <- dat_raw_hap %>% 
  select(#-d_adm_enrolled_hsptl,
         -d_icu,
         -d_v1,
         -duration_hsptl_v1,
         -duration_hsptl_icu,
         -d_vital_param,
         -duration_hsptl_blood_v1,
         -duration_hsptl_cc_v1,
         -duration_hsptl_gcs_v1
         )

dat_raw_hap <- dat_raw_hap %>% 
  rename(
    d_hsptl = d_adm_enrolled_hsptl,
    hr = hr_his,
    bp_sys = bp_sys_his,
    bp_dia = bp_dia_his,
    rr = rr_his,
    temp = temp_his,
    spo2 = spo2_his,
    o2_supplement = o2_supplement_his,
    consciousness = consciousness_his
  ) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, everything()
  )

dat_raw_hap$impaired_consciousness = ifelse(
  dat_raw_hap$consciousness == 'unimpaired', 'no', 'yes'
)

dat_raw_hap <- dat_raw_hap %>% 
  select(-c(consciousness, gcs))

dat_raw_hap <- dat_raw_hap %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

#raw_data_creation_suep
dat_raw_suep <- merge(dat_scv_suep, dat_fv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_bv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_ptcenter_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv2_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fuv1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_2_suep, by = "psn", all.y = T)
dat_raw_suep <- left_join(dat_raw_suep, dat_eward_suep, by = "psn")

dat_raw_suep <- dat_raw_suep %>% 
  select(-vis_label.x,
         -vis_label.y,
         -hsptl,
         -p_inclusion,
         -unit_albumin,
         -unit_crp,
         -unit_ferritin,
         -unit_pct,
         -unit_dimer,
         -unit_wbc_abs,
         -unit_lympho_abs,
         -unit_neutro_abs,
         -unit_platelet_abs,
         -unit_urea,
         -unit_creatinine,
         -unit_ldh,
         #-d_hsptl,
         -d_baseline,
         -height) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

dat_raw_suep$impaired_consciousness = ifelse(
  dat_raw_suep$gcs == 15, 'no', 'yes'
)

dat_raw_suep <- dat_raw_suep %>% 
  select(-c(consciousness, gcs))

dat_raw_suep <- dat_raw_suep %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

dat_raw_suep$d_hsptl <- as.Date(as.character(dat_raw_suep$d_hsptl), format = "%Y%m%d")

#merge HAP and SUEP
dat_raw_hap <- subset(dat_raw_hap, select = -c(comor_dm, comor_chronic_neuro, comor_dementia, comor_tumor_or_cancer, comor_rheuma_immuno, comor_hiv_aids))

dat_with_missing_outcome <- rbind(dat_raw_hap, dat_raw_suep)

dat <- dat_with_missing_outcome %>% 
  mutate(icu_7d = if_else(
    is.na(icu_7d), 'missing', icu_7d
  ))

dat <- dat[!dat$icu_7d %in% 'missing', ]

dat <- dat %>% 
  mutate(icu_7d = ifelse(icu_7d == 'yes', 1, 0))

dat$o2_supplement <- ifelse(dat$o2_supplement == 'ambient air', 0, 1)#1: with oxygen supplement

dat$impaired_consciousness <- ifelse(dat$impaired_consciousness == 'no', 0, 1)#no/0: unimpaired; 1: impaired

dat$obesity <- ifelse(dat$obesity == 'no', 0, 1)#1: yes

dat$num_comor <- rowSums(
  select(dat, obesity:comor_chronic_liver))

dat <- dat %>% 
  select(ptcenter, age, sex, o2_supplement, impaired_consciousness, obesity, comor_cvd, comor_chronic_lung, comor_ckd, comor_chronic_liver, comor_chronic_lung_no_asthma, num_comor, everything())

convert_to_factor <- function(data, variables) {
  for (var in variables) {
    data[[var]] <- as.factor(data[[var]])
  }
  return(data)
}

dat <- convert_to_factor(dat, c('icu_7d',
                                                  'sex', 
                                                  'o2_supplement', 
                                                  'impaired_consciousness',
                                                  'obesity',
                                                  'comor_cvd',
                                                  'comor_chronic_lung',
                                                  'comor_ckd',
                                                  'comor_chronic_liver',
                                                  'comor_chronic_lung_no_asthma'
                                                    )
                                   )

#split the data
north <- c('Hamburg', 'Berlin', 'Hannover', 'Dashti', 'Duisburg', 'Greifswald', 'Essen', 'Dortmund', 'Oldenburg', 'Flensburg', 'Bielefeld', 'Kiel', 'Magdeburg', 'Bochum', 'Düsseldorf', 'Göttingen', 'Münster', 'Aachen', 'Leipzig')

dat_north <- dat %>% 
  filter(str_detect(ptcenter, paste(north, collapse = "|")))

dat_south <- dat %>% 
  filter(!str_detect(ptcenter, paste(north, collapse = "|")))

der_dat <- dat_north #der_dat: data set for model derivation & internal validation (1295 pts)
val_dat <- dat_south #val_dat: data set for external validation (1123 pts)

#Derivation cohort
der_dat_full <- val_dat

der_dat_full <- der_dat_full %>% 
  select(
  #ptcenter,
  d_hsptl,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  #lympho_abs, 
  #neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
replace_outlier <- function(x, lower, upper) {
  x[x < lower | x > upper] <- NA
  return(x)
}

der_dat_full_plausible <- der_dat_full %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
preproc_params_full <- preProcess(der_dat_full_plausible, method = c("center", "scale"))
der_dat_full_plausible_scaled <- predict(preproc_params_full, newdata = der_dat_full_plausible)

#multiple imputation
set.seed(123)

#W/O scaling and centering
if(exists('der_dat_full_plausible_scaled')){
  dat_imp <- der_dat_full_plausible_scaled
} else {
  dat_imp <- der_dat_full_plausible
}

dat_imp_early <- dat_imp %>% 
  filter(d_hsptl <= '2021-06-30')

dat_imp_late <- dat_imp %>% 
  filter(d_hsptl > '2021-06-30')

der_dat_full_plausible_scaled_imputed <- mice(data = dat_imp_early, m = 10, maxit = 5, printFlag = FALSE)
summary(der_dat_full_plausible_scaled_imputed)

#Check-ups after MI
#xyplot(der_dat_full_plausible_scaled_imputed, icu_7d ~ rr + impaired_consciousness + o2_supplement)#inspecting the original and imputed data
#densityplot(der_dat_full_plausible_scaled_imputed)
#stripplot(der_dat_full_plausible_scaled_imputed, pch = 29, cex = 1.2)

#plot(der_dat_full_plausible_scaled_imputed)#check if convergence was achieved

completed_der_dat_full_plausible_scaled <- lapply(1:10, function(i) complete(der_dat_full_plausible_scaled_imputed, i))# Extract the completed datasets

mice::densityplot(der_dat_full_plausible_scaled_imputed)# Visualization of the distribution of the imputed variables

der_dat_full_plausible_scaled_stacked <- do.call(rbind, completed_der_dat_full_plausible_scaled) # Stack the 10 imputed datasets

der_dat_full_plausible_scaled_stacked <- der_dat_full_plausible_scaled_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

#winsorization of the data
winso <- function(x, xmin = quantile(x, probs = 0.01), xmax = quantile(x, probs = 0.99)) {#create a function to winsorize the extreme values in continuous variables
  if (!is.numeric(x)) { #it is a good practice to include error checking in functions to ensure that they are used correctly. The error checking here: ensure that the input is in the correct format.
    stop("Input must be numeric")
  }
  x[x > xmax] <- xmax
  x[x < xmin] <- xmin
  return(x)
}

winso_df <- function(data, cols) {#create a function to loop through all variable for winsorization
  if (!is.data.frame(data)) {
    stop("Input data must be a data frame")
  }
  for (col in cols) {
    if (!is.numeric(data[[col]])) {
      stop(paste(col, "must be numeric"))
    }
    data[[col]] <- winso(data[[col]])
  }
  return(data)
}

cols_to_transform <- setdiff(names(der_dat_full_plausible_scaled_stacked), c( 
                                                     'ptcenter',
                                                     'd_hsptl',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
der_dat_full_plausible_scaled_stacked_winso <- winso_df(der_dat_full_plausible_scaled_stacked, cols_to_transform)

der_dat_full_final <- der_dat_full_plausible_scaled_stacked_winso

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- der_dat_full_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > 0.01 ~ 2,
    rr <= 0.01 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 0.0056 ~ 0,
    spo2 <= 0.0056 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)
```

```{r sensitivity analyses_complete case data_temporal enrollment}
# Instructions for running this code:
#1. Run first the two sections:
    '#1. Loaded packages & customized functions'
    '#2. Create the derivation (der_dat) & validation (val_dat) cohorts'
#2. Rerun chunks 1-25 first
#3. Run the code below
    
#raw_data_creation_hap
dat_raw_hap <- dat_raw_hap %>% 
  select(#-d_adm_enrolled_hsptl,
         -d_icu,
         -d_v1,
         -duration_hsptl_v1,
         -duration_hsptl_icu,
         -d_vital_param,
         -duration_hsptl_blood_v1,
         -duration_hsptl_cc_v1,
         -duration_hsptl_gcs_v1)

dat_raw_hap <- dat_raw_hap %>% 
  rename(
    d_hsptl = d_adm_enrolled_hsptl,
    hr = hr_his,
    bp_sys = bp_sys_his,
    bp_dia = bp_dia_his,
    rr = rr_his,
    temp = temp_his,
    spo2 = spo2_his,
    o2_supplement = o2_supplement_his,
    consciousness = consciousness_his
  ) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, everything()
  )

dat_raw_hap$impaired_consciousness = ifelse(
  dat_raw_hap$consciousness == 'unimpaired', 'no', 'yes'
)

dat_raw_hap <- dat_raw_hap %>% 
  select(-c(consciousness, gcs))

dat_raw_hap <- dat_raw_hap %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

#raw_data_creation_suep
dat_raw_suep <- merge(dat_scv_suep, dat_fv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_bv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv1_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_ptcenter_suep, by = "psn", all = T)
dat_raw_suep <- merge(dat_raw_suep, dat_stv2_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fuv1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_1_suep, by = "psn", all.y = T)
dat_raw_suep <- merge(dat_raw_suep, dat_fv2_2_suep, by = "psn", all.y = T)
dat_raw_suep <- left_join(dat_raw_suep, dat_eward_suep, by = "psn")

dat_raw_suep <- dat_raw_suep %>% 
  select(-vis_label.x,
         -vis_label.y,
         -hsptl,
         -p_inclusion,
         -unit_albumin,
         -unit_crp,
         -unit_ferritin,
         -unit_pct,
         -unit_dimer,
         -unit_wbc_abs,
         -unit_lympho_abs,
         -unit_neutro_abs,
         -unit_platelet_abs,
         -unit_urea,
         -unit_creatinine,
         -unit_ldh,
         #-d_hsptl,
         -d_baseline,
         -height) %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, consciousness, gcs, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

dat_raw_suep$impaired_consciousness = ifelse(
  dat_raw_suep$gcs == 15, 'no', 'yes'
)

dat_raw_suep <- dat_raw_suep %>% 
  select(-c(consciousness, gcs))

dat_raw_suep <- dat_raw_suep %>% 
  select(psn, ptcenter, age, sex, icu_7d, hr, bp_sys, bp_dia, rr, temp, spo2, o2_supplement, impaired_consciousness, wbc_abs, lympho_abs, neutro_abs, platelet_abs, dimer, urea, creatinine, crp, pct, ferritin, albumin, ldh, everything())

dat_raw_suep$d_hsptl <- as.Date(as.character(dat_raw_suep$d_hsptl), format = "%Y%m%d")

#merge HAP and SUEP
dat_raw_hap <- subset(dat_raw_hap, select = -c(comor_dm, comor_chronic_neuro, comor_dementia, comor_tumor_or_cancer, comor_rheuma_immuno, comor_hiv_aids))

dat_with_missing_outcome <- rbind(dat_raw_hap, dat_raw_suep)

dat <- dat_with_missing_outcome %>% 
  mutate(icu_7d = if_else(
    is.na(icu_7d), 'missing', icu_7d
  ))

dat <- dat[!dat$icu_7d %in% 'missing', ]

dat <- dat %>% 
  mutate(icu_7d = ifelse(icu_7d == 'yes', 1, 0))

dat$o2_supplement <- ifelse(dat$o2_supplement == 'ambient air', 0, 1)#1: with oxygen supplement

dat$impaired_consciousness <- ifelse(dat$impaired_consciousness == 'no', 0, 1)#no/0: unimpaired; 1: impaired

dat$obesity <- ifelse(dat$obesity == 'no', 0, 1)#1: yes

dat$num_comor <- rowSums(
  select(dat, obesity:comor_chronic_liver))

dat <- dat %>% 
  select(ptcenter, age, sex, o2_supplement, impaired_consciousness, obesity, comor_cvd, comor_chronic_lung, comor_ckd, comor_chronic_liver, comor_chronic_lung_no_asthma, num_comor, everything())

convert_to_factor <- function(data, variables) {
  for (var in variables) {
    data[[var]] <- as.factor(data[[var]])
  }
  return(data)
}

dat <- convert_to_factor(dat, c('icu_7d',
                                                  'sex', 
                                                  'o2_supplement', 
                                                  'impaired_consciousness',
                                                  'obesity',
                                                  'comor_cvd',
                                                  'comor_chronic_lung',
                                                  'comor_ckd',
                                                  'comor_chronic_liver',
                                                  'comor_chronic_lung_no_asthma'
                                                    )
                                   )

#split the data
north <- c('Hamburg', 'Berlin', 'Hannover', 'Dashti', 'Duisburg', 'Greifswald', 'Essen', 'Dortmund', 'Oldenburg', 'Flensburg', 'Bielefeld', 'Kiel', 'Magdeburg', 'Bochum', 'Düsseldorf', 'Göttingen', 'Münster', 'Aachen', 'Leipzig')

dat_north <- dat %>% 
  filter(str_detect(ptcenter, paste(north, collapse = "|")))

dat_south <- dat %>% 
  filter(!str_detect(ptcenter, paste(north, collapse = "|")))

der_dat <- dat_north #der_dat: data set for model derivation & internal validation (1295 pts)
val_dat <- dat_south #val_dat: data set for external validation (1123 pts)

#Derivation cohort
der_dat_full <- val_dat

der_dat_full <- der_dat_full %>% 
  select(
  #ptcenter,
  d_hsptl,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  #lympho_abs, 
  #neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
replace_outlier <- function(x, lower, upper) {
  x[x < lower | x > upper] <- NA
  return(x)
}

der_dat_full_plausible <- der_dat_full %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
preproc_params_full <- preProcess(der_dat_full_plausible, method = c("center", "scale"))
der_dat_full_plausible_scaled <- predict(preproc_params_full, newdata = der_dat_full_plausible)

#multiple imputation
set.seed(123)

#W/O scaling and centering
if(exists('der_dat_full_plausible_scaled')){
  dat_imp <- der_dat_full_plausible_scaled
} else {
  dat_imp <- der_dat_full_plausible
}

dat_imp <- dat_imp %>% 
  select(icu_7d, rr, impaired_consciousness, spo2, o2_supplement, d_hsptl)

dat_imp_complete <- dat_imp[complete.cases(dat_imp), ]

dat_imp_early <- dat_imp_complete %>% 
  filter(d_hsptl <= '2021-06-30')

dat_imp_late <- dat_imp_complete %>% 
  filter(d_hsptl > '2021-06-30')

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- dat_imp_late %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > 0.01 ~ 2,
    rr <= 0.01 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 0.0056 ~ 0,
    spo2 <= 0.0056 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)
```

```{r sensitivity analysis_complete cases_AUC, fig.width=6, fig.height=6}
#AUROC in derivation complete
der_dat_complete <- der_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

der_dat_complete <-  der_dat_complete[complete.cases(der_dat_complete), ]

#CROSS score
der_dat_complete_cross_score <- der_dat_complete %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_complete_cross_score <- der_dat_complete_cross_score %>%
  mutate(der_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

der_complete_mod_cross_score <- glm(icu_7d ~ der_complete_score_cross_score, data = der_dat_complete_cross_score, family = binomial)
der_complete_pred_cross_score <- predict(der_complete_mod_cross_score, type = "response")
der_complete_roc_cross_score <- roc(der_dat_complete_cross_score$icu_7d, der_complete_pred_cross_score)

#Simplified cross model (continuous variables were dichotomized)
coef_o2_supplement <- 0.9604146
coef_impaired_consciousness <- 1.5691841
coef_rr <- 0.6687391
coef_spo2 <- 0.4777998
intercept <- -1.8937371

#convert factors to continuous variables
der_dat_simplified_cross_model <- data.frame(
  icu_7d = der_dat_complete$icu_7d,
  o2_supplement = der_dat_complete$o2_supplement,
  impaired_consciousness = der_dat_complete$impaired_consciousness,
  rr = ifelse(der_dat_complete$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(der_dat_complete$spo2 <= corresponding_spo2_value, 1, 0)
)

der_dat_simplified_cross_model$o2_supplement <- as.numeric(as.character(der_dat_simplified_cross_model$o2_supplement))
der_dat_simplified_cross_model$impaired_consciousness <- as.numeric(as.character(der_dat_simplified_cross_model$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * der_dat_simplified_cross_model$o2_supplement +
                         coef_impaired_consciousness * der_dat_simplified_cross_model$impaired_consciousness +
                         #coef_num_comor * der_dat_simplified_cross_model$num_comor +  
                         #coef_age * der_dat_simplified_cross_model$age +
                         coef_rr * der_dat_simplified_cross_model$rr +
                         #coef_bp_sys * der_dat_simplified_cross_model$bp_sys + 
                         #coef_bp_dia * der_dat_simplified_cross_model$bp_dia +
                         #coef_temp * der_dat_simplified_cross_model$temp +  
                         coef_spo2 * der_dat_simplified_cross_model$spo2 +
                         #coef_wbc_abs * der_dat_simplified_cross_model$wbc_abs +
                         #coef_platelet_abs * der_dat_simplified_cross_model$platelet_abs + 
                         #coef_urea * der_dat_simplified_cross_model$urea +
                         #coef_creatinine * der_dat_simplified_cross_model$creatinine +  
                         #coef_crp * der_dat_simplified_cross_model$crp +
                         #coef_ldh * der_dat_simplified_cross_model$ldh +
                         intercept
                         )

observed_outcome <- der_dat_simplified_cross_model$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

roc_der_simplifed_clinical_model <- roc(observed_outcome, predicted_prob, smooth = T)# clinical model: continuous variables remain continuous in the model; clinical model2: continuous variables were categorized.












# CROSS model
continuous_vars <- c(
               'rr',
               'spo2'
               )

rcs_terms_val <- lapply(continuous_vars, function(var) rcs(der_dat_complete[[var]], 4))

# Combine the RCS terms into the design matrix
rcs_matrix_val <- cbind(
  der_dat_complete[c('icu_7d', 
                  'o2_supplement',
                  'impaired_consciousness'
               )],  
                  do.call(cbind, rcs_terms_val)
)

column_names <- c(
                  'icu_7d', 
                  'o2_supplement', 
                  'impaired_consciousness',
                  sapply(continuous_vars, function(var) paste(var, c("k1", "k2", "k3"), sep = "_"))
                  )

colnames(rcs_matrix_val) <- column_names

# Create a design matrix with factors preserved
rcs_matrix_val_predictors <- rcs_matrix_val[, -1]# Exclude the response variable
design_matrix_val <- model.matrix(~ . - 1, data = rcs_matrix_val_predictors) #-1: remove the intercept
design_matrix_val <- design_matrix_val[, -1] #remove 'icu_7d0'



pred_abc <- predict(fit_optimal_der, design_matrix_val, type = "response")
obs_abc <- rcs_matrix_val$icu_7d
roc_abc <- roc(obs_abc, pred_abc, smooth = T)




o2_supplement <- data.frame(rcs_matrix_val$o2_supplement)
impaired_consciousness <- data.frame(rcs_matrix_val$impaired_consciousness)
rr_k1 <- data.frame(rcs_matrix_val$rr_k1)
rr_k2 <- data.frame(rcs_matrix_val$rr_k2)
rr_k3 <- data.frame(rcs_matrix_val$rr_k3)
spo2_k1 <- data.frame(rcs_matrix_val$spo2_k1)
spo2_k2 <- data.frame(rcs_matrix_val$spo2_k2)
spo2_k3 <- data.frame(rcs_matrix_val$spo2_k3)

## Define the custom coefficients
coef_o2_supplement <- 0.9664
coef_impaired_consciousness <- 1.7249
coef_rr_k1 <- 0.2476
coef_rr_k2 <- 0.1798
coef_rr_k3 <- 0.3252
coef_spo2_k1 <- -0.3248
coef_spo2_k2 <- -0.1132
coef_spo2_k3 <- -0.6649
intercept <- -1.4974

rcs_matrix_val$o2_supplement <- as.numeric(as.character(rcs_matrix_val$o2_supplement))
rcs_matrix_val$impaired_consciousness <- as.numeric(as.character(rcs_matrix_val$impaired_consciousness))
rcs_matrix_val$icu_7d <- as.numeric(as.character(rcs_matrix_val$icu_7d))

## Calculate the linear predictor manually
linear_predictor <- intercept + 
  o2_supplement * coef_o2_supplement + 
  impaired_consciousness * coef_impaired_consciousness +
  rr_k1 * coef_rr_k1 + 
  rr_k2 * coef_rr_k2 + 
  rr_k3 * coef_rr_k3 + 
  spo2_k1 * coef_spo2_k1 +
  spo2_k2 * coef_spo2_k2 +
  spo2_k3 * coef_spo2_k3 

## Calculate the predicted probabilities using the logistic function
predicted_probs_cross_model <- 1 / (1 + exp(-linear_predictor))

test <- data.frame(predicted_probs = predicted_probs_cross_model, icu_7d = rcs_matrix_val$icu_7d)
test$icu_7d <- as.numeric(as.character(test$icu_7d))

roc_val_simplifed_clinical_model <- roc(test$icu_7d, test$predicted_probs, smooth = T)

















#AUROC in validation complete
val_dat_complete <- val_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

val_dat_complete <- val_dat_complete[complete.cases(val_dat_complete), ]




#CROSS SCORE
val_dat_complete_cross_score <- val_dat_complete %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_complete_cross_score <- val_dat_complete_cross_score %>%
  mutate(val_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_complete_mod_cross_score <- glm(icu_7d ~ val_complete_score_cross_score, data = val_dat_complete_cross_score, family = binomial)# Fit a logistic regression model
val_complete_pred_cross_score <- predict(val_complete_mod_cross_score, type = "response")# Predict probabilities for the same data
val_complete_roc_cross_score <- roc(val_dat_complete_cross_score$icu_7d, val_complete_pred_cross_score)

#Simplified cross model (continuous variables were dichotomized)
coef_o2_supplement <- 0.9604146
coef_impaired_consciousness <- 1.5691841
coef_rr <- 0.6687391
coef_spo2 <- 0.4777998
intercept <- -1.8937371

#convert factors to continuous variables
val_dat_simplified_cross_model <- data.frame(
  icu_7d = val_dat_complete$icu_7d,
  o2_supplement = val_dat_complete$o2_supplement,
  impaired_consciousness = val_dat_complete$impaired_consciousness,
  rr = ifelse(val_dat_complete$rr > corresponding_rr_value, 1, 0),
  spo2 = ifelse(val_dat_complete$spo2 <= corresponding_spo2_value, 1, 0)
)

val_dat_simplified_cross_model$o2_supplement <- as.numeric(as.character(val_dat_simplified_cross_model$o2_supplement))
val_dat_simplified_cross_model$impaired_consciousness <- as.numeric(as.character(val_dat_simplified_cross_model$impaired_consciousness))

predicted_prob <- plogis(coef_o2_supplement * val_dat_simplified_cross_model$o2_supplement +
                         coef_impaired_consciousness * val_dat_simplified_cross_model$impaired_consciousness +
                         #coef_num_comor * val_dat_simplified_cross_model$num_comor +  
                         #coef_age * val_dat_simplified_cross_model$age +
                         coef_rr * val_dat_simplified_cross_model$rr +
                         #coef_bp_sys * val_dat_simplified_cross_model$bp_sys + 
                         #coef_bp_dia * val_dat_simplified_cross_model$bp_dia +
                         #coef_temp * val_dat_simplified_cross_model$temp +  
                         coef_spo2 * val_dat_simplified_cross_model$spo2 +
                         #coef_wbc_abs * val_dat_simplified_cross_model$wbc_abs +
                         #coef_platelet_abs * val_dat_simplified_cross_model$platelet_abs + 
                         #coef_urea * val_dat_simplified_cross_model$urea +
                         #coef_creatinine * val_dat_simplified_cross_model$creatinine +  
                         #coef_crp * val_dat_simplified_cross_model$crp +
                         #coef_ldh * val_dat_simplified_cross_model$ldh +
                         intercept
                         )

observed_outcome <- val_dat_simplified_cross_model$icu_7d# Obtain the observed outcomes (ICU admission within 7 days) from the new dataset.

roc_val_simplifed_clinical_model <- roc(observed_outcome, predicted_prob, smooth = T)# clinical model: continuous variables remain continuous in the model; clinical model2: continuous variables were categorized.


```

```{r sensitivity analysis_complete cases_sex_AUC}
#AUROC in derivation complete
der_dat_complete <- der_dat %>% 
        select(icu_7d,
               sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

der_dat_complete <-  der_dat_complete[complete.cases(der_dat_complete), ]

#CROSS score
der_dat_complete_female <- der_dat_complete %>% 
  filter(sex == 'female')

der_dat_complete_cross_score <- der_dat_complete_female %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_complete_cross_score <- der_dat_complete_cross_score %>%
  mutate(der_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

der_complete_mod_cross_score <- glm(icu_7d ~ der_complete_score_cross_score, data = der_dat_complete_cross_score, family = binomial)
der_complete_pred_cross_score <- predict(der_complete_mod_cross_score, type = "response")
der_complete_roc_cross_score <- roc(der_dat_complete_cross_score$icu_7d, der_complete_pred_cross_score)

#AUROC in validation complete
val_dat_complete <- val_dat %>% 
        select(icu_7d,
               sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

val_dat_complete <- val_dat_complete[complete.cases(val_dat_complete), ]

#CROSS SCORE
val_dat_complete_female <- val_dat_complete %>% 
  filter(sex == 'female')

val_dat_complete_cross_score <- val_dat_complete_female %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_complete_cross_score <- val_dat_complete_cross_score %>%
  mutate(val_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_complete_mod_cross_score <- glm(icu_7d ~ val_complete_score_cross_score, data = val_dat_complete_cross_score, family = binomial)# Fit a logistic regression model
val_complete_pred_cross_score <- predict(val_complete_mod_cross_score, type = "response")# Predict probabilities for the same data
val_complete_roc_cross_score <- roc(val_dat_complete_cross_score$icu_7d, val_complete_pred_cross_score)
```

```{r sensitivity analysis_complete cases_description_score}
#AUROC in derivation complete
der_dat_complete <- der_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

der_dat_complete <-  der_dat_complete[complete.cases(der_dat_complete), ]

#CROSS score
der_dat_complete_cross_score <- der_dat_complete %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_complete_cross_score <- der_dat_complete_cross_score %>%
  mutate(der_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

der_complete_mod_cross_score <- glm(icu_7d ~ der_complete_score_cross_score, data = der_dat_complete_cross_score, family = binomial)
der_complete_pred_cross_score <- predict(der_complete_mod_cross_score, type = "response")
der_complete_roc_cross_score <- roc(der_dat_complete_cross_score$icu_7d, der_complete_pred_cross_score)

df_temp_cross_score <- data.frame(der_dat_complete_cross_score, der_complete_pred_cross_score)
df_temp_cross_score %>% group_by(der_complete_pred_cross_score, icu_7d) %>% summarise(num_patients = sum(icu_7d == 1))

ggplot(der_dat_complete_cross_score, aes(x = factor(der_dat_complete_cross_score$der_complete_score_cross_score))) +
  geom_bar(fill = "grey") +
  labs(title = "Risk Score3",
       x = "Score value",
       y = "Patient count") +
  ylim(0, 175) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "8", "9", "10", "11")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(der_dat_complete_cross_score, aes(x = factor(der_complete_score_cross_score), y = der_complete_pred_cross_score)) +
  geom_bar(stat = "sum", fill = "grey") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score3",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "8", "9", "10", "11")) +
  theme_wx

#AUROC in validation complete
val_dat_complete <- val_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

val_dat_complete <- val_dat_complete[complete.cases(val_dat_complete), ]

#CROSS SCORE
val_dat_complete_cross_score <- val_dat_complete %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > 20 ~ 2,
    rr <= 20 ~ 0
    ),
    score_spo2 = case_when(
    spo2 > 95 ~ 0,
    spo2 <= 95 ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_complete_cross_score <- val_dat_complete_cross_score %>%
  mutate(val_complete_score_cross_score = rowSums(select(., score_rr:score_consciousness))) 

val_complete_mod_cross_score <- glm(icu_7d ~ val_complete_score_cross_score, data = val_dat_complete_cross_score, family = binomial)# Fit a logistic regression model
val_complete_pred_cross_score <- predict(val_complete_mod_cross_score, type = "response")# Predict probabilities for the same data
val_complete_roc_cross_score <- roc(val_dat_complete_cross_score$icu_7d, val_complete_pred_cross_score)

df_temp_cross_score <- data.frame(val_dat_complete_cross_score, val_complete_pred_cross_score)
df_temp_cross_score %>% group_by(val_complete_pred_cross_score, icu_7d) %>% summarise(num_patients = sum(icu_7d == 1))

ggplot(val_dat_complete_cross_score, aes(x = factor(val_dat_complete_cross_score$val_complete_score_cross_score))) +
  geom_bar(fill = "grey") +
  labs(title = "Risk Score3",
       x = "Score value",
       y = "Patient count") +
  ylim(0, 175) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11")) +
  theme_wx

#weighted bar plot of score value vs. risk of 7d_icu
ggplot(val_dat_complete_cross_score, aes(x = factor(val_complete_score_cross_score), y = val_complete_pred_cross_score)) +
  geom_bar(stat = "sum", fill = "grey") +  # Use stat = "sum" to show the sum of weighted predicted risks
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "black", size = 1) +  # Add a line through the mean values
    labs(title = "Risk Score3",
       x = "Score value",
       y = "predicted risk") +
  ylim(0, 1) +
  scale_x_discrete(labels = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11")) +
  theme_wx
```

```{r sensitivity analysis_AUC_sex, fig.width=6, fig.height=6}
#AUROC in male derivation
der_dat_final_full_model_with_labs_male <- der_dat_final_full_model_with_labs %>% 
  filter(sex == 1)

der_dat_final_full_model_with_labs_male <- der_dat_final_full_model_with_labs_male %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_final_full_model_with_labs_male <- der_dat_final_full_model_with_labs_male %>%
  mutate(der_dat_final_full_model_with_labs_male_score = rowSums(select(., score_rr:score_consciousness))) 

der_dat_final_full_model_with_labs_male_mod <- glm(icu_7d ~ der_dat_final_full_model_with_labs_male_score, data = der_dat_final_full_model_with_labs_male, family = binomial)# Fit a logistic regression model
der_dat_final_full_model_with_labs_male_pred <- predict(der_dat_final_full_model_with_labs_male_mod, type = "response")# Predict probabilities for the same data
der_dat_final_full_model_with_labs_male_roc <- roc(der_dat_final_full_model_with_labs_male$icu_7d, der_dat_final_full_model_with_labs_male_pred)

#AUROC in female derivation
der_dat_final_full_model_with_labs_female <- der_dat_final_full_model_with_labs %>% 
  filter(sex == 0)

der_dat_final_full_model_with_labs_female <- der_dat_final_full_model_with_labs_female %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

der_dat_final_full_model_with_labs_female <- der_dat_final_full_model_with_labs_female %>%
  mutate(der_dat_final_full_model_with_labs_female_score = rowSums(select(., score_rr:score_consciousness))) 

der_dat_final_full_model_with_labs_female_mod <- glm(icu_7d ~ der_dat_final_full_model_with_labs_female_score, data = der_dat_final_full_model_with_labs_female, family = binomial)# Fit a logistic regression model
der_dat_final_full_model_with_labs_female_pred <- predict(der_dat_final_full_model_with_labs_female_mod, type = "response")# Predict probabilities for the same data
der_dat_final_full_model_with_labs_female_roc <- roc(der_dat_final_full_model_with_labs_female$icu_7d, der_dat_final_full_model_with_labs_female_pred)

# Create the validation data
variables_full_model_with_labs <- c('icu_7d',
               'sex', 
               'o2_supplement',
               'impaired_consciousness',
               #'obesity',
               #'comor_cvd',
               #'comor_chronic_lung',
               #'comor_ckd',
               #'comor_chronic_liver',
               #'comor_chronic_lung_no_asthma',
               'num_comor',
               'age', 
               'hr', 
               'rr',
               'bp_sys', 
               'bp_dia',
               'temp', 
               'spo2',
               'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               'platelet_abs',
               'urea',
               'creatinine',
               'crp',
               'ldh'
               )

val_dat_final_full_model_with_labs <- val_dat_plausible_scaled_stacked_winso[variables_full_model_with_labs]

#AUROC in male validation
val_dat_final_full_model_with_labs_male <- val_dat_final_full_model_with_labs %>% 
  filter(sex == 'male')

val_dat_final_full_model_with_labs_male <- val_dat_final_full_model_with_labs_male %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_final_full_model_with_labs_male <- val_dat_final_full_model_with_labs_male %>%
  mutate(val_dat_final_full_model_with_labs_male_score = rowSums(select(., score_rr:score_consciousness))) 

val_dat_final_full_model_with_labs_male_mod <- glm(icu_7d ~ val_dat_final_full_model_with_labs_male_score, data = val_dat_final_full_model_with_labs_male, family = binomial)# Fit a logistic regression model
val_dat_final_full_model_with_labs_male_pred <- predict(val_dat_final_full_model_with_labs_male_mod, type = "response")# Predict probabilities for the same data
val_dat_final_full_model_with_labs_male_roc <- roc(val_dat_final_full_model_with_labs_male$icu_7d, val_dat_final_full_model_with_labs_male_pred)

#AUROC in female validation
val_dat_final_full_model_with_labs_female <- val_dat_final_full_model_with_labs %>% 
  filter(sex == 'female')

val_dat_final_full_model_with_labs_female <- val_dat_final_full_model_with_labs_female %>% #computation of 4C score for each patient
  mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_final_full_model_with_labs_female <- val_dat_final_full_model_with_labs_female %>%
  mutate(val_dat_final_full_model_with_labs_female_score = rowSums(select(., score_rr:score_consciousness))) 

val_dat_final_full_model_with_labs_female_mod <- glm(icu_7d ~ val_dat_final_full_model_with_labs_female_score, data = val_dat_final_full_model_with_labs_female, family = binomial)# Fit a logistic regression model
val_dat_final_full_model_with_labs_female_pred <- predict(val_dat_final_full_model_with_labs_female_mod, type = "response")# Predict probabilities for the same data
val_dat_final_full_model_with_labs_female_roc <- roc(val_dat_final_full_model_with_labs_female$icu_7d, val_dat_final_full_model_with_labs_female_pred)
```

```{r sensitivity analysis_AUC_south_southwest, fig.width=6, fig.height=6}
val_dat_s_sw <- dat_south %>% 
  select(
  ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  obesity,
  comor_cvd,
  comor_chronic_lung,
  comor_ckd,
  comor_chronic_liver,
  #comor_chronic_lung_no_asthma,
  num_comor,
  age,
  hr,
  rr,
  bp_sys, 
  bp_dia,
  temp,
  spo2,
  wbc_abs,
  #lympho_abs, 
  #neutro_abs, 
  platelet_abs,
  urea,
  creatinine, 
  crp,
  ldh
  )

#plausibility
replace_outlier <- function(x, lower, upper) {
  x[x < lower | x > upper] <- NA
  return(x)
}

val_dat_s_sw_plausible <- val_dat_s_sw %>%
  mutate(
    hr = replace_outlier(hr, 40, 150),
    rr = replace_outlier(rr, 6, 60),
    bp_sys = replace_outlier(bp_sys, 50, 250),
    bp_dia = replace_outlier(bp_dia, 10, 200),
    temp = replace_outlier(temp, 33, 42),
    spo2 = replace_outlier(spo2, 50, 100),
    wbc_abs = replace_outlier(wbc_abs, 0.1, 50),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #lympho_abs = replace_outlier(lympho_abs, 0.05, 20),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    #neutro_abs = replace_outlier(neutro_abs, 0.1, 30),# [1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    platelet_abs = replace_outlier(platelet_abs, 1, 600),#[1/nl] o. [Gpt/l] o. [10E9/l] o. [10E3/µl]
    urea = replace_outlier(urea, 5, 300),#[mg/dl]
    creatinine = replace_outlier(creatinine, 0.1, 10),#[mg/dl]
    crp = replace_outlier(crp, 0, 300),#[mg/l] o. [µg/ml]
    ldh = replace_outlier(ldh, 10, 3000)#[U/l]
  )

#scaling & centering
preproc_params <- preProcess(der_dat_plausible, method = c("center", "scale"))
val_dat_s_sw_plausible_scaled <- predict(preproc_params, newdata = val_dat_s_sw_plausible)
dat_imp <- val_dat_s_sw_plausible_scaled

#multiple imputation
set.seed(123)

val_dat_s_sw_plausible_scaled_imputed <- mice(data = dat_imp, m = 10, maxit = 10, printFlag = FALSE)
#summary(val_dat_s_sw_plausible_scaled_imputed)

#Check-ups after MI
#xyplot(val_dat_full_plausible_imputed, icu_7d ~ rr + impaired_consciousness + o2_supplement)#inspecting the original and imputed data
#densityplot(val_dat_full_plausible_imputed)
#stripplot(val_dat_full_plausible_imputed, pch = 29, cex = 1.2)

#plot(val_dat_full_plausible_imputed)#check if convergence was achieved

completed_val_dat_s_sw_plausible_scaled <- lapply(1:10, function(i) complete(val_dat_s_sw_plausible_scaled_imputed, i))# Extract the completed datasets

mice::densityplot(val_dat_s_sw_plausible_scaled_imputed)# Visualization of the distribution of the imputed variables

val_dat_s_sw_plausible_scaled_stacked <- bind_rows(completed_val_dat_s_sw_plausible_scaled)

#val_dat_s_sw_plausible_scaled_stacked <- do.call(rbind, completed_val_dat_full_plausible) # Stack the 10 imputed datasets

val_dat_s_sw_plausible_scaled_stacked <- val_dat_s_sw_plausible_scaled_stacked %>% # Assign weights to each observation
  mutate(weight = 0.1)

#winsorization of the data
winso <- function(x, xmin = quantile(x, probs = 0.01), xmax = quantile(x, probs = 0.99)) {#create a function to winsorize the extreme values in continuous variables
  if (!is.numeric(x)) { #it is a good practice to include error checking in functions to ensure that they are used correctly. The error checking here: ensure that the input is in the correct format.
    stop("Input must be numeric")
  }
  x[x > xmax] <- xmax
  x[x < xmin] <- xmin
  return(x)
}

winso_df <- function(data, cols) {#create a function to loop through all variable for winsorization
  if (!is.data.frame(data)) {
    stop("Input data must be a data frame")
  }
  for (col in cols) {
    if (!is.numeric(data[[col]])) {
      stop(paste(col, "must be numeric"))
    }
    data[[col]] <- winso(data[[col]])
  }
  return(data)
}

cols_to_transform <- setdiff(names(val_dat_s_sw_plausible_scaled_stacked), c( 
                                                     'ptcenter',
                                                     'icu_7d',
                                                     'sex', 
                                                     'o2_supplement', 
                                                     'impaired_consciousness',
                                                     'obesity',
                                                     'comor_cvd',
                                                     'comor_chronic_lung',
                                                     'comor_ckd',
                                                     'comor_chronic_liver',
                                                     'comor_chronic_lung_no_asthma'
                                                   )
                             )
val_dat_s_sw_plausible_scaled_stacked_winso <- winso_df(val_dat_s_sw_plausible_scaled_stacked, cols_to_transform)

val_dat_s_sw_final <- val_dat_s_sw_plausible_scaled_stacked_winso

#South
val_dat_s_final <- val_dat_s_sw_final %>%
  filter(ptcenter %in% c(
    'COVID-19 Register des LMU Klinikums (CORKUM)',
    'Klinikum der Universität München',
    'MVZ am Isartor',
    'TUM München',
    'Uniklinik Erlangen',
    'Universitätsklinikum Augsburg',
    'Jena',
    'Uniklinik Regensburg'
  ))

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- val_dat_s_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)

#Southwest
val_dat_sw_final <- val_dat_s_sw_final %>% 
  filter(ptcenter %in% c(
    'Helios Klinikum Siegburg',
    'Thoraxklinik Heidelberg',
    'Uniklinik Köln',
    'Uniklinik Tübingen',
    'Universitätsklinikum Frankfurt',
    'Universitätsklinikum Giessen / Marburg',
    'Universitätsmedizin Mannheim',
    'Frankfurt Universitätsklinikum',
    'Klinikum Worms',
    'Praxis im Tennental',
    'Tropenklinik Paul-Lechler-Krankenhaus',
    'Uniklinik Carl Gustav Carus Dresden',
    'Uniklinik Homburg',
    'Universitätsklinikum Bonn',
    'Universitätsklinikum Freiburg',
    'Uniklinik Würzburg',
    'Universitätsmedizin der Johannes Gutenberg-Universität Mainz',
    'Universtitästklinikum Heidelberg'
  ))

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- val_dat_sw_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)
```

```{r sensitivity analysis_complete_case_data_AUC_south_southwest}
val_dat_s_sw <- dat_south %>% 
  select(
  ptcenter,
  icu_7d,
  sex,
  o2_supplement,
  impaired_consciousness,
  #obesity,
  #comor_cvd,
  #comor_chronic_lung,
  #comor_ckd,
  #comor_chronic_liver,
  #comor_chronic_lung_no_asthma,
  #num_comor,
  #age,
  #hr,
  rr,
  #bp_sys, 
  #bp_dia,
  #temp,
  spo2
  #wbc_abs,
  #lympho_abs, 
  #neutro_abs, 
  #platelet_abs,
  #urea,
  #creatinine, 
  #crp,
  #ldh
  )

val_dat_s_sw_complete <-  val_dat_s_sw[complete.cases(val_dat_s_sw), ]

#South
val_dat_s_final <- val_dat_s_sw_complete %>%
  filter(ptcenter %in% c(
    'COVID-19 Register des LMU Klinikums (CORKUM)',
    'Klinikum der Universität München',
    'MVZ am Isartor',
    'TUM München',
    'Uniklinik Erlangen',
    'Universitätsklinikum Augsburg',
    'Jena',
    'Uniklinik Regensburg'
  ))

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- val_dat_s_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)

#Southwest
val_dat_sw_final <- val_dat_s_sw_complete %>% 
  filter(ptcenter %in% c(
    'Helios Klinikum Siegburg',
    'Thoraxklinik Heidelberg',
    'Uniklinik Köln',
    'Uniklinik Tübingen',
    'Universitätsklinikum Frankfurt',
    'Universitätsklinikum Giessen / Marburg',
    'Universitätsmedizin Mannheim',
    'Frankfurt Universitätsklinikum',
    'Klinikum Worms',
    'Praxis im Tennental',
    'Tropenklinik Paul-Lechler-Krankenhaus',
    'Uniklinik Carl Gustav Carus Dresden',
    'Uniklinik Homburg',
    'Universitätsklinikum Bonn',
    'Universitätsklinikum Freiburg',
    'Uniklinik Würzburg',
    'Universitätsmedizin der Johannes Gutenberg-Universität Mainz',
    'Universtitästklinikum Heidelberg'
  ))

# Predictions and ROC curve for clinical risk score3
val_dat_risk_score3 <- val_dat_sw_final %>% #create the data frame
  select(rr, 
         spo2,
         o2_supplement,
         impaired_consciousness,
         icu_7d)

val_dat_risk_score3 <- val_dat_risk_score3 %>% #computation of 4C score for each patient
 mutate(score_rr = case_when(
    rr > corresponding_rr_value ~ 2,
    rr <= corresponding_rr_value ~ 0
    ),
    score_spo2 = case_when(
    spo2 > corresponding_spo2_value ~ 0,
    spo2 <= corresponding_spo2_value ~ 1
  ),
    score_o2_supplement = case_when(
    o2_supplement == 0 ~ 0,
    o2_supplement == 1 ~ 3
  ),
    score_consciousness = case_when(
    impaired_consciousness == 0 ~ 0,
    impaired_consciousness == 1 ~ 5
  )
  )

val_dat_risk_score3 <- val_dat_risk_score3 %>%
  mutate(val_score_risk_score3 = rowSums(select(., score_rr:score_consciousness))) 

val_mod_risk_score3 <- glm(icu_7d ~ val_score_risk_score3, data = val_dat_risk_score3, family = binomial)# Fit a logistic regression model
val_pred_risk_score3 <- predict(val_mod_risk_score3, type = "response")# Predict probabilities for the same data
val_roc_risk_score3 <- roc(val_dat_risk_score3$icu_7d, val_pred_risk_score3)
```

```{r sensitivity analysis_auc_cross_model_in_complete_cases}
#AUROC in derivation complete
der_dat_complete <- der_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

der_dat_complete <-  der_dat_complete[complete.cases(der_dat_complete), ]

continuous_vars <- c(
               #'num_comor',
               #'age', 
               #'hr', 
               'rr',
               #'bp_sys' ,
               #'bp_dia' ,
               #'temp', 
               'spo2'
               #'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               #'platelet_abs',
               #'urea',
               #'creatinine',
               #'crp',
               #'ldh'
               )

rcs_terms_val <- lapply(continuous_vars, function(var) rcs(der_dat_complete[[var]], 4))

# Combine the RCS terms into the design matrix
rcs_matrix_val <- cbind(
  der_dat_complete[c('icu_7d', # Include categorical variables
                  #'sex', 
                  'o2_supplement',
                  'impaired_consciousness'
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma'
                  #'num_comor'
               )],  
                  do.call(cbind, rcs_terms_val)
)

column_names <- c(
                  'icu_7d', # Rename the columns of the resulting data frame
                  #'sex', 
                  'o2_supplement', 
                  'impaired_consciousness',
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma',
                  #'num_comor',
                  sapply(continuous_vars, function(var) paste(var, c("k1", "k2", "k3"), sep = "_"))
                  )

colnames(rcs_matrix_val) <- column_names

# Create a design matrix with factors preserved
rcs_matrix_val_predictors <- rcs_matrix_val[, -1]# Exclude the response variable
design_matrix_val <- model.matrix(~ . - 1, data = rcs_matrix_val_predictors) #-1: remove the intercept
design_matrix_val <- design_matrix_val[, -1] #remove 'icu_7d0'

pred_abc <- predict(fit_optimal_der, design_matrix_val, type = "response")
obs_abc <- rcs_matrix_val$icu_7d
roc_abc <- roc(obs_abc, pred_abc, smooth = T)

#AUROC in validation complete
val_dat_complete <- val_dat %>% 
        select(icu_7d,
               #sex, 
               o2_supplement,
               impaired_consciousness,
               #obesity,
               #comor_cvd,
               #comor_chronic_lung,
               #comor_ckd,
               #comor_chronic_liver,
               #comor_chronic_lung_no_asthma,
               #num_comor,
               #age, 
               #hr, 
               rr,
               #bp_sys, 
               #bp_dia,
               #temp, 
               spo2
               #wbc_abs,
               #lympho_abs,
               #neutro_abs,
               #platelet_abs,
               #urea,
               #creatinine,
               #crp,
               #ldh
               )

val_dat_complete <- val_dat_complete[complete.cases(val_dat_complete), ]

continuous_vars <- c(
               #'num_comor',
               #'age', 
               #'hr', 
               'rr',
               #'bp_sys' ,
               #'bp_dia' ,
               #'temp', 
               'spo2'
               #'wbc_abs',
               #'lympho_abs',
               #'neutro_abs',
               #'platelet_abs',
               #'urea',
               #'creatinine',
               #'crp',
               #'ldh'
               )

rcs_terms_val <- lapply(continuous_vars, function(var) rcs(val_dat_complete[[var]], 4))

# Combine the RCS terms into the design matrix
rcs_matrix_val <- cbind(
  val_dat_complete[c('icu_7d', # Include categorical variables
                  #'sex', 
                  'o2_supplement',
                  'impaired_consciousness'
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma'
                  #'num_comor'
               )],  
                  do.call(cbind, rcs_terms_val)
)

column_names <- c(
                  'icu_7d', # Rename the columns of the resulting data frame
                  #'sex', 
                  'o2_supplement', 
                  'impaired_consciousness',
                  #'obesity',
                  #'comor_cvd',
                  #'comor_chronic_lung',
                  #'comor_ckd',
                  #'comor_chronic_liver',
                  #'comor_chronic_lung_no_asthma',
                  #'num_comor',
                  sapply(continuous_vars, function(var) paste(var, c("k1", "k2", "k3"), sep = "_"))
                  )

colnames(rcs_matrix_val) <- column_names

# Create a design matrix with factors preserved
rcs_matrix_val_predictors <- rcs_matrix_val[, -1]# Exclude the response variable
design_matrix_val <- model.matrix(~ . - 1, data = rcs_matrix_val_predictors) #-1: remove the intercept
design_matrix_val <- design_matrix_val[, -1] #remove 'icu_7d0'

pred_abc <- predict(fit_optimal_der, design_matrix_val, type = "response")
obs_abc <- rcs_matrix_val$icu_7d
roc_abc <- roc(obs_abc, pred_abc, smooth = T)
```
